if(typeof define!="function")var define=require("amdefine")(module);define("math/mathf",[],function(){var random=Math.random,floor=Math.floor,abs=Math.abs,atan2=Math.atan2;function Mathf(){this.PI=3.141592653589793,this.TWO_PI=this.PI*2,this.HALF_PI=this.PI/2,this.EPSILON=1e-6,this.TO_RADS=this.PI/180,this.TO_DEGS=180/this.PI}return Mathf.prototype.acos=Math.acos,Mathf.prototype.asin=Math.asin,Mathf.prototype.atan=Math.atan,Mathf.prototype.atan2=Math.atan2,Mathf.prototype.cos=Math.cos,Mathf.prototype.sin=Math.sin,Mathf.prototype.tan=Math.tan,Mathf.prototype.abs=Math.abs,Mathf.prototype.ceil=Math.ceil,Mathf.prototype.exp=Math.exp,Mathf.prototype.floor=Math.floor,Mathf.prototype.log=Math.log,Mathf.prototype.max=Math.max,Mathf.prototype.min=Math.min,Mathf.prototype.pow=Math.pow,Mathf.prototype.random=Math.random,Mathf.prototype.round=Math.round,Mathf.prototype.sqrt=Math.sqrt,Mathf.prototype.equals=function(a,b){return abs(a-b)<=this.EPSILON},Mathf.prototype.modulo=function(a,b){var r=a%b;return r*b<0?r+b:r},Mathf.prototype.standardRadian=function(t){return this.modulo(t,this.TWO_PI)},Mathf.prototype.standardAngle=function(t){return this.modulo(t,360)},Mathf.prototype.sign=function(t){return t<0?-1:1},Mathf.prototype.clamp=function(t,min,max){return t<min?min:t>max?max:t},Mathf.prototype.clamp01=function(t){return t<0?0:t>1?1:t},Mathf.prototype.lerp=function(a,b,t){return a+(b-a)*this.clamp01(t)},Mathf.prototype.lerpAngle=function(a,b,t){return this.standardRadian(a+(b-a)*this.clamp01(t))},Mathf.prototype.smoothStep=function(t,min,max){return t=(this.clamp01(t)-min)/(max-min),t*t*(3-2*t)},Mathf.prototype.smootherStep=function(t,min,max){return t=(this.clamp01(t)-min)/(max-min),t*t*t*(t*(t*6-15)+10)},Mathf.prototype.pingPong=function(t,length){return length||(length=1),length-abs(t%(2*length)-length)},Mathf.prototype.toRadians=function(x){return this.standardRadian(x*this.TO_RADS)},Mathf.prototype.toDegrees=function(x){return this.standardAngle(x*this.TO_DEGS)},Mathf.prototype.randomRange=function(min,max){return min+random()*(max-min)},Mathf.prototype.randomChoice=function(array){return array[floor(random()*array.length)]},Mathf.prototype.isPowerOfTwo=function(x){return(x&-x)===x},Mathf.prototype.nextPowerOfTwo=function(x){var i=2;while(i<x)i*=2;return i},Mathf.prototype.direction=function(x,y){return abs(x)>=abs(y)?x>0?"right":"left":y>0?"up":"down"},new Mathf});if(typeof define!="function")var define=require("amdefine")(module);define("math/vec2",["math/mathf"],function(Mathf){var abs=Math.abs,sqrt=Math.sqrt,acos=Math.acos,sin=Math.sin,cos=Math.cos,lerp=Mathf.lerp,clamp=Mathf.clamp,equals=Mathf.equals;function Vec2(x,y){this.x=x||0,this.y=y||0}return Vec2.prototype.clone=function(){return new Vec2(this.x,this.y)},Vec2.prototype.copy=function(other){return this.x=other.x,this.y=other.y,this},Vec2.prototype.set=function(x,y){return this.x=x,this.y=y,this},Vec2.prototype.vadd=function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this},Vec2.prototype.add=function(other){return this.vadd(this,other)},Vec2.prototype.sadd=function(s){return this.x+=s,this.y+=s,this},Vec2.prototype.vsub=function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this},Vec2.prototype.sub=function(other){return this.vsub(this,other)},Vec2.prototype.ssub=function(s){return this.x-=s,this.y-=s,this},Vec2.prototype.vmul=function(a,b){return this.x=a.x*b.x,this.y=a.y*b.y,this},Vec2.prototype.mul=function(other){return this.vmul(this,other)},Vec2.prototype.smul=function(s){return this.x*=s,this.y*=s,this},Vec2.prototype.vdiv=function(a,b){var x=b.x,y=b.y;return x!==0&&y!==0?(this.x=a.x/x,this.y=a.y/y):(this.x=0,this.y=0),this},Vec2.prototype.div=function(other){return this.vdiv(this,other)},Vec2.prototype.sdiv=function(s){return s!==0?(s=1/s,this.x*=s,this.y*=s):(this.x=0,this.y=0),this},Vec2.vdot=Vec2.prototype.vdot=function(a,b){return a.x*b.x+a.y*b.y},Vec2.prototype.dot=function(other){return this.vdot(this,other)},Vec2.prototype.vlerp=function(a,b,t){return this.x=lerp(a.x,b.x,t),this.y=lerp(a.y,b.y,t),this},Vec2.prototype.lerp=function(other,t){return this.vlerp(this,other,t)},Vec2.prototype.vslerp=function(){var start=new Vec2,end=new Vec2,vec=new Vec2,relative=new Vec2;return function(a,b,t){var dot=clamp(Vec3.vdot(a,b),-1,1),theta=acos(dot)*t;return start.copy(a),end.copy(b),vec.copy(start),relative.vsub(end,vec.smul(dot)),relative.norm(),this.vadd(start.smul(cos(theta)),relative.smul(sin(theta)))}}(),Vec2.prototype.slerp=function(other,t){return this.vslerp(this,other,t)},Vec2.prototype.applyMat3=function(m){var x=this.x,y=this.y,me=m.elements;return this.x=me[0]*x+me[3]*y+me[6],this.y=me[1]*x+me[4]*y+me[7],this},Vec2.prototype.applyMat4=function(m){var x=this.x,y=this.y,me=m.elements;return this.x=me[0]*x+me[4]*y+me[8]+me[12],this.y=me[1]*x+me[5]*y+me[9]+me[13],this},Vec2.prototype.applyQuat=function(q){var x=this.x,y=this.y,qx=q.x,qy=q.y,qz=q.z,qw=q.w,ix=qw*x+qy-qz*y,iy=qw*y+qz*x-qx,iz=qw+qx*y-qy*x,iw=-qx*x-qy*y-qz;return this.x=ix*qw+iw*-qx+iy*-qz-iz*-qy,this.y=iy*qw+iw*-qy+iz*-qx-ix*-qz,this},Vec2.prototype.applyProjection=function(m){var x=this.x,y=this.y,me=m.elements,d=1/(me[3]*x+me[7]*y+me[11]+me[15]);return this.x=(me[0]*x+me[4]*y+me[8]+me[12])*d,this.y=(me[1]*x+me[5]*y+me[9]+me[13])*d,this},Vec2.prototype.getPositionMat3=function(m){var me=m.elements;return this.x=me[6],this.y=me[7],this},Vec2.prototype.getPositionMat4=function(m){var me=m.elements;return this.x=me[12],this.y=me[13],this},Vec2.prototype.getScaleMat3=function(m){var me=m.elements,sx=this.set(me[0],me[1]).len(),sy=this.set(me[3],me[4]).len();return this.x=sx,this.y=sy,this},Vec2.prototype.getScaleMat4=function(m){var me=m.elements,sx=this.set(me[0],me[1],me[2]).len(),sy=this.set(me[4],me[5],me[6]).len();return this.x=sx,this.y=sy,this},Vec2.prototype.lenSq=function(){return this.dot(this)},Vec2.prototype.len=function(){return sqrt(this.lenSq())},Vec2.prototype.norm=function(){return this.sdiv(this.len())},Vec2.prototype.setLen=function(len){return this.norm().smul(len)},Vec2.prototype.inverse=function(){return this.smul(-1)},Vec2.prototype.abs=function(){return this.x=abs(this.x),this.y=abs(this.y),this},Vec2.prototype.min=function(other){var x=other.x,y=other.y;return this.x=x<this.x?x:this.x,this.y=y<this.y?y:this.y,this},Vec2.prototype.max=function(other){var x=other.x,y=other.y;return this.x=x>this.x?x:this.x,this.y=y>this.y?y:this.y,this},Vec2.prototype.clamp=function(min,max){return this.x=clamp(this.x,min.x,max.x),this.y=clamp(this.y,min.y,max.y),this},Vec2.distSq=Vec2.prototype.distSq=function(){var dist=new Vec2;return function(a,b){return dist.vsub(a,b).lenSq()}}(),Vec2.dist=Vec2.prototype.dist=function(a,b){return sqrt(Vec2.distSq(a,b))},Vec2.prototype.toString=function(){return"Vec2( "+this.x+", "+this.y+" )"},Vec2.prototype.equals=function(other){return Vec2.equals(this,other)},Vec2.equals=function(a,b){return equals(a.x,b.x)&&equals(a.y,b.y)},Vec2});if(typeof define!="function")var define=require("amdefine")(module);define("math/bound2",["math/vec2"],function(Vec2){var vec2Equals=Vec2.equals;function Bound2(center,size){this.center=center instanceof Vec2?center:new Vec2,this.size=size instanceof Vec2?size:new Vec2,this.extents=(new Vec2).copy(this.size).smul(.5),this.min=(new Vec2).vsub(this.center,this.extents),this.max=(new Vec2).vadd(this.center,this.extents)}return Bound2.prototype.clone=function(){var clone=new Bound2;return clone.copy(this),clone},Bound2.prototype.copy=function(other){return this.center.copy(other.center),this.size.copy(other.size),this.extents.copy(other.extents),this.min.copy(other.min),this.max.copy(other.max),this},Bound2.prototype.set=function(center,size){return this.center.copy(center instanceof Vec2?center:this.center),this.size.copy(size instanceof Vec2?size:this.size),this.extents.copy(this.size).smul(.5),this.min.vsub(this.center,this.extents),this.max.vadd(this.center,this.extents),this},Bound2.prototype.setMinMax=function(min,max){return this.min.copy(min instanceof Vec2?min:this.min),this.max.copy(max instanceof Vec2?max:this.max),this.center.vadd(this.max,this.min).smul(.5),this.size.vsub(this.max,this.min),this.extents.copy(this.size).smul(.5),this},Bound2.prototype.setFromPoints=function(points){var point,i=1,il=points.length;if(il>0){point=points[0],this.min.copy(point),this.max.copy(point);for(i;i<il;i++)point=points[i],point.x<this.min.x?this.min.x=point.x:point.x>this.max.x&&(this.max.x=point.x),point.y<this.min.y?this.min.y=point.y:point.y>this.max.y&&(this.max.y=point.y);this.setMinMax(this.min,this.max)}else this.clear();return this},Bound2.prototype.clear=function(){return this.center.set(0,0,0),this.size.set(0,0,0),this.extents.set(0,0,0),this.min.set(0,0,0),this.max.set(0,0,0),this},Bound2.prototype.expand=function(v){return this.min.sub(v),this.max.add(v),this.setMinMax(this.min,this.max),this},Bound2.prototype.contains=function(point){return point.x<this.min.x||point.x>this.max.x||point.y<this.min.y||point.y>this.max.y?!1:!0},Bound2.prototype.equals=function(other){return Bound2.equals(this,other)},Bound2.equals=function(a,b){return vec2Equals(a.min,b.min)&&vec2Equals(a.max,b.max)},Bound2});if(typeof define!="function")var define=require("amdefine")(module);define("math/vec3",["math/mathf"],function(Mathf){var abs=Math.abs,sqrt=Math.sqrt,lerp=Mathf.lerp,acos=Math.acos,sin=Math.sin,cos=Math.cos,clamp=Mathf.clamp,equals=Mathf.equals;function Vec3(x,y,z){this.x=x||0,this.y=y||0,this.z=z||0}return Vec3.prototype.clone=function(){return new Vec3(this.x,this.y,this.z)},Vec3.prototype.copy=function(other){return this.x=other.x,this.y=other.y,this.z=other.z,this},Vec3.prototype.set=function(x,y,z){return this.x=x,this.y=y,this.z=z,this},Vec3.prototype.vadd=function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this},Vec3.prototype.add=function(other){return this.vadd(this,other)},Vec3.prototype.sadd=function(s){return this.x+=s,this.y+=s,this.z+=s,this},Vec3.prototype.vsub=function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this},Vec3.prototype.sub=function(other){return this.vsub(this,other)},Vec3.prototype.ssub=function(s){return this.x-=s,this.y-=s,this.z-=s,this},Vec3.prototype.vmul=function(a,b){return this.x=a.x*b.x,this.y=a.y*b.y,this.z=a.z*b.z,this},Vec3.prototype.mul=function(other){return this.vmul(this,other)},Vec3.prototype.smul=function(s){return this.x*=s,this.y*=s,this.z*=s,this},Vec3.prototype.vdiv=function(a,b){var x=b.x,y=b.y,z=b.z;return x!==0&&y!==0?(this.x=a.x/x,this.y=a.y/y,this.z=a.z/z):(this.x=0,this.y=0,this.z=0),this},Vec3.prototype.div=function(other){return this.vdiv(this,other)},Vec3.prototype.sdiv=function(s){return s!==0?(s=1/s,this.x*=s,this.y*=s,this.z*=s):(this.x=0,this.y=0,this.z=0),this},Vec3.vdot=Vec3.prototype.vdot=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z},Vec3.prototype.dot=function(other){return this.vdot(this,other)},Vec3.prototype.vlerp=function(a,b,t){return this.x=lerp(a.x,b.x,t),this.y=lerp(a.y,b.y,t),this.z=lerp(a.z,b.z,t),this},Vec3.prototype.lerp=function(other,t){return this.vlerp(this,other,t)},Vec3.prototype.vcross=function(a,b){var ax=a.x,ay=a.y,az=a.z,bx=b.x,by=b.y,bz=b.z;return this.x=ay*bz-az*by,this.y=az*bx-ax*bz,this.z=ax*by-ay*bx,this},Vec3.prototype.cross=function(v){return this.vcross(this,v)},Vec3.prototype.vslerp=function(){var start=new Vec3,end=new Vec3,vec=new Vec3,relative=new Vec3;return function(a,b,t){var dot=clamp(Vec3.vdot(a,b),-1,1),theta=acos(dot)*t;return start.copy(a),end.copy(b),vec.copy(start),relative.vsub(end,vec.smul(dot)),relative.norm(),this.vadd(start.smul(cos(theta)),relative.smul(sin(theta)))}}(),Vec3.prototype.slerp=function(other,t){return this.vslerp(this,other,t)},Vec3.prototype.applyMat3=function(m){var x=this.x,y=this.y,z=this.z,me=m.elements;return this.x=me[0]*x+me[3]*y+me[6]+z,this.y=me[1]*x+me[4]*y+me[7]+z,this.z=me[2]*x+me[5]*y+me[8]+z,this},Vec3.prototype.applyMat4=function(m){var x=this.x,y=this.y,z=this.z,me=m.elements;return this.x=me[0]*x+me[4]*y+me[8]+z*me[12],this.y=me[1]*x+me[5]*y+me[9]+z*me[13],this.z=me[2]*x+me[6]*y+me[10]+z*me[14],this},Vec3.prototype.applyQuat=function(q){var x=this.x,y=this.y,z=this.z,qx=q.x,qy=q.y,qz=q.z,qw=q.w,ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;return this.x=ix*qw+iw*-qx+iy*-qz-iz*-qy,this.y=iy*qw+iw*-qy+iz*-qx-ix*-qz,this.z=iz*qw+iw*-qz+ix*-qy-iy*-qx,this},Vec3.prototype.applyProjection=function(m){var x=this.x,y=this.y,z=this.z,me=m.elements,d=1/(me[3]*x+me[7]*y+me[11]*z+me[15]);return this.x=(me[0]*x+me[4]*y+me[8]*z+me[12])*d,this.y=(me[1]*x+me[5]*y+me[9]*z+me[13])*d,this.z=(me[2]*x+me[6]*y+me[10]*z+me[14])*d,this},Vec3.prototype.getPositionMat3=function(m){var me=m.elements;return this.x=me[6],this.y=me[7],this},Vec3.prototype.getPositionMat4=function(m){var me=m.elements;return this.x=me[12],this.y=me[13],this.z=me[14],this},Vec3.prototype.getScaleMat3=function(m){var me=m.elements,sx=this.set(me[0],me[1]).len(),sy=this.set(me[3],me[4]).len();return this.x=sx,this.y=sy,this.z=1,this},Vec3.prototype.getScaleMat4=function(m){var me=m.elements,sx=this.set(me[0],me[1],me[2]).len(),sy=this.set(me[4],me[5],me[6]).len(),sz=this.set(me[8],me[9],me[10]).len();return this.x=sx,this.y=sy,this.z=sz,this},Vec3.prototype.lenSq=function(){return this.dot(this)},Vec3.prototype.len=function(){return sqrt(this.lenSq())},Vec3.prototype.norm=function(){return this.sdiv(this.len())},Vec3.prototype.setLen=function(len){return this.norm().smul(len)},Vec3.prototype.inverse=function(){return this.smul(-1)},Vec3.prototype.abs=function(){return this.x=abs(this.x),this.y=abs(this.y),this.z=abs(this.z),this},Vec3.prototype.min=function(other){var x=other.x,y=other.y,z=other.z;return this.x=x<this.x?x:this.x,this.y=y<this.y?y:this.y,this.z=z<this.z?z:this.z,this},Vec3.prototype.max=function(other){var x=other.x,y=other.y,z=other.z;return this.x=x>this.x?x:this.x,this.y=y>this.y?y:this.y,this.z=z>this.z?z:this.z,this},Vec3.prototype.clamp=function(min,max){return this.x=clamp(this.x,min.x,max.x),this.y=clamp(this.y,min.y,max.y),this.z=clamp(this.z,min.z,max.z),this},Vec3.distSq=Vec3.prototype.distSq=function(){var dist=new Vec3;return function(a,b){return dist.vsub(a,b).lenSq()}}(),Vec3.dist=Vec3.prototype.dist=function(a,b){return sqrt(Vec3.distSq(a,b))},Vec3.prototype.toString=function(){return"Vec3( "+this.x+", "+this.y+", "+this.z+")"},Vec3.prototype.equals=function(other){return Vec3.equals(this,other)},Vec3.equals=function(a,b){return equals(a.x,b.x)&&equals(a.y,b.y)&&equals(a.z,b.z)},Vec3});if(typeof define!="function")var define=require("amdefine")(module);define("math/bound3",["math/vec3"],function(Vec3){var vec3Equals=Vec3.equals;function Bound3(center,size){this.center=center instanceof Vec3?center:new Vec3,this.size=size instanceof Vec3?size:new Vec3,this.extents=(new Vec3).copy(this.size).smul(.5),this.min=(new Vec3).vsub(this.center,this.extents),this.max=(new Vec3).vadd(this.center,this.extents)}return Bound3.prototype.clone=function(){var clone=new Bound3;return clone.copy(this),clone},Bound3.prototype.copy=function(other){return this.center.copy(other.center),this.size.copy(other.size),this.extents.copy(other.extents),this.min.copy(other.min),this.max.copy(other.max),this},Bound3.prototype.set=function(center,size){return this.center.copy(center instanceof Vec3?center:this.center),this.size.copy(size instanceof Vec3?size:this.size),this.extents.copy(this.size).smul(.5),this.min.vsub(this.center,this.extents),this.max.vadd(this.center,this.extents),this},Bound3.prototype.setMinMax=function(min,max){return this.min.copy(min instanceof Vec3?min:this.min),this.max.copy(max instanceof Vec3?max:this.max),this.center.vadd(this.max,this.min).smul(.5),this.size.vsub(this.max,this.min),this.extents.copy(this.size).smul(.5),this},Bound3.prototype.setFromPoints=function(points){var point,i=1,il=points.length;if(il>0){point=points[0],this.min.copy(point),this.max.copy(point);for(i;i<il;i++)point=points[i],point.x<this.min.x?this.min.x=point.x:point.x>this.max.x&&(this.max.x=point.x),point.y<this.min.y?this.min.y=point.y:point.y>this.max.y&&(this.max.y=point.y),point.z<this.min.z?this.min.z=point.z:point.z>this.max.z&&(this.max.z=point.z);this.setMinMax(this.min,this.max)}else this.clear();return this},Bound3.prototype.clear=function(){return this.center.set(0,0,0),this.size.set(0,0,0),this.extents.set(0,0,0),this.min.set(0,0,0),this.max.set(0,0,0),this},Bound3.prototype.expand=function(v){return this.min.sub(v),this.max.add(v),this.setMinMax(this.min,this.max),this},Bound3.prototype.contains=function(point){return point.x<this.min.x||point.x>this.max.x||point.y<this.min.y||point.y>this.max.y||point.z<this.min.z||point.z>this.max.z?!1:!0},Bound3.prototype.equals=function(other){return Bound3.equals(this,other)},Bound3.equals=function(a,b){return vec3Equals(a.min,b.min)&&vec3Equals(a.max,b.max)},Bound3});if(typeof define!="function")var define=require("amdefine")(module);define("math/vec4",["math/mathf"],function(Mathf){var abs=Math.abs,sqrt=Math.sqrt,acos=Math.acos,sin=Math.sin,cos=Math.cos,lerp=Mathf.lerp,clamp=Mathf.clamp,equals=Mathf.equals;function Vec4(x,y,z,w){this.x=x||0,this.y=y||0,this.z=z||0,this.w=w!==undefined?w:1}return Vec4.prototype.clone=function(){return new Vec4(this.x,this.y,this.z,this.w)},Vec4.prototype.copy=function(other){return this.x=other.x,this.y=other.y,this.z=other.z,this.w=other.w,this},Vec4.prototype.set=function(x,y,z,w){return this.x=x,this.y=y,this.z=z,this.w=w,this},Vec4.prototype.vadd=function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this.w=a.w+b.w,this},Vec4.prototype.add=function(other){return this.vadd(this,other)},Vec4.prototype.sadd=function(s){return this.x+=s,this.y+=s,this.z+=s,this.w+=s,this},Vec4.prototype.vsub=function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this.w=a.w-b.w,this},Vec4.prototype.sub=function(other){return this.vsub(this,other)},Vec4.prototype.ssub=function(s){return this.x-=s,this.y-=s,this.z-=s,this.w-=s,this},Vec4.prototype.vmul=function(a,b){return this.x=a.x*b.x,this.y=a.y*b.y,this.z=a.z*b.z,this.w=a.w*b.w,this},Vec4.prototype.mul=function(other){return this.vmul(this,other)},Vec4.prototype.smul=function(s){return this.x*=s,this.y*=s,this.z*=s,this.w*=s,this},Vec4.prototype.vdiv=function(a,b){var x=b.x,y=b.y,z=b.z;return x!==0&&y!==0?(this.x=a.x/x,this.y=a.y/y,this.z=a.z/z,this.w=a.w/w):(this.x=0,this.y=0,this.z=0,this.w=0),this},Vec4.prototype.div=function(other){return this.vdiv(this,other)},Vec4.prototype.sdiv=function(s){return s!==0?(s=1/s,this.x*=s,this.y*=s,this.z*=s,this.w*=s):(this.x=0,this.y=0,this.z=0,this.w=0),this},Vec4.vdot=Vec4.prototype.vdot=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z+a.w*b.w},Vec4.prototype.dot=function(other){return this.vdot(this,other)},Vec4.prototype.vlerp=function(a,b,t){return this.x=lerp(a.x,b.x,t),this.y=lerp(a.y,b.y,t),this.z=lerp(a.z,b.z,t),this.w=lerp(a.w,b.w,t),this},Vec4.prototype.lerp=function(other,t){return this.vlerp(this,other,t)},Vec4.prototype.vslerp=function(){var start=new Vec4,end=new Vec4,vec=new Vec4,relative=new Vec4;return function(a,b,t){var dot=clamp(Vec4.vdot(a,b),-1,1),theta=acos(dot)*t;return start.copy(a),end.copy(b),vec.copy(start),relative.vsub(end,vec.smul(dot)),relative.norm(),this.vadd(start.smul(cos(theta)),relative.smul(sin(theta)))}}(),Vec4.prototype.slerp=function(other,t){return this.vslerp(this,other,t)},Vec4.prototype.applyMat4=function(m){var x=this.x,y=this.y,z=this.z,me=m.elements;return this.x=me[0]*x+me[4]*y+me[8]*z+me[12]*w,this.y=me[1]*x+me[5]*y+me[9]*z+me[13]*w,this.z=me[2]*x+me[6]*y+me[10]*z+me[14]*w,this.w=me[3]*x+me[7]*y+me[11]*z+me[15]*w,this},Vec4.prototype.applyProjection=function(m){var x=this.x,y=this.y,z=this.z,me=m.elements,d=1/(me[3]*x+me[7]*y+me[11]*z+me[15]);return this.x=(me[0]*x+me[4]*y+me[8]*z+me[12]*w)*d,this.y=(me[1]*x+me[5]*y+me[9]*z+me[13]*w)*d,this.z=(me[2]*x+me[6]*y+me[10]*z+me[14]*w)*d,this.w=(me[3]*x+me[7]*y+me[11]*z+me[15]*w)*d,this},Vec4.prototype.lenSq=function(){return this.dot(this)},Vec4.prototype.len=function(){return sqrt(this.lenSq())},Vec4.prototype.norm=function(){return this.sdiv(this.len())},Vec4.prototype.setLen=function(len){return this.norm().smul(len)},Vec4.prototype.inverse=function(){return this.smul(-1)},Vec4.prototype.abs=function(){return this.x=abs(this.x),this.y=abs(this.y),this.z=abs(this.z),this.w=abs(this.w),this},Vec4.prototype.min=function(other){var x=other.x,y=other.y,z=other.z,w=other.w;return this.x=x<this.x?x:this.x,this.y=y<this.y?y:this.y,this.z=z<this.z?z:this.z,this.w=w<this.w?w:this.w,this},Vec4.prototype.max=function(other){var x=other.x,y=other.y,z=other.z,w=other.w;return this.x=x>this.x?x:this.x,this.y=y>this.y?y:this.y,this.z=z>this.z?z:this.z,this.w=w>this.w?w:this.w,this},Vec4.prototype.clamp=function(min,max){return this.x=clamp(this.x,min.x,max.x),this.y=clamp(this.y,min.y,max.y),this.z=clamp(this.z,min.y,max.z),this.w=clamp(this.w,min.w,max.w),this},Vec4.distSq=Vec4.prototype.distSq=function(){var dist=new Vec4;return function(a,b){return dist.vsub(a,b).lenSq()}}(),Vec4.dist=Vec4.prototype.dist=function(a,b){return sqrt(Vec4.distSq(a,b))},Vec4.prototype.toString=function(){return"Vec4( "+this.x+", "+this.y+", "+this.z+", "+this.w+" )"},Vec4.prototype.equals=function(other){return Vec4.equals(this,other)},Vec4.equals=function(a,b){return equals(a.x,b.x)&&equals(a.y,b.y)&&equals(a.z,b.z)&&equals(a.w,b.w)},Vec4});if(typeof define!="function")var define=require("amdefine")(module);define("math/color",["math/mathf","math/vec3","math/vec4"],function(Mathf,Vec3,Vec4){var abs=Math.abs,floor=Math.floor,sqrt=Math.sqrt,lerp=Mathf.lerp,equals=Mathf.equals;function Color(r,g,b,a){this.r=0,this.g=0,this.b=0,this.a=1,this._cache={rgb:"rgb( 0, 0, 0 )",rgba:"rgba( 0, 0, 0, 1 )",hex:"#000000"},this.set(r||0,g||0,b||0,a!==undefined?a:1)}Color.prototype.clone=function(){return new Color(this.r,this.g,this.b,this.a)},Color.prototype.copy=function(other){if(other instanceof Vec3)this.r=other.x,this.g=other.y,this.b=other.z,this._updateCache();else if(other instanceof Vec4)this.r=other.x,this.g=other.y,this.b=other.z,this.a=other.w,this._updateCache();else{var cacheA=this._cache,cacheB=other._cache;this.r=other.r,this.g=other.g,this.b=other.b,this.a=other.a,cacheA.hex=cacheB.hex,cacheA.rgb=cacheB.rgb,cacheA.rgba=cacheB.rgba}return this},Color.prototype.set=function(r,g,b,a){return typeof r=="number"?this.setArgs(r,g,b,a):typeof r=="string"?this.setString(r):(this.set(0,0,0,1),console.warn("Color.set: Invalid input")),this},Color.prototype.setString=function(){var reg1=/^rgb(a)?\(\s*(-?[\d]+)(%)?\s*,\s*(-?[\d]+)(%)?\s*,\s*(-?[\d]+)(%)?\s*,?\s*(-?[\d\.]+)?\s*\)$/,reg2=/#(.)(.)(.)/,str="#$1$1$2$2$3$3",hexName;function isValidRgb(rgb){return rgb.match(reg1)}function isValidHex(hex){return reg2.test(hex)}return function(str){return hexName=colorNames[str.toLowerCase()],isValidHex(str)?this.setHex(str):isValidRgb(str)?this.setRgb(str):hexName?this.setHex(hexName):(this.set(0,0,0,1),console.warn("Color.setString: Invalid String")),this}}(),Color.prototype.setArgs=function(r,g,b,a){return this.r=r,this.g=g,this.b=b,this.a=a,this._updateCache(),this},Color.prototype.setRgb=function(){var reg=/^rgb(a)?\(\s*(-?[\d]+)(%)?\s*,\s*(-?[\d]+)(%)?\s*,\s*(-?[\d]+)(%)?\s*,?\s*(-?[\d\.]+)?\s*\)$/;function isValid(rgb){return rgb.match(reg)}return function(rgb){return rgb=isValid(rgb),rgb?(this.r=Number(rgb[2])/255,this.g=Number(rgb[4])/255,this.b=Number(rgb[6])/255,this.a=Number(rgb[8])||1):(this.set(0,0,0,1),console.warn("Color.setRgb: Invalid rgb")),this._updateCache(),this}}(),Color.prototype.setHex=function(){var reg1=/#(.)(.)(.)/,reg2=/^#(?:[0-9a-f]{3}){1,2}$/i,str="#$1$1$2$2$3$3";function normalizeHex(hex){return hex.length===4&&(hex=hex.replace(reg1,str)),hex.toLowerCase(),hex}function isValid(hex){return reg2.test(hex)}return function(hex){return isValid(hex)?(normalizeHex(hex),this.r=parseInt(hex.substr(1,2),16)/255,this.g=parseInt(hex.substr(3,2),16)/255,this.b=parseInt(hex.substr(5,2),16)/255,this.a=1):(this.set(0,0,0,1),console.warn("Color.setHex: Invalid hex")),this._updateCache(),this}}(),Color.prototype._updateCache=function(){var cache,num,n;function singleToHex(value){return num=floor(value*255),n=parseInt(num).toString(16),num===0?n="00":num>0&&num<15&&(n="0"+n),n}return function(){cache=this._cache;var hexR=singleToHex(this.r),hexG=singleToHex(this.g),hexB=singleToHex(this.b),rgbR=floor(this.r*256),rgbG=floor(this.g*256),rgbB=floor(this.b*256),rgbA=floor(this.a);return cache.rgb="rgb( "+rgbR+", "+rgbG+", "+rgbB+" )",cache.rgba="rgba( "+rgbR+", "+rgbG+", "+rgbB+", "+rgbA+" )",cache.hex="#"+hexR+hexG+hexB,this}}(),Color.prototype.hex=function(){return this._cache.hex},Color.prototype.rgb=function(){return this._cache.rgb},Color.prototype.rgba=function(){return this._cache.rgba},Color.prototype.cadd=function(a,b){return this.r=a.r+b.r,this.g=a.g+b.g,this.b=a.b+b.b,this.a=a.a+b.a,this},Color.prototype.add=function(other){return this.cadd(this,other)},Color.prototype.sadd=function(s){return this.r+=s,this.g+=s,this.b+=s,this.a+=s,this},Color.prototype.csub=function(a,b){return this.r=a.r-b.r,this.g=a.g-b.g,this.b=a.b-b.b,this.a=a.a-b.a,this},Color.prototype.sub=function(other){return this.csub(this,other)},Color.prototype.ssub=function(s){return this.r-=s,this.g-=s,this.b-=s,this.a-=s,this},Color.prototype.cmul=function(a,b){return this.r=a.r*b.r,this.g=a.g*b.g,this.b=a.b*b.b,this.a=a.a*b.a,this},Color.prototype.mul=function(other){return this.cmul(this,other)},Color.prototype.smul=function(s){return this.r*=s,this.g*=s,this.b*=s,this.a*=s,this},Color.prototype.cdiv=function(a,b){var x=b.r,y=b.g,z=b.b;return x!==0&&y!==0?(this.r=a.r/x,this.g=a.g/y,this.b=a.b/z,this.a=a.a/w):(this.r=0,this.g=0,this.b=0,this.a=0),this},Color.prototype.div=function(other){return this.cdiv(this,other)},Color.prototype.sdiv=function(s){return s!==0?(s=1/s,this.r*=s,this.g*=s,this.b*=s,this.a*=s):(this.r=0,this.g=0,this.b=0,this.a=0),this},Color.cdot=Color.prototype.cdot=function(a,b){return a.r*b.r+a.g*b.g+a.b*b.b+a.a*b.a},Color.prototype.dot=function(other){return this.cdot(this,other)},Color.prototype.clerp=function(a,b,t){return this.r=lerp(a.r,b.r,t),this.g=lerp(a.g,b.g,t),this.b=lerp(a.b,b.b,t),this.a=lerp(a.a,b.a,t),this},Color.prototype.lerp=function(other,t){return this.clerp(this,other,t)},Color.prototype.lenSq=function(){return this.dot(this)},Color.prototype.len=function(){return sqrt(this.lenSq())},Color.prototype.norm=function(){return this.sdiv(this.len())},Color.prototype.abs=function(){return this.r=abs(this.r),this.g=abs(this.g),this.b=abs(this.b),this.a=abs(this.a),this},Color.prototype.min=function(other){var r=other.r,g=other.g,b=other.b,a=other.a;return this.r=r<this.r?r:this.r,this.g=g<this.g?g:this.g,this.b=b<this.b?b:this.b,this.a=a<this.a?a:this.a,this},Color.prototype.max=function(other){var r=other.r,g=other.g,b=other.b,a=other.a;return this.r=r>this.r?r:this.r,this.g=g>this.g?g:this.g,this.b=b>this.b?b:this.b,this.a=a>this.a?a:this.a,this},Color.prototype.clamp=function(min,max){return this.r=clamp(this.r,min.r,max.r),this.g=clamp(this.g,min.g,max.g),this.b=clamp(this.b,min.g,max.b),this.a=clamp(this.a,min.a,max.a),this},Color.prototype.toString=function(){return"Color( "+this.r+", "+this.g+", "+this.b+", "+this.a+" )"},Color.prototype.equals=function(other){return Color.equals(this,other)},Color.equals=function(a,b){return equals(a.r,b.r)&&equals(a.g,b.g)&&equals(a.b,b.b)&&equals(a.a,b.a)};var colorNames={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};return Color});if(typeof define!="function")var define=require("amdefine")(module);define("math/mat3",["math/mathf","math/vec2"],function(Mathf,Vec2){var cos=Math.cos,sin=Math.sin,abs=Math.abs,atan2=Math.atan2,equals=Mathf.equals;function Mat3(m11,m12,m13,m21,m22,m23,m31,m32,m33){this.elements=new Float32Array(9),this.set(m11!==undefined?m11:1,m12||0,m13||0,m21||0,m22!==undefined?m22:1,m23||0,m31||0,m32||0,m33!==undefined?m33:1)}return Mat3.prototype.clone=function(){var te=this.elements;return new Mat3(te[0],te[3],te[6],te[1],te[4],te[7],te[2],te[5],te[8])},Mat3.prototype.copy=function(m){var me=m.elements;return this.set(me[0],me[3],me[6],me[1],me[4],me[7],me[2],me[5],me[8])},Mat3.prototype.set=function(m11,m12,m13,m21,m22,m23,m31,m32,m33){var te=this.elements;return te[0]=m11,te[3]=m12,te[6]=m13,te[1]=m21,te[4]=m22,te[7]=m23,te[2]=m31,te[5]=m32,te[8]=m33,this},Mat3.prototype.identity=function(){return this.set(1,0,0,0,1,0,0,0,1),this},Mat3.prototype.determinant=function(){var te=this.elements,a=te[0],b=te[1],c=te[2],d=te[3],e=te[4],f=te[5],g=te[6],h=te[7],i=te[8];return a*e*i-a*f*h-b*d*i+b*f*g+c*d*h-c*e*g},Mat3.prototype.transpose=function(){var te=this.elements,tmp;return tmp=te[1],te[1]=te[3],te[3]=tmp,tmp=te[2],te[2]=te[6],te[6]=tmp,tmp=te[5],te[5]=te[7],te[7]=tmp,this},Mat3.prototype.getInverse=function(m){var te=this.elements,me=m.elements,det,m11=me[0],m12=me[3],m13=me[6],m21=me[1],m22=me[4],m23=me[7],m31=me[2],m32=me[5],m33=me[8];return te[0]=m22*m33-m23*m32,te[1]=m23*m31-m21*m33,te[2]=m21*m32-m22*m31,te[3]=m13*m32-m12*m33,te[4]=m11*m33-m13*m31,te[5]=m12*m31-m11*m32,te[6]=m12*m23-m13*m22,te[7]=m13*m21-m11*m23,te[8]=m11*m22-m12*m21,det=m11*te[0]+m21*te[3]+m31*te[6],det===0?this.identity():this.smul(1/det),this},Mat3.prototype.getInverseMat4=function(m){var te=this.elements,me=m.elements,det,m11=me[0],m12=me[4],m13=me[8],m14=me[12],m21=me[1],m22=me[5],m23=me[9],m24=me[13],m31=me[2],m32=me[6],m33=me[10],m34=me[14],m41=me[3],m42=me[7],m43=me[11],m44=me[15];return te[0]=m33*m22-m32*m23,te[1]=-m33*m21+m31*m23,te[2]=m32*m21-m31*m22,te[3]=-m33*m12+m32*m13,te[4]=m33*m11-m31*m13,te[5]=-m32*m11+m31*m12,te[6]=m23*m12-m22*m13,te[7]=-m23*m11+m21*m13,te[8]=m22*m11-m21*m12,det=m11*te[0]+m21*te[3]+m31*te[6],det===0?this.identity():this.smul(1/det),this},Mat3.prototype.inverse=function(){return this.getInverse(this)},Mat3.prototype.mmul=function(a,b){var te=this.elements,ae=a.elements,be=b.elements,a11=ae[0],a12=ae[3],a13=ae[6],a21=ae[1],a22=ae[4],a23=ae[7],a31=ae[2],a32=ae[5],a33=ae[8],b11=be[0],b12=be[3],b13=be[6],b21=be[1],b22=be[4],b23=be[7],b31=be[2],b32=be[5],b33=be[8];return te[0]=a11*b11+a12*b21+a13*b31,te[3]=a11*b12+a12*b22+a13*b32,te[6]=a11*b13+a12*b23+a13*b33,te[1]=a21*b11+a22*b21+a23*b31,te[4]=a21*b12+a22*b22+a23*b32,te[7]=a21*b13+a22*b23+a23*b33,te[2]=a31*b11+a32*b21+a33*b31,te[5]=a31*b12+a32*b22+a33*b32,te[8]=a31*b13+a32*b23+a33*b33,this},Mat3.prototype.mul=function(m){return this.mmul(this,m)},Mat3.prototype.smul=function(s){var te=this.elements;return te[0]*=s,te[1]*=s,te[2]*=s,te[3]*=s,te[4]*=s,te[5]*=s,te[6]*=s,te[7]*=s,te[8]*=s,this},Mat3.prototype.abs=function(){var te=this.elements;return te[0]=abs(te[0]),te[1]=abs(te[1]),te[2]=abs(te[2]),te[3]=abs(te[3]),te[4]=abs(te[4]),te[5]=abs(te[5]),te[6]=abs(te[6]),te[7]=abs(te[7]),te[8]=abs(te[8]),this},Mat3.prototype.setRotationAngle=function(angle){var te=this.elements,c=cos(angle),s=sin(angle);return te[0]=c,te[1]=-s,te[3]=s,te[4]=c,this},Mat3.prototype.setPositionVec2=Mat3.prototype.setPositionVec3=function(v){var te=this.elements;return te[6]=v.x,te[7]=v.y,this},Mat3.prototype.getRotation=function(){var te=this.elements;return atan2(te[1],te[0])},Mat3.prototype.lookAt=function(){var vec=new Vec2,scale=new Vec2;return function(eye,target){vec.vsub(target,eye),scale.getScaleMat3(this);var te=this.elements,angle=atan2(vec.y,vec.x),c=cos(angle),s=sin(angle);return te[0]=c*scale.x,te[1]=-s*scale.x,te[3]=s*scale.y,te[4]=c*scale.y,this}}(),Mat3.prototype.extractPosition=function(m){var te=this.elements,me=m.elements;return te[6]=me[6],te[7]=me[7],this},Mat3.prototype.extractRotation=function(){var vec=new Vec2;return function(m){var te=this.elements,me=m.elements,scaleX=1/vec.set(me[0],me[1]).len(),scaleY=1/vec.set(me[3],me[4]).len();return te[0]=me[0]*scaleX,te[1]=me[1]*scaleX,te[3]=me[3]*scaleY,te[4]=me[4]*scaleY,this}}(),Mat3.prototype.translate=function(v){var te=this.elements,x=v.x,y=v.y;return te[6]=te[0]*x+te[3]*y+te[6],te[7]=te[1]*x+te[4]*y+te[7],te[8]=te[2]*x+te[5]*y+te[8],this},Mat3.prototype.rotate=function(angle){var te=this.elements,m11=te[0],m12=te[3],m13=te[6],m21=te[1],m22=te[4],m23=te[7],c=cos(angle),s=sin(angle);return te[0]=m11*c-m21*s,te[3]=m12*c-m22*s,te[6]=m13*c-m23*s,te[1]=m11*s+m21*c,te[4]=m12*s+m22*c,te[7]=m13*s+m23*c,this},Mat3.prototype.scale=function(v){var te=this.elements,x=v.x,y=v.x;return te[0]*=x,te[3]*=y,te[1]*=x,te[4]*=y,te[2]*=x,te[5]*=y,this},Mat3.prototype.makeTranslation=function(x,y){return this.set(1,0,x,0,1,y,0,0,1),this},Mat3.prototype.makeRotation=function(angle){var c=cos(angle),s=sin(angle);return this.set(c,s,0,-s,c,0,0,0,1),this},Mat3.prototype.makeScale=function(x,y){return this.set(x,0,0,0,y,0,0,0,1),this},Mat3.prototype.makeOrthographic=function(left,right,top,bottom){var w=1/(right-left),h=1/(top-bottom),x=(right+left)*w,y=(top+bottom)*h;return this.set(2*w,0,-x,0,2*h,-y,0,0,1),this},Mat3.prototype.toString=function(){var te=this.elements;return"Mat3["+te[0]+", "+te[3]+", "+te[6]+"]\n"+"     ["+te[1]+", "+te[4]+", "+te[7]+"]\n"+"     ["+te[2]+", "+te[5]+", "+te[8]+"]"},Mat3.prototype.equals=function(other){return Mat3.equals(this,other)},Mat3.equals=function(a,b){var ae=a.elements,be=b.elements;return equals(ae[0],be[0])&&equals(ae[1],be[1])&&equals(ae[2],be[2])&&equals(ae[3],be[3])&&equals(ae[4],be[4])&&equals(ae[5],be[5])&&equals(ae[6],be[6])&&equals(ae[7],be[7])&&equals(ae[8],be[8])},Mat3});if(typeof define!="function")var define=require("amdefine")(module);define("math/quat",["math/mathf","math/vec3"],function(Mathf,Vec3){var abs=Math.abs,sqrt=Math.sqrt,acos=Math.acos,cos=Math.cos,sin=Math.sin,lerp=Mathf.lerp,clamp=Mathf.clamp,equals=Mathf.equals;function Quat(x,y,z,w){this.x=x||0,this.y=y||0,this.z=z||0,this.w=w!==undefined?w:1}return Quat.prototype.clone=function(){return new Quat(this.x,this.y,this.z,this.w)},Quat.prototype.copy=function(other){return this.x=other.x,this.y=other.y,this.z=other.z,this.w=other.w,this},Quat.prototype.set=function(x,y,z,w){return this.x=x,this.y=y,this.z=z,this.w=w,this},Quat.prototype.qadd=function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this.w=a.w+b.w,this},Quat.prototype.add=function(other){return this.qadd(this,other)},Quat.prototype.sadd=function(s){return this.x+=s,this.y+=s,this.z+=s,this.w+=s,this},Quat.prototype.qsub=function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this.w=a.w-b.w,this},Quat.prototype.sub=function(other){return this.qsub(this,other)},Quat.prototype.ssub=function(s){return this.x-=s,this.y-=s,this.z-=s,this.w-=s,this},Quat.prototype.qmul=function(a,b){var ax=a.x,ay=a.y,az=a.z,aw=a.w,bx=b.x,by=b.y,bz=b.z,bw=b.w;return this.x=ax*bw+aw*bx+ay*bz-az*by,this.y=ay*bw+aw*by+az*bx-ax*bz,this.z=az*bw+aw*bz+ax*by-ay*bx,this.w=aw*bw-ax*bx-ay*by-az*bz,this},Quat.prototype.mul=function(other){return this.qmul(this,other)},Quat.prototype.smul=function(s){return this.x*=s,this.y*=s,this.z*=s,this.w*=s,this},Quat.prototype.sdiv=function(s){return s!==0?(s=1/s,this.x*=s,this.y*=s,this.z*=s,this.w*=s):(this.x=0,this.y=0,this.z=0,this.w=0),this},Quat.qdot=Quat.prototype.qdot=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z+a.w*b.w},Quat.prototype.dot=function(other){return this.qdot(this,other)},Quat.prototype.qlerp=function(a,b,t){return this.x=lerp(a.x,b.x,t),this.y=lerp(a.y,b.y,t),this.z=lerp(a.z,b.z,t),this.w=lerp(a.w,b.w,t),this},Quat.prototype.lerp=function(other,t){return this.qlerp(this,other,t)},Quat.prototype.qslerp=function(){var start=new Quat,end=new Quat,quat=new Quat,relative=new Quat;return function(a,b,t){var dot=clamp(Quat.qdot(a,b),-1,1),theta=acos(dot)*t;return start.copy(a),end.copy(b),quat.copy(start),relative.qsub(end,quat.smul(dot)),relative.norm(),this.qadd(start.smul(cos(theta)),relative.smul(sin(theta)))}}(),Quat.prototype.slerp=function(other,t){return this.qslerp(this,other,t)},Quat.prototype.lenSq=function(){return this.dot(this)},Quat.prototype.len=function(){return sqrt(this.lenSq())},Quat.prototype.norm=function(){return this.sdiv(this.len())},Quat.prototype.inverse=function(q){return this.inverse().norm()},Quat.prototype.calculateW=function(){var x=this.x,y=this.y,z=this.z;return this.w=-sqrt(abs(1-x*x-y*y-z*z)),this},Quat.prototype.axisAngle=function(axis,angle){var halfAngle=angle*.5,s=sin(halfAngle);return this.x=axis.x*s,this.y=axis.y*s,this.z=axis.z*s,this.w=cos(halfAngle),this},Quat.prototype.getRotationMat4=function(m){var te=m.elements,m11=te[0],m12=te[4],m13=te[8],m21=te[1],m22=te[5],m23=te[9],m31=te[2],m32=te[6],m33=te[10],trace=m11+m22+m33,s;return trace>0?(s=.5/sqrt(trace+1),this.w=.25/s,this.x=(m32-m23)*s,this.y=(m13-m31)*s,this.z=(m21-m12)*s):m11>m22&&m11>m33?(s=2*sqrt(1+m11-m22-m33),this.w=(m32-m23)/s,this.x=.25*s,this.y=(m12+m21)/s,this.z=(m13+m31)/s):m22>m33?(s=2*sqrt(1+m22-m11-m33),this.w=(m13-m31)/s,this.x=(m12+m21)/s,this.y=.25*s,this.z=(m23+m32)/s):(s=2*sqrt(1+m33-m11-m22),this.w=(m21-m12)/s,this.x=(m13+m31)/s,this.y=(m23+m32)/s,this.z=.25*s),this},Quat.prototype.rotateX=function(angle){angle/=2;var x=this.x,y=this.y,z=this.z,w=this.w,s=sin(angle),c=cos(angle);return this.x=x*c+w*s,this.y=y*c+z*s,this.z=z*c-y*s,this.w=w*c-x*s,this},Quat.prototype.rotateY=function(angle){angle/=2;var x=this.x,y=this.y,z=this.z,w=this.w,s=sin(angle),c=cos(angle);return this.x=x*c-z*s,this.y=y*c+w*s,this.z=z*c+x*s,this.w=w*c-y*s,this},Quat.prototype.rotateZ=function(angle){angle/=2;var x=this.x,y=this.y,z=this.z,w=this.w,s=sin(angle),c=cos(angle);return this.x=x*c+y*s,this.y=y*c-x*s,this.z=z*c+w*s,this.w=w*c-z*s,this},Quat.prototype.rotate=function(x,y,z){return this.rotateZ(z),this.rotateX(x),this.rotateY(y),this},Quat.distSq=Quat.prototype.distSq=function(){var dist=new Quat;return function(a,b){return dist.qsub(a,b).lenSq()}}(),Quat.dist=Quat.prototype.dist=function(a,b){return sqrt(this.distSq(a,b))},Quat.prototype.toString=function(){return"Quat( "+this.x+", "+this.y+", "+this.z+", "+this.w+" )"},Quat.prototype.equals=function(other){return Quat.equals(this,other)},Quat.equals=function(a,b){return equals(a.x,b.x)&&equals(a.y,b.y)&&equals(a.z,b.z)&&equals(a.w,b.w)},Quat});if(typeof define!="function")var define=require("amdefine")(module);define("math/mat4",["math/mathf","math/vec3","math/quat"],function(Mathf,Vec3,Quat){var cos=Math.cos,sin=Math.sin,abs=Math.abs,tan=Math.tan,equals=Mathf.equals;function Mat4(m11,m12,m13,m14,m21,m22,m23,m24,m31,m32,m33,m34,m41,m42,m43,m44){this.elements=new Float32Array(16),this.set(m11!==undefined?m11:1,m12||0,m13||0,m14||0,m21||0,m22!==undefined?m22:1,m23||0,m34||0,m31||0,m32||0,m33!==undefined?m33:1,m34||0,m41||0,m42||0,m43||0,m44!==undefined?m44:1)}return Mat4.prototype.clone=function(){var te=this.elements;return new Mat3(te[0],te[4],te[8],te[12],te[1],te[5],te[9],te[13],te[2],te[6],te[10],te[14],te[3],te[7],te[11],te[15])},Mat4.prototype.copy=function(m){var me=m.elements;return this.set(me[0],me[4],me[8],me[12],me[1],me[5],me[9],me[13],me[2],me[6],me[10],me[14],me[3],me[7],me[11],me[15])},Mat4.prototype.set=function(m11,m12,m13,m14,m21,m22,m23,m24,m31,m32,m33,m34,m41,m42,m43,m44){var te=this.elements;return te[0]=m11,te[4]=m12,te[8]=m13,te[12]=m14,te[1]=m21,te[5]=m22,te[9]=m23,te[13]=m24,te[2]=m31,te[6]=m32,te[10]=m33,te[14]=m34,te[3]=m41,te[7]=m42,te[11]=m43,te[15]=m44,this},Mat4.prototype.identity=function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},Mat4.prototype.determinant=function(){var te=this.elements,m11=te[0],m12=te[4],m13=te[8],m14=te[12],m21=te[1],m22=te[5],m23=te[9],m24=te[13],m31=te[2],m32=te[6],m33=te[10],m34=te[14],m41=te[3],m42=te[7],m43=te[11],m44=te[15];return m41*(+m14*m23*m32-m13*m24*m32-m14*m22*m33+m12*m24*m33+m13*m22*m34-m12*m23*m34)+m42*(+m11*m23*m34-m11*m24*m33+m14*m21*m33-m13*m21*m34+m13*m24*m31-m14*m23*m31)+m43*(+m11*m24*m32-m11*m22*m34-m14*m21*m32+m12*m21*m34+m14*m22*m31-m12*m24*m31)+m44*(-m13*m22*m31-m11*m23*m32+m11*m22*m33+m13*m21*m32-m12*m21*m33+m12*m23*m31)},Mat4.prototype.transpose=function(){var te=this.elements,tmp;return tmp=te[1],te[1]=te[4],te[4]=tmp,tmp=te[2],te[2]=te[8],te[8]=tmp,tmp=te[6],te[6]=te[9],te[9]=tmp,tmp=te[3],te[3]=te[12],te[12]=tmp,tmp=te[7],te[7]=te[13],te[13]=tmp,tmp=te[11],te[11]=te[14],te[14]=tmp,this},Mat4.prototype.getInverse=function(m){var te=this.elements,me=m.elements,det,m11=me[0],m12=me[4],m13=me[8],m14=me[12],m21=me[1],m22=me[5],m23=me[9],m24=me[13],m31=me[2],m32=me[6],m33=me[10],m34=me[14],m41=me[3],m42=me[7],m43=me[11],m44=me[15];return te[0]=m23*m34*m42-m24*m33*m42+m24*m32*m43-m22*m34*m43-m23*m32*m44+m22*m33*m44,te[1]=m24*m33*m41-m23*m34*m41-m24*m31*m43+m21*m34*m43+m23*m31*m44-m21*m33*m44,te[2]=m22*m34*m41-m24*m32*m41+m24*m31*m42-m21*m34*m42-m22*m31*m44+m21*m32*m44,te[3]=m23*m32*m41-m22*m33*m41-m23*m31*m42+m21*m33*m42+m22*m31*m43-m21*m32*m43,te[4]=m14*m33*m42-m13*m34*m42-m14*m32*m43+m12*m34*m43+m13*m32*m44-m12*m33*m44,te[5]=m13*m34*m41-m14*m33*m41+m14*m31*m43-m11*m34*m43-m13*m31*m44+m11*m33*m44,te[6]=m14*m32*m41-m12*m34*m41-m14*m31*m42+m11*m34*m42+m12*m31*m44-m11*m32*m44,te[7]=m12*m33*m41-m13*m32*m41+m13*m31*m42-m11*m33*m42-m12*m31*m43+m11*m32*m43,te[8]=m13*m24*m42-m14*m23*m42+m14*m22*m43-m12*m24*m43-m13*m22*m44+m12*m23*m44,te[9]=m14*m23*m41-m13*m24*m41-m14*m21*m43+m11*m24*m43+m13*m21*m44-m11*m23*m44,te[10]=m12*m24*m41-m14*m22*m41+m14*m21*m42-m11*m24*m42-m12*m21*m44+m11*m22*m44,te[11]=m13*m22*m41-m12*m23*m41-m13*m21*m42+m11*m23*m42+m12*m21*m43-m11*m22*m43,te[12]=m14*m23*m32-m13*m24*m32-m14*m22*m33+m12*m24*m33+m13*m22*m34-m12*m23*m34,te[13]=m13*m24*m31-m14*m23*m31+m14*m21*m33-m11*m24*m33-m13*m21*m34+m11*m23*m34,te[14]=m14*m22*m31-m12*m24*m31-m14*m21*m32+m11*m24*m32+m12*m21*m34-m11*m22*m34,te[15]=m12*m23*m31-m13*m22*m31+m13*m21*m32-m11*m23*m32-m12*m21*m33+m11*m22*m33,det=m11*te[0]+m21*te[4]+m31*te[8]+m41*te[12],det==0?this.identity():this.smul(1/det),this},Mat4.prototype.inverse=function(){return this.getInverse(this)},Mat4.prototype.mmul=function(a,b){var te=this.elements,ae=a.elements,be=b.elements,a11=ae[0],a12=ae[4],a13=ae[8],a14=ae[12],a21=ae[1],a22=ae[5],a23=ae[9],a24=ae[13],a31=ae[2],a32=ae[6],a33=ae[10],a34=ae[14],a41=ae[3],a42=ae[7],a43=ae[11],a44=ae[15],b11=be[0],b12=be[4],b13=be[8],b14=be[12],b21=be[1],b22=be[5],b23=be[9],b24=be[13],b31=be[2],b32=be[6],b33=be[10],b34=be[14],b41=be[3],b42=be[7],b43=be[11],b44=be[15];return te[0]=a11*b11+a12*b21+a13*b31+a14*b41,te[1]=a21*b11+a22*b21+a23*b31+a24*b41,te[2]=a31*b11+a32*b21+a33*b31+a34*b41,te[3]=a41*b11+a42*b21+a43*b31+a44*b41,te[4]=a11*b12+a12*b22+a13*b32+a14*b42,te[5]=a21*b12+a22*b22+a23*b32+a24*b42,te[6]=a31*b12+a32*b22+a33*b32+a34*b42,te[7]=a41*b12+a42*b22+a43*b32+a44*b42,te[8]=a11*b13+a12*b23+a13*b33+a14*b43,te[9]=a21*b13+a22*b23+a23*b33+a24*b43,te[10]=a31*b13+a32*b23+a33*b33+a34*b43,te[11]=a41*b13+a42*b23+a43*b33+a44*b43,te[12]=a11*b14+a12*b24+a13*b34+a14*b44,te[13]=a21*b14+a22*b24+a23*b34+a24*b44,te[14]=a31*b14+a32*b24+a33*b34+a34*b44,te[15]=a41*b14+a42*b24+a43*b34+a44*b44,this},Mat4.prototype.mul=function(m){return this.mmul(this,m)},Mat4.prototype.smul=function(s){var te=this.elements;return te[0]*=s,te[1]*=s,te[2]*=s,te[3]*=s,te[4]*=s,te[5]*=s,te[6]*=s,te[7]*=s,te[8]*=s,te[9]*=s,te[10]*=s,te[11]*=s,te[12]*=s,te[13]*=s,te[14]*=s,te[15]*=s,this},Mat4.prototype.abs=function(){var te=this.elements;return te[0]=abs(te[0]),te[1]=abs(te[1]),te[2]=abs(te[2]),te[3]=abs(te[3]),te[4]=abs(te[4]),te[5]=abs(te[5]),te[6]=abs(te[6]),te[7]=abs(te[7]),te[8]=abs(te[8]),te[9]=abs(te[9]),te[10]=abs(te[10]),te[11]=abs(te[11]),te[12]=abs(te[12]),te[13]=abs(te[13]),te[14]=abs(te[14]),te[15]=abs(te[15]),this},Mat4.prototype.setRotationQuat=function(q){var te=this.elements,x=q.x,y=q.y,z=q.z,w=q.w,x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;return te[0]=1-(yy+zz),te[4]=xy-wz,te[8]=xz+wy,te[1]=xy+wz,te[5]=1-(xx+zz),te[9]=yz-wx,te[2]=xz-wy,te[6]=yz+wx,te[10]=1-(xx+yy),this},Mat4.prototype.setPositionVec2=function(v){var te=this.elements;return te[12]=v.x,te[13]=v.y,this},Mat4.prototype.setPositionVec3=function(v){var te=this.elements;return te[12]=v.x,te[13]=v.y,te[14]=v.z,this},Mat4.prototype.lookAt=function(){var defaultUp=new Vec3(0,0,1),x=new Vec3,y=new Vec3,z=new Vec3;return function(eye,target,up){up=up instanceof Vec3?up:defaultUp;var te=this.elements;return z.vsub(eye,target).norm(),z.len()===0&&(z.z=1),x.vcross(up,z).norm(),x.len()===0&&(z.x+=1e-4,x.vcross(up,z).norm()),y.vcross(z,x),te[0]=x.x,te[4]=y.x,te[8]=z.x,te[1]=x.y,te[5]=y.y,te[9]=z.y,te[2]=x.z,te[6]=y.z,te[10]=z.z,this}}(),Mat4.prototype.extractPosition=function(m){var te=this.elements,me=m.elements;return te[12]=me[12],te[13]=me[13],te[14]=me[14],this},Mat4.prototype.extractRotation=function(){var vec=new Vec3;return function(m){var te=this.elements,me=m.elements,scaleX=1/vec.set(me[0],me[1],me[2]).len(),scaleY=1/vec.set(me[4],me[5],me[6]).len(),scaleZ=1/vec.set(me[8],me[9],me[10]).len();return te[0]=me[0]*scaleX,te[1]=me[1]*scaleX,te[2]=me[2]*scaleX,te[4]=me[4]*scaleY,te[5]=me[5]*scaleY,te[6]=me[6]*scaleY,te[8]=me[8]*scaleZ,te[9]=me[9]*scaleZ,te[10]=me[10]*scaleZ,this}}(),Mat4.prototype.translate=function(v){var te=this.elements,x=v.x,y=v.y,z=v.z;return te[12]=te[0]*x+te[4]*y+te[8]*z+te[12],te[13]=te[1]*x+te[5]*y+te[9]*z+te[13],te[14]=te[2]*x+te[6]*y+te[10]*z+te[14],te[15]=te[3]*x+te[7]*y+te[11]*z+te[15],this},Mat4.prototype.rotateAxis=function(v){var te=this.elements,vx=v.x,vy=v.y,vz=v.z;return v.x=vx*te[0]+vy*te[4]+vz*te[8],v.y=vx*te[1]+vy*te[5]+vz*te[9],v.z=vx*te[2]+vy*te[6]+vz*te[10],v.norm(),v},Mat4.prototype.rotateX=function(angle){var te=this.elements,m12=te[4],m22=te[5],m32=te[6],m42=te[7],m13=te[8],m23=te[9],m33=te[10],m43=te[11],c=cos(angle),s=sin(angle);return te[4]=c*m12+s*m13,te[5]=c*m22+s*m23,te[6]=c*m32+s*m33,te[7]=c*m42+s*m43,te[8]=c*m13-s*m12,te[9]=c*m23-s*m22,te[10]=c*m33-s*m32,te[11]=c*m43-s*m42,this},Mat4.prototype.rotateY=function(angle){var te=this.elements,m11=te[0],m21=te[1],m31=te[2],m41=te[3],m13=te[8],m23=te[9],m33=te[10],m43=te[11],c=cos(angle),s=sin(angle);return te[0]=c*m11-s*m13,te[1]=c*m21-s*m23,te[2]=c*m31-s*m33,te[3]=c*m41-s*m43,te[8]=c*m13+s*m11,te[9]=c*m23+s*m21,te[10]=c*m33+s*m31,te[11]=c*m43+s*m41,this},Mat4.prototype.rotateZ=function(angle){var te=this.elements,m11=te[0],m21=te[1],m31=te[2],m41=te[3],m12=te[4],m22=te[5],m32=te[6],m42=te[7],c=cos(angle),s=sin(angle);return te[0]=c*m11+s*m12,te[1]=c*m21+s*m22,te[2]=c*m31+s*m32,te[3]=c*m41+s*m42,te[4]=c*m12-s*m11,te[5]=c*m22-s*m21,te[6]=c*m32-s*m31,te[7]=c*m42-s*m41,this},Mat4.prototype.scale=function(v){var te=this.elements,x=v.x,y=v.y,z=v.z;return te[0]*=x,te[4]*=y,te[8]*=z,te[1]*=x,te[5]*=y,te[9]*=z,te[2]*=x,te[6]*=y,te[10]*=z,te[3]*=x,te[7]*=y,te[11]*=z,this},Mat4.prototype.makeTranslation=function(x,y,z){return this.set(1,0,0,x,0,1,0,y,0,0,1,z,0,0,0,1),this},Mat4.prototype.makeRotationX=function(angle){var c=cos(angle),s=sin(angle);return this.set(1,0,0,0,0,c,-s,0,0,s,c,0,0,0,0,1),this},Mat4.prototype.makeRotationY=function(angle){var c=cos(angle),s=sin(angle);return this.set(c,0,s,0,0,1,0,0,-s,0,c,0,0,0,0,1),this},Mat4.prototype.makeRotationZ=function(angle){var c=cos(angle),s=sin(angle);return this.set(c,-s,0,0,s,c,0,0,0,0,1,0,0,0,0,1),this},Mat4.prototype.makeRotationAxis=function(axis,angle){var c=cos(angle),s=sin(angle),t=1-c,x=axis.x,y=axis.y,z=axis.z,tx=t*x,ty=t*y;return this.set(tx*x+c,tx*y-s*z,tx*z+s*y,0,tx*y+s*z,ty*y+c,ty*z-s*x,0,tx*z-s*y,ty*z+s*x,t*z*z+c,0,0,0,0,1),this},Mat4.prototype.makeScale=function(x,y,z){return this.set(x,0,0,0,0,y,0,0,0,0,z,0,0,0,0,1),this},Mat4.prototype.makeFrustum=function(left,right,bottom,top,near,far){var te=this.elements,x=2*near/(right-left),y=2*near/(top-bottom),a=(right+left)/(right-left),b=(top+bottom)/(top-bottom),c=-(far+near)/(far-near),d=-2*far*near/(far-near);return this.set(x,0,a,0,0,y,b,0,0,0,c,d,0,0,-1,0),this},Mat4.prototype.makePerspective=function(fov,aspect,near,far){var ymax=near*tan(fov*.008726646259971648),ymin=-ymax,xmin=ymin*aspect,xmax=ymax*aspect;return this.makeFrustum(xmin,xmax,ymin,ymax,near,far)},Mat4.prototype.makeOrthographic=function(left,right,top,bottom,near,far){var te=this.elements,w=1/(right-left),h=1/(top-bottom),p=1/(far-near),x=(right+left)*w,y=(top+bottom)*h,z=(far+near)*p;return this.set(2*w,0,0,-x,0,2*h,0,-y,0,0,-2*p,-z,0,0,0,1),this},Mat4.prototype.toString=function(){var te=this.elements;return"Mat4["+te[0]+", "+te[4]+", "+te[8]+", "+te[12]+"]\n"+"     ["+te[1]+", "+te[5]+", "+te[9]+", "+te[13]+"]\n"+"     ["+te[2]+", "+te[6]+", "+te[10]+", "+te[14]+"]\n"+"     ["+te[3]+", "+te[7]+", "+te[11]+", "+te[15]+"]"},Mat4.prototype.equals=function(other){return Mat3.equals(this,other)},Mat4.equals=function(a,b){var ae=a.elements,be=b.elements;return equals(ae[0],be[0])&&equals(ae[1],be[1])&&equals(ae[2],be[2])&&equals(ae[3],be[3])&&equals(ae[4],be[4])&&equals(ae[5],be[5])&&equals(ae[6],be[6])&&equals(ae[7],be[7])&&equals(ae[8],be[8])&&equals(ae[9],be[9])&&equals(ae[10],be[10])&&equals(ae[11],be[11])&&equals(ae[12],be[12])&&equals(ae[13],be[13])&&equals(ae[14],be[14])&&equals(ae[15],be[15])},Mat4});if(typeof define!="function")var define=require("amdefine")(module);define("base/utils",[],function(){var objProto=Object.prototype,toString=objProto.toString,hasOwnProperty=objProto.hasOwnProperty,splitter=/\s*[\s,]\s*/;function Utils(){}return Utils.prototype.has=function(obj,key){return hasOwnProperty.call(obj,key)},Utils.prototype.isFunction=function(obj){return typeof obj=="function"},Utils.prototype.isFinite=function(obj){return this.isFinite(obj)&&!this.isNaN(parseFloat(obj))},Utils.prototype.isNaN=function(obj){return this.isNumber(obj)&&obj!==+obj},Utils.prototype.isBoolean=function(obj){return obj===!0||obj===!1||toString.call(obj)==="[object Boolean]"},Utils.prototype.isNull=function(obj){return obj===void 0},Utils.prototype.isUndefined=function(obj){return obj===null},Utils.prototype.isArray=function(obj){return toString.call(obj)==="[object Array]"},Utils.prototype.isObject=function(obj){return obj===Object(obj)},Utils.prototype.isString=function(obj){return typeof obj=="string"},Utils.prototype.isNumber=function(obj){return toString.call(obj)==="[object Number]"},Utils.prototype.isArguments=function(obj){return toString.call(obj)==="[object Arguments]"},Utils.prototype.isDate=function(obj){return toString.call(obj)==="[object Date]"},Utils.prototype.isRegExp=function(obj){return toString.call(obj)==="[object RegExp]"},Utils.prototype.isRegExp=function(obj){return toString.call(obj)==="[object RegExp]"},Utils.prototype.now=function(){var startTime=Date.now(),performance=window.performance||{};return performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return Date.now()-startTime}}(),function(){return performance.now()}}(),Utils.prototype.addEvent=function(context,name,callback,ctx){var names=name.split(splitter),i,il,scope=ctx||context,afn=function(e){e=e||window.event,callback&&callback.call(scope,e)};for(i=0,il=names.length;i<il;i++)name=names[i],context.attachEvent?context.attachEvent("on"+name,afn):context.addEventListener(name,afn,!1)},Utils.prototype.removeEvent=function(context,name,callback,ctx){var names=name.split(splitter),i,il,scope=ctx||context,afn=function(e){e=e||window.event,callback&&callback.call(scope,e)};for(i=0,il=names.length;i<il;i++)name=names[i],context.detachEvent?context.detachEvent("on"+name,afn):context.removeEventListener(name,afn,!1)},Utils.prototype.addMeta=function(id,name,content){var meta=document.createElement("meta"),head=document.getElementsByTagName("head")[0];id&&(meta.id=id),name&&(meta.name=name),content&&(meta.content=content),head.insertBefore(meta,head.firstChild)},new Utils});if(typeof define!="function")var define=require("amdefine")(module);define("base/class",["base/utils"],function(Utils){var id=0,slice=Array.prototype.slice;function Class(){this._id=id++,this._class=this.constructor.name,this._events={}}return Class.prototype.on=function(name,callback,context){var events=this._events[name]||(this._events[name]=[]);return events.push({callback:callback,context:context,ctx:context||this}),this},Class.prototype.off=function(name){var events=this._events[name];return events&&(events.length=0),this},Class.prototype.trigger=function(name){var events=this._events[name];if(!events||!events.length)return this;var event,i,il,args=slice.call(arguments,1);for(i=0,il=events.length;i<il;i++)(event=events[i]).callback.apply(event.ctx,args);return this},Class.prototype.listenTo=function(obj,name,callback,ctx){return obj?(obj.on(name,callback,ctx||this),this):this},Class.prototype.toString=function(){return this._class},Class.prototype.getId=function(){return this._id},Class});if(typeof define!="function")var define=require("amdefine")(module);define("base/device",[],function(){var userAgent=navigator.userAgent.toLowerCase(),audio=new Audio,video=document.createElement("video");function Device(){this.userAgent=userAgent,this.pixelRatio=1/(window.devicePixelRatio||1),this.browser=userAgent.indexOf("iphone")!==-1?"iphone":userAgent.indexOf("ipad")!==-1?"ipad":userAgent.indexOf("android")!==-1?"android":userAgent.indexOf("blackberry")!==-1?"blackberry":userAgent.indexOf("msie")!==-1?"ie":userAgent.indexOf("firefox")!==-1?"firefox":userAgent.indexOf("chrome")!==-1?"chrome":userAgent.indexOf("safari")!==-1?"safari":userAgent.indexOf("opera")!==-1?"opera":"unknown",this.browserVersion=Number(userAgent.match(new RegExp("("+this.browser+")( |/)([0-9]+)"))[3]),this.touch="ontouchstart"in window,this.webgl="WebGLRenderingContext"in window,this.audioMpeg=!!audio.canPlayType("audio/mpeg"),this.audioOgg=!!audio.canPlayType("audio/ogg"),this.audioMp4=!!audio.canPlayType("audio/mp4"),this.videoWebm=!!video.canPlayType("video/webm"),this.videoOgg=!!video.canPlayType("video/ogg"),this.videoMp4=!!video.canPlayType("video/mp4")}return Device.prototype.audioContext=function(){return window.audioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext||undefined}(),Device.prototype.requestAnimFrame=function(){var request=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback,element){window.setTimeout(function(){callback(Date.now())},50/3)};return function(callback,element){request.call(window,callback,element)}}(),Device.prototype.cancelAnimFrame=function(id){window.clearTimeout(id)},Device.prototype.getWebGLContext=function(){var defaultAttributes={alpha:!0,antialias:!0,depth:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1,stencil:!0},names=["webgl","webkit-3d","moz-webgl","experimental-webgl","3d"];return function(canvas,attributes){attributes=attributes?attributes:defaultAttributes;var gl,i=0,name;for(i;i<names.length;i++){gl=canvas.getContext(names[i],attributes);if(!!gl)break}if(!gl)throw new Error("Device.getWebGLContext: WebGL Context Creation Failed: "+error);return gl}}(),Device.prototype.createShader=function(gl,type,source){var shader;if(type==="fragment")shader=gl.createShader(gl.FRAGMENT_SHADER);else{if(type!=="vertex")throw new Error("Device.createShader: no shader called"+type);shader=gl.createShader(gl.VERTEX_SHADER)}gl.shaderSource(shader,source),gl.compileShader(shader);if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS))throw Error("Device.createShader: problem compiling shader "+gl.getShaderInfoLog(shader));return shader},Device.prototype.createProgram=function(gl,vertex,fragment){var program=gl.createProgram(),shader,i,il;if(vertex instanceof Array)for(i=0,il=vertex.length;i<il;i++)shader=this.createShader(gl,"vertex",vertex[i]),gl.attachShader(program,shader),gl.deleteShader(shader);else shader=this.createShader(gl,"vertex",vertex),gl.attachShader(program,shader),gl.deleteShader(shader);if(fragment instanceof Array)for(i=0,il=fragment.length;i<il;i++)shader=this.createShader(gl,"fragment",fragment[i]),gl.attachShader(program,shader),gl.deleteShader(shader);else shader=this.createShader(gl,"fragment",fragment),gl.attachShader(program,shader),gl.deleteShader(shader);gl.linkProgram(program),gl.validateProgram(program),gl.useProgram(program);if(!gl.getProgramParameter(program,gl.LINK_STATUS))throw Error("Device.createProgram: problem compiling Program "+gl.getProgramInfoLog(program));return program},new Device});if(typeof define!="function")var define=require("amdefine")(module);define("base/time",["base/utils"],function(Utils){function Time(){this.sinceStart=0,this.time=0,this.delta=1/60,this.scale=1,this.fps=60,this.frame=0}var s,sLast,ms=0,msLast=-16,last=-1e3,dt=1/60,frames=60;return Time.prototype.start=function(){ms=Utils.now(),frames++,last+1e3<ms&&(this.fps=frames*1e3/(ms-last),last=ms,frames=0),s=ms/1e3,sLast=msLast/1e3,dt=s-sLast,this.time=s*this.scale,this.delta=dt*this.scale,this.frame++},Time.prototype.end=function(){msLast=ms},new Time});if(typeof define!="function")var define=require("amdefine")(module);define("core/components/component",["base/class"],function(Class){function Component(){Class.call(this),this.gameObject=undefined}return Component.prototype=Object.create(Class.prototype),Component.prototype.constructor=Component,Component.prototype.init=function(){},Component.prototype.update=function(){},Component});if(typeof define!="function")var define=require("amdefine")(module);define("core/components/camera",["core/components/component","math/mat4"],function(Component,Mat4){function Camera(opts){opts||(opts={}),Component.call(this),this.width=window.innerWidth,this.height=window.innerHeight,this.aspect=this.width/this.height,this.fov=opts.fov!==undefined?opts.fov:35,this.near=opts.near!==undefined?opts.near:.1,this.far=opts.far!==undefined?opts.far:512,this.orthographic=opts.orthographic!==undefined?opts.orthographic:!1,this.orthographicSize=opts.orthographicSize!==undefined?opts.orthographicSize:6,this.matrixProjection=new Mat4,this.matrixProjectionInverse=new Mat4,this.matrixProjectionScreen=new Mat4,this.matrixWorldInverse=new Mat4,this.needsUpdate=!0}return Camera.prototype=Object.create(Component.prototype),Camera.prototype.constructor=Camera,Camera.prototype.clone=function(){var clone=new Camera;return clone.copy(this),clone},Camera.prototype.copy=function(other){return this.width=other.width,this.height=other.height,this.aspect=other.aspect,this.fov=other.fov,this.near=other.near,this.far=other.far,this.orthographic=other.orthographic,this.orthographicSize=other.orthographicSize,this.matrixProjection=other.matrixProjection.clone(),this.matrixProjectionInverse=other.matrixProjectionInverse.clone(),this.matrixProjectionScreen=other.matrixProjectionScreen.clone(),this.matrixWorldInverse=other.matrixWorldInverse.clone(),this.needsUpdate=other.needsUpdate,this},Camera.prototype.setSize=function(width,height){this.width=width!==undefined?width:this.width,this.height=height!==undefined?height:this.height,this.aspect=this.width/this.height,this.needsUpdate=!0},Camera.prototype.setFov=function(fov){this.fov=fov!==undefined?fov:35,this.needsUpdate=!0},Camera.prototype.setLens=function(focalLength,frameHeight){focalLength=focalLength!==undefined?focalLength:35,frameHeight=frameHeight!==undefined?frameHeight:24,this.fov=2*Mathf.toDegs(Math.atan(frameHeight/(focalLength*2))),this.needsUpdate=!0},Camera.prototype.setOrthographic=function(bool){this.orthographic=!!bool,this.needsUpdate=!0},Camera.prototype.setOrthographicSize=function(size){this.orthographicSize=size!==undefined?size:this.orthographicSize,this.needsUpdate=!0},Camera.prototype.updateMatrixProjection=function(){if(!this.orthographic)this.matrixProjection.makePerspective(this.fov,this.aspect,this.near,this.far);else{var orthographicSize=this.orthographicSize/512,right=this.width*.5*orthographicSize,left=-right,top=this.height*.5*orthographicSize,bottom=-top;this.matrixProjection.makeOrthographic(left,right,top,bottom,this.near,this.far)}this.matrixProjectionInverse.getInverse(this.matrixProjection),this.needsUpdate=!1},Camera.prototype.update=function(){this.needsUpdate&&this.updateMatrixProjection(),this.matrixWorldInverse.getInverse(this.gameObject.matrixWorld),this.matrixProjectionScreen.mmul(this.matrixProjection,this.matrixWorldInverse)},Camera});if(typeof define!="function")var define=require("amdefine")(module);define("core/components/light",["core/components/component","math/color"],function(Component,Color){function Light(opts){opts||(opts={}),Component.call(this),this.type=opts.type!==undefined?opts.type:Light.point,this.color=opts.color instanceof Color?opts.color:new Color(1,1,1,1),this.energy=opts.energy!==undefined?opts.energy:1,this.constant=opts.constant!==undefined?opts.constant:0,this.linear=opts.linear!==undefined?opts.linear:1,this.quadratic=opts.quadratic!==undefined?opts.quadratic:0}return Light.prototype=Object.create(Component.prototype),Light.prototype.constructor=Light,Light.prototype.clone=function(){var clone=new Light;return clone.copy(this),clone},Light.prototype.copy=function(other){return this.type=other.type,this.color.copy(other.color),this.energy=other.energy,this.constant=other.constant,this.linear=other.linear,this.quadratic=other.quadratic,this},Light.point=0,Light.directional=1,Light.spot=3,Light.hemi=2,Light});if(typeof define!="function")var define=require("amdefine")(module);define("core/geometry/face",["math/vec3"],function(Vec3){function Face(a,b,c){this.a=a,this.b=b,this.c=c,this.normal=new Vec3}return Face.prototype.clone=function(){var clone=new Face;return clone.copy(this),clone},Face.prototype.copy=function(f){return this.a=f.a,this.b=f.b,this.c=f.c,this.normal.copy(f.normal),this},Face});if(typeof define!="function")var define=require("amdefine")(module);define("core/geometry/geometry",["base/class","math/vec2","math/vec3","math/vec4","math/mat3","core/geometry/face"],function(Class,Vec2,Vec3,Vec4,Mat3,Face){function Geometry(opts){opts||(opts={}),Class.call(this),this.vertices=[],this.normals=[],this.tangents=[],this.faces=[],this.colors=[],this.uv=[],this.dynamic=opts.dynamic!==undefined?opts.dynamic:!1,this.verticesNeedsUpdate=!0,this.normalsNeedsUpdate=!0,this.tangentsNeedsUpdate=!0,this.facesNeedsUpdate=!0,this.colorsNeedsUpdate=!0,this.uvNeedsUpdate=!0,this.buffers={vertices:undefined,normals:undefined,tangents:undefined,colors:undefined,uv:undefined,indices:undefined}}return Geometry.prototype=Object.create(Class.prototype),Geometry.prototype.constructor=Geometry,Geometry.prototype.clone=function(){var clone=new Geometry;return clone.copy(this),clone},Geometry.prototype.copy=function(other){var i,il;this.clear();for(i=0,il=other.vertices.length;i<il;i++)this.vertices[i]=other.vertices[i].clone();for(i=0,il=other.normals.length;i<il;i++)this.normals[i]=other.normals[i].clone();for(i=0,il=other.tangents.length;i<il;i++)this.tangents[i]=other.tangents[i].clone();for(i=0,il=other.colors.length;i<il;i++)this.colors[i]=other.colors[i].clone();for(i=0,il=other.uv.length;i<il;i++)this.uv[i]=other.uv[i].clone();for(i=0,il=other.faces.length;i<il;i++)this.faces[i]=other.faces[i].clone();return this.verticesNeedsUpdate=!0,this.normalsNeedsUpdate=!0,this.tangentsNeedsUpdate=!0,this.facesNeedsUpdate=!0,this.colorsNeedsUpdate=!0,this.uvNeedsUpdate=!0,this},Geometry.prototype.clear=function(){return this.vertices.length=0,this.normals.length=0,this.tangents.length=0,this.faces.length=0,this.colors.length=0,this.uv.length=0,this.verticesNeedsUpdate=!0,this.normalsNeedsUpdate=!0,this.tangentsNeedsUpdate=!0,this.facesNeedsUpdate=!0,this.colorsNeedsUpdate=!0,this.uvNeedsUpdate=!0,this},Geometry.prototype.applyMat4=function(){var normalMatrix=new Mat3,i,il,vertex,face,normal,tangent;return function(matrix){normalMatrix.getInverseMat4(matrix).transpose();for(i=0,il=this.vertices.length;i<il;i++)vertex=this.vertices[i],vertex.applyMat4(matrix);for(i=0,il=this.normals.length;i<il;i++)normal=this.normals[i],normal.applyMat3(normalMatrix).norm();for(i=0,il=this.tangents.length;i<il;i++)tangent=this.tangents[i],tangent.applyMat3(normalMatrix).norm();for(i=0,il=this.faces.length;i<il;i++)face=this.faces[i],face.normal.applyMat3(normalMatrix).norm();this.calculateBounds(),this.verticesNeedsUpdate=!0,this.normalsNeedsUpdate=!0,this.tangentsNeedsUpdate=!0,this.facesNeedsUpdate=!0,this.colorsNeedsUpdate=!0,this.uvNeedsUpdate=!0}}(),Geometry.prototype.calculateNormals=function(){var u=new Vec3,v=new Vec3,uv=new Vec3;return function(){var i,il,vertices=this.vertices,vertex,normals=this.normals,normal,faces=this.faces,face,va,vb,vc;normals.length=vertices.length;for(i=0,il=vertices.length;i<il;i++)normal=normals[i],normal?normal.set(0,0,0):normals[i]=new Vec3;for(i=0,il=faces.length;i<il;i++)face=faces[i],va=vertices[face.a],vb=vertices[face.b],vc=vertices[face.c],u.vsub(vc,vb),v.vsub(va,vb),uv.vcross(u,v),face.normal.copy(uv).norm(),normals[face.a].add(face.normal),normals[face.b].add(face.normal),normals[face.c].add(face.normal);for(i=0,il=faces.length;i<il;i++)face=faces[i],normals[face.a].norm(),normals[face.b].norm(),normals[face.c].norm();this.normalsNeedsUpdate=!0,this.calculateTangents()}}(),Geometry.prototype.calculateTangents=function(){var tan1=[],tan2=[],sdir=new Vec3,tdir=new Vec3,n=new Vec3,t=new Vec3,tmp1=new Vec3,tmp2=new Vec3;return function(){tan1.length=0,tan2.length=0;var face,faces=this.faces,vertex,vertices=this.vertices,normals=this.normals,tangents=this.tangents,uv,uvs=this.uv,v1,v2,v3,w1,w2,w3,x1,x2,y1,y2,z1,z2,s1,s2,t1,t2,a,b,c,r,w,i,il;this.tangents.length=vertices.length;for(i=0,il=vertices.length;i<il;i++)tan1[i]=new Vec3,tan2[i]=new Vec3;for(i=0,il=vertices.length;i<il;i++)uv=uvs[i],uv||(uvs[i]=new Vec2);for(i=0,il=faces.length;i<il;i++)face=faces[i],a=face.a,b=face.b,c=face.c,v1=vertices[a],v2=vertices[b],v3=vertices[c],w1=uvs[a],w2=uvs[b],w3=uvs[c],x1=v2.x-v1.x,x2=v3.x-v1.x,y1=v2.y-v1.y,y2=v3.y-v1.y,z1=v2.z-v1.z,z2=v3.z-v1.z,s1=w2.x-w1.x,s2=w3.x-w1.x,t1=w2.y-w1.y,t2=w3.y-w1.y,r=1/(s1*t2-s2*t1),sdir.set((t2*x1-t1*x2)*r,(t2*y1-t1*y2)*r,(t2*z1-t1*z2)*r),tdir.set((s1*x2-s2*x1)*r,(s1*y2-s2*y1)*r,(s1*z2-s2*z1)*r),tan1[a].add(sdir),tan1[b].add(sdir),tan1[c].add(sdir),tan2[a].add(tdir),tan2[b].add(tdir),tan2[c].add(tdir);for(i=0,il=vertices.length;i<il;i++)vertex=vertices[i],t.copy(tan1[i]),n.copy(normals[i]),tmp1.copy(t),tmp1.sub(n.smul(n.dot(t))).norm(),n.copy(normals[i]),tmp2.vcross(n,t),w=tmp2.dot(tan2[i])<0?-1:1,tangents[i]=new Vec4(tmp1.x,tmp1.y,tmp1.z,w);this.tangentsNeedsUpdate=!0}}(),Geometry.prototype.mergeVertices=function(){var round=Math.round,dif,vertices=this.vertices,vertex,colors=this.colors,color,uvs=this.uv,uv,faces=this.faces,face,i,il,vertexMap={},key,uniqueVertex=[],uniqueUv=[],uniqueColors=[],changes=[];for(i=0,il=vertices.length;i<il;i++)vertex=vertices[i],color=colors[i],uv=uvs[i],key=[round(vertex.x*1e3),round(vertex.y*1e3),round(vertex.z*1e3)].join("_"),vertexMap[key]===undefined?(vertexMap[key]=i,uniqueVertex.push(vertex),!color||uniqueColors.push(color),!uv||uniqueUv.push(uv),changes[i]=uniqueVertex.length-1):changes[i]=changes[vertexMap[key]];for(i=0,il=faces.length;i<il;i++)face=faces[i],face.a=changes[face.a],face.b=changes[face.b],face.c=changes[face.c];return dif=uniqueVertex.length-vertices.length,this.vertices.length=this.colors.length=this.uv.length=0,this.vertices.push.apply(this.vertices,uniqueVertex),this.colors.push.apply(this.colors,uniqueColors),this.uv.push.apply(this.uv,uniqueUv),this.calculateNormals(),this.verticesNeedsUpdate=!0,this.facesNeedsUpdate=!0,this.colorsNeedsUpdate=!0,this.uvNeedsUpdate=!0,dif},Geometry.prototype.addQuad=function(a,b,c,d,uvs){var index=this.vertices.length,va=a.clone(),vb=b.clone(),vc=c.clone(),vd=d.clone(),faceA=new Face(index,index+1,index+2),faceB=new Face(index,index+2,index+3);if(!uvs||!uvs.length||uvs.length!=4)uvs=[0,1,0,1];this.uv.push(new Vec2(uvs[1],uvs[2]),new Vec2(uvs[0],uvs[2]),new Vec2(uvs[0],uvs[3]),new Vec2(uvs[1],uvs[3])),this.colors.push(new Vec3(uvs[1],uvs[2],0),new Vec3(uvs[0],uvs[2],0),new Vec3(uvs[0],uvs[3],0),new Vec3(uvs[1],uvs[3],0)),this.vertices.push(va,vb,vc,vd),this.faces.push(faceA,faceB),this.calculateNormals(),this.verticesNeedsUpdate=!0,this.facesNeedsUpdate=!0,this.colorsNeedsUpdate=!0,this.uvNeedsUpdate=!0},Geometry.prototype.initBuffers=function(){var compileArray=[],vertices,vertex,normals,normal,tangents,tangent,colors,color,uvs,uv,faces,face,buffers,drawType,ARRAY_BUFFER,ELEMENT_ARRAY_BUFFER,i,il;return function(gl){buffers=this.buffers,drawType=this.dynamic===!0?gl.DYNAMIC_DRAW:gl.STATIC_DRAW,ARRAY_BUFFER=gl.ARRAY_BUFFER,ELEMENT_ARRAY_BUFFER=gl.ELEMENT_ARRAY_BUFFER;if(!buffers.vertices||this.verticesNeedsUpdate){vertices=this.vertices,compileArray.length=0;for(i=0,il=vertices.length;i<il;i++)vertex=vertices[i],compileArray.push(vertex.x,vertex.y,vertex.z);!compileArray.length||(buffers.vertices=buffers.vertices||gl.createBuffer(),gl.bindBuffer(ARRAY_BUFFER,buffers.vertices),gl.bufferData(ARRAY_BUFFER,new Float32Array(compileArray),drawType)),this.verticesNeedsUpdate=!1}if(!buffers.normals||this.normalsNeedsUpdate){normals=this.normals,compileArray.length=0;for(i=0,il=normals.length;i<il;i++)normal=normals[i],compileArray.push(normal.x,normal.y,normal.z);!compileArray.length||(buffers.normals=buffers.normals||gl.createBuffer(),gl.bindBuffer(ARRAY_BUFFER,buffers.normals),gl.bufferData(ARRAY_BUFFER,new Float32Array(compileArray),drawType)),this.normalsNeedsUpdate=!1}if(!buffers.tangents||this.tangentsNeedsUpdate){tangents=this.tangents,compileArray.length=0;for(i=0,il=tangents.length;i<il;i++)tangent=tangents[i],compileArray.push(tangent.x,tangent.y,tangent.z,tangent.w);!compileArray.length||(buffers.tangents=buffers.tangents||gl.createBuffer(),gl.bindBuffer(ARRAY_BUFFER,buffers.tangents),gl.bufferData(ARRAY_BUFFER,new Float32Array(compileArray),drawType)),this.tangentsNeedsUpdate=!1}if(!buffers.colors||this.colorsNeedsUpdate){colors=this.colors,compileArray.length=0;for(i=0,il=colors.length;i<il;i++)color=colors[i],compileArray.push(color.x,color.y,color.z);!compileArray.length||(buffers.colors=buffers.colors||gl.createBuffer(),gl.bindBuffer(ARRAY_BUFFER,buffers.colors),gl.bufferData(ARRAY_BUFFER,new Float32Array(compileArray),drawType)),this.colorsNeedsUpdate=!1}if(!buffers.uv||this.uvNeedsUpdate){uvs=this.uv,compileArray.length=0;for(i=0,il=uvs.length;i<il;i++)uv=uvs[i],compileArray.push(uv.x,uv.y);!compileArray.length||(buffers.uv=buffers.uv||gl.createBuffer(),gl.bindBuffer(ARRAY_BUFFER,buffers.uv),gl.bufferData(ARRAY_BUFFER,new Float32Array(compileArray),drawType)),this.uvNeedsUpdate=!1}if(!buffers.indices||this.facesNeedsUpdate){faces=this.faces,compileArray.length=0;for(i=0,il=faces.length;i<il;i++)face=faces[i],compileArray.push(face.a,face.b,face.c);!compileArray.length||(buffers.indices=buffers.indices||gl.createBuffer(),gl.bindBuffer(ELEMENT_ARRAY_BUFFER,buffers.indices),gl.bufferData(ELEMENT_ARRAY_BUFFER,new Int16Array(compileArray),drawType)),this.facesNeedsUpdate=!1}}}(),Geometry});if(typeof define!="function")var define=require("amdefine")(module);define("core/material/texture",["base/class","math/mathf"],function(Class,Mathf){function Texture(opts){opts||(opts={}),Class.call(this),this.image=opts.image instanceof Image?opts.image:new Image,Mathf.isPowerOfTwo(this.image.width)&&Mathf.isPowerOfTwo(this.image.height)?this.mipMap=!0:this.mipMap=!1,this.format=opts.format!==undefined?opts.format:Texture.rgb,this.anisotropy=opts.anisotropy!==undefined?opts.anisotropy:1,this.wrap=opts.wrap!==undefined?opts.wrap:Texture.repeat,this.flipY=opts.flipY!==undefined?opts.flipY:!0,this.data=undefined,this.needsUpdate=!0}return Texture.prototype=Object.create(Class.prototype),Texture.prototype.constructor=Texture,Texture.repeat=0,Texture.clamp=1,Texture.rgb=2,Texture.rgba=3,Texture});if(typeof define!="function")var define=require("amdefine")(module);define("core/material/material",["base/class","math/color","core/material/texture"],function(Class,Color,Texture){function Material(opts){opts||(opts={}),Class.call(this),this.visible=opts.visible!==undefined?opts.visible:!0,this.diffuse=opts.diffuse instanceof Color?opts.diffuse:new Color(.8,.8,.8,1),this.specular=opts.specular instanceof Color?opts.specular:new Color(1,1,1,1),this.hardness=opts.hardness!==undefined?opts.hardness:32,this.emissive=opts.emissive!==undefined?opts.emissive:0,this.shading=opts.shading!==undefined?opts.shading:!0,this.ambient=opts.ambient!==undefined?opts.ambient:1,this.translucency=opts.translucency!==undefined?opts.translucency:0,this.alpha=opts.alpha!==undefined?opts.alpha:1,this.wireframe=opts.wireframe!==undefined?opts.wireframe:!1,this.vertexColors=opts.vertexColors!==undefined?opts.vertexColors:!1,this.diffuseMap=opts.diffuseMap instanceof Texture?opts.diffuseMap:undefined,this.useDiffuseMapAlpha=opts.useDiffuseMapAlpha?!0:!1,this.emitMap=opts.emitMap instanceof Texture?opts.emitMap:undefined,this.alphaMap=opts.alphaMap instanceof Texture?opts.alphaMap:undefined,this.specularMap=opts.specularMap instanceof Texture?opts.specularMap:undefined,this.normalMap=opts.normalMap instanceof Texture?opts.normalMap:undefined,this.blending=opts.blending!==undefined?opts.blending:Material.normal,this.depthTest=opts.depthTest!==undefined?opts.depthTest:!0,this.depthWrite=opts.depthWrite!==undefined?opts.depthWrite:!0,this.shader={opts:{},used:0,uniforms:{},attributes:{},vertex:undefined,fragment:undefined,src:undefined,program:undefined},this.needsUpdate=!0}return Material.prototype=Object.create(Class.prototype),Material.prototype.constructor=Material,Material.none=0,Material.normal=1,Material.additive=2,Material.subtractive=3,Material.multiply=4,Material});if(typeof define!="function")var define=require("amdefine")(module);define("core/components/mesh",["core/components/component","core/geometry/geometry","core/material/material"],function(Component,Geometry,Material){function Mesh(opts){opts||(opts={}),Component.call(this),this.geometry=opts.geometry instanceof Geometry?opts.geometry:new Geometry,this.material=opts.material instanceof Material?opts.material:new Material}return Mesh.prototype=Object.create(Component.prototype),Mesh.prototype.constructor=Mesh,Mesh.prototype.clone=function(){var clone=new Mesh;return clone.copy(this),clone},Mesh.prototype.copy=function(other){return this.geometry=other.geometry,this.material=other.material,this},Mesh});if(typeof define!="function")var define=require("amdefine")(module);define("core/geometry/primitives/cube",["core/geometry/geometry","math/vec3"],function(Geometry,Vec3){function Cube(opts){opts||(opts={});var w=(opts.width!==undefined?opts.width:1)*.5,h=(opts.height!==undefined?opts.height:1)*.5,d=(opts.depth!==undefined?opts.depth:1)*.5,geometry=new Geometry(opts);return geometry.addQuad(new Vec3(-w,h,-d),new Vec3(w,h,-d),new Vec3(w,-h,-d),new Vec3(-w,-h,-d)),geometry.addQuad(new Vec3(w,h,d),new Vec3(-w,h,d),new Vec3(-w,-h,d),new Vec3(w,-h,d)),geometry.addQuad(new Vec3(w,h,-d),new Vec3(w,h,d),new Vec3(w,-h,d),new Vec3(w,-h,-d)),geometry.addQuad(new Vec3(-w,h,d),new Vec3(-w,h,-d),new Vec3(-w,-h,-d),new Vec3(-w,-h,d)),geometry.addQuad(new Vec3(w,-h,d),new Vec3(-w,-h,d),new Vec3(-w,-h,-d),new Vec3(w,-h,-d)),geometry.addQuad(new Vec3(w,h,d),new Vec3(w,h,-d),new Vec3(-w,h,-d),new Vec3(-w,h,d)),geometry.calculateTangents(),geometry.calculateBounds(),geometry}return Cube});if(typeof define!="function")var define=require("amdefine")(module);define("core/geometry/primitives/sphere",["core/geometry/geometry","core/geometry/face","math/mathf","math/vec2","math/vec3"],function(Geometry,Face,Mathf,Vec2,Vec3){var sin=Math.sin,cos=Math.cos,max=Math.max,floor=Math.floor;function Sphere(opts){opts||(opts={});var radius=opts.radius!==undefined?opts.radius:.5,segments=opts.segments!==undefined?floor(max(opts.segments,3)):16,rings=opts.rings!==undefined?floor(max(opts.rings,3)):8,PI=Mathf.PI,TWO_PI=Mathf.TWO_PI,HALF_PI=Mathf.HALF_PI,R=1/(rings-1),S=1/(segments-1),r,s,x,y,z,a,b,c,d,faceA,faceB,normals,vec=new Vec3,geometry=new Geometry(opts);for(r=0;r<rings;r++)for(s=0;s<segments;s++)z=sin(-HALF_PI+PI*r*R),x=cos(TWO_PI*s*S)*sin(PI*r*R),y=sin(TWO_PI*s*S)*sin(PI*r*R),geometry.vertices.push((new Vec3(x,y,z)).smul(radius)),geometry.normals.push(new Vec3(x,y,z)),geometry.uv.push(new Vec2(s*S,r*R)),geometry.colors.push(new Vec3(s*S,r*R,0));normals=geometry.normals;for(r=0;r<rings-1;r++)for(s=0;s<segments-1;s++)a=r*segments+s,b=r*segments+(s+1),c=(r+1)*segments+(s+1),d=(r+1)*segments+s,faceA=new Face(a,b,c),faceB=new Face(a,c,d),vec.copy(normals[a]).add(normals[b]).add(normals[c]).sdiv(3),faceA.normal.copy(vec),vec.copy(normals[a]).add(normals[c]).add(normals[d]).sdiv(3),faceB.normal.copy(vec),geometry.faces.push(faceA,faceB);return geometry.calculateTangents(),geometry.calculateBounds(),geometry}return Sphere});if(typeof define!="function")var define=require("amdefine")(module);define("core/input/accelerometer",["base/class","math/vec2"],function(Class,Vec2){var abs=Math.abs,sqrt=Math.sqrt,accelerationIncludingGravity;function Accelerometer(max){Class.call(this),this.x=0,this.y=0,this.z=0}return Accelerometer.prototype=Object.create(Class.prototype),Accelerometer.prototype.constructor=Accelerometer,Accelerometer.prototype.handle_devicemotion=function(e){var x,y,z,len;aig=e.accelerationIncludingGravity,aig&&(x=aig.x,y=aig.y,z=aig.z,len=x*x+y*y+z*z,len>0?(len=1/sqrt(len),this.x=x*len,this.y=y*len,this.z=z*len):(this.x=0,this.y=0,this.z=0),this.trigger("change"))},new Accelerometer});if(typeof define!="function")var define=require("amdefine")(module);define("core/input/mouse",["base/class","base/time","math/vec2"],function(Class,Time,Vec2){var max=Math.max,min=Math.min,downNeedsUpdate=!0,moveNeedsUpdate=!0,upNeedsUpdate=!0,outNeedsUpdate=!0,wheelNeedsUpdate=!0,isDown=!1,isUp=!0,last=new Vec2;function Mouse(){Class.call(this),this.start=new Vec2,this.delta=new Vec2,this.position=new Vec2,this.end=new Vec2,this.startTime=0,this.deltaTime=0,this.endTime=0,this.wheel=0,this._downFrame=-1,this._upFrame=-1,this.left=!1,this.middle=!1,this.right=!1}return Mouse.prototype=Object.create(Class.prototype),Mouse.prototype.constructor=Mouse,Mouse.prototype.update=function(){downNeedsUpdate=!0,moveNeedsUpdate=!0,upNeedsUpdate=!0,outNeedsUpdate=!0,wheelNeedsUpdate=!0},Mouse.prototype.handleEvents=function(e){e.preventDefault();switch(e.type){case"mousedown":this.handle_mousedown(e);break;case"mousemove":this.handle_mousemove(e);break;case"mouseup":this.handle_mouseup(e);break;case"mouseout":this.handle_mouseout(e);break;case"mousewheel":case"DOMMouseScroll":this.handle_mousewheel(e)}},Mouse.prototype.getPosition=function(e){var element=e.target||e.srcElement,offsetX=element.offsetLeft,offsetY=element.offsetTop,x=(e.pageX||e.clientX)-offsetX,y=window.innerHeight-(e.pageY||e.clientY)-offsetY;this.position.set(x,y)},Mouse.prototype.handle_mousedown=function(e){if(downNeedsUpdate){this.startTime=Time.time,this.getPosition(e),this.start.copy(this.position),this.delta.set(0,0);switch(e.button){case 0:this.left=!0;break;case 1:this.middle=!0;break;case 2:this.right=!0}isDown||(this._downFrame=Time.frame,isDown=!0),isUp=!1,this.trigger("mouseDown"),downNeedsUpdate=!1}},Mouse.prototype.handle_mousemove=function(e){moveNeedsUpdate&&(last.copy(this.position),this.getPosition(e),this.delta.vsub(this.position,last),this.trigger("mouseMove"),moveNeedsUpdate=!1)},Mouse.prototype.handle_mouseup=function(e){if(upNeedsUpdate){this.endTime=Time.time,this.deltaTime=this.endTime-this.startTime,this.getPosition(e),this.end.copy(this.position);switch(e.button){case 0:this.left=!1;break;case 1:this.middle=!1;break;case 2:this.right=!1}isUp||(this._upFrame=Time.frame,isUp=!0),isDown=!1,this.trigger("mouseUp"),upNeedsUpdate=!1}},Mouse.prototype.handle_mouseout=function(e){outNeedsUpdate&&(this.endTime=Time.time,this.deltaTime=this.endTime-this.startTime,this.getPosition(e),this.left=!1,this.middle=!1,this.right=!1,this.trigger("mouseOut"),outNeedsUpdate=!1)},Mouse.prototype.handle_mousewheel=function(e){wheelNeedsUpdate&&(this.wheel=max(-1,min(1,e.wheelDelta||-e.detail)),this.trigger("mouseWheel"),wheelNeedsUpdate=!1)},new Mouse});if(typeof define!="function")var define=require("amdefine")(module);define("core/input/touch",["base/class","math/vec2"],function(Class,Vec2){function Touch(){Class.call(this),this.identifier=-1,this.start=new Vec2,this.delta=new Vec2,this.position=new Vec2,this.end=new Vec2,this._first=!1,this._downFrame=-1,this._upFrame=-1,this.startTime=0,this.deltaTime=0,this.endTime=0}return Touch.prototype=Object.create(Class.prototype),Touch.prototype.constructor=Touch,Touch.prototype.clear=function(){this.identifier=-1,this.start.set(0,0),this.delta.set(0,0),this.position.set(0,0),this.end.set(0,0),this.startTime=0,this.deltaTime=0,this.endTime=0},Touch.prototype.getPosition=function(e){var element=e.target||e.srcElement,offsetX=element.offsetLeft,offsetY=element.offsetTop,x=(e.pageX||e.clientX)-offsetX,y=window.innerHeight-(e.pageY||e.clientY)-offsetY;this.position.set(x,y)},Touch});if(typeof define!="function")var define=require("amdefine")(module);define("core/input/touches",["base/class","base/time","math/vec2","core/input/touch"],function(Class,Time,Vec2,Touch){var startNeedsUpdate=!0,moveNeedsUpdate=!0,endNeedsUpdate=!0,x,y,last=new Vec2,touches,touch,count,i,j,evtTouches,evtTouch;function Touches(){Class.call(this),this.array=[];for(var i=0;i<11;i++)this.array.push(new Touch)}return Touches.prototype=Object.create(Class.prototype),Touches.prototype.constructor=Touches,Touches.prototype.clear=function(){var array=this.array,i,il;for(i=0,il=array.length;i<il;i++)array[i].clear()},Touches.prototype.getTouches=function(){var defaultArray=[];return function(array){array=array instanceof Array?array:defaultArray,array.length=0;var thisArray=this.array,touch,i,il;for(i=0,il=thisArray.length;i<il;i++)touch=thisArray[i],touch.identifier!==-1&&array.push(touch);return array}}(),Touches.prototype.forEach=function(callback){var thisArray=this.array,touch,i,il;for(i=0,il=thisArray.length;i<il;i++)touch=thisArray[i],touch.identifier!==-1&&callback(touch)},Touches.prototype.count=function(){var thisArray=this.array,touch,i,il,count=0;for(i=0,il=thisArray.length;i<il;i++)touch=thisArray[i],touch.identifier!==-1&&count++;return count},Touches.prototype.update=function(){startNeedsUpdate=!0,moveNeedsUpdate=!0,endNeedsUpdate=!0},Touches.prototype.handleEvents=function(e){e.preventDefault();switch(e.type){case"touchstart":this.handle_touchstart(e);break;case"touchmove":this.handle_touchmove(e);break;case"touchend":this.handle_touchend(e);break;case"touchcancel":this.handle_touchcancel(e)}},Touches.prototype.handle_touchstart=function(e){if(startNeedsUpdate){touches=this.array,evtTouches=e.touches,count=evtTouches.length;if(count<=touches.length)for(i=0;i<count;i++)evtTouch=evtTouches[i],touch=touches[i],touch.identifier=evtTouch.identifier,touch.startTime=Time.time,touch.getPosition(evtTouch),touch._first&&(touch._downFrame=Time.frame,touch._first=!1),touch.start.copy(touch.position),this.trigger("touchStart",touch);else this.clear();startNeedsUpdate=!1}},Touches.prototype.handle_touchmove=function(e){if(moveNeedsUpdate){touches=this.array,evtTouches=e.changedTouches,count=evtTouches.length;for(i=0;i<count;i++){evtTouch=evtTouches[i];for(j=0;j<touches.length;j++)touch=touches[j],touch.identifier===evtTouch.identifier&&(last.copy(touch.position),touch.getPosition(evtTouch),touch.delta.vsub(touch.position,last),this.trigger("touchMove",touch))}moveNeedsUpdate=!1}},Touches.prototype.handle_touchend=function(e){if(endNeedsUpdate){touches=this.array,evtTouches=e.changedTouches,count=evtTouches.length;for(i=0;i<count;i++){evtTouch=evtTouches[i];for(j=0;j<touches.length;j++)touch=touches[j],touch.identifier===evtTouch.identifier&&(last.copy(touch.position),touch.getPosition(evtTouch),touch._first||(touch._upFrame=Time.frame,touch._first=!0),touch.endTime=Time.time,touch.deltaTime=touch.endTime-touch.startTime,touch.end.copy(touch.position),touch.identifier=-1,this.trigger("touchEnd",touch))}endNeedsUpdate=!1}},Touches.prototype.handle_touchcancel=function(e){this.clear()},new Touches});if(typeof define!="function")var define=require("amdefine")(module);define("core/input/key",["base/class","math/vec2"],function(Class,Vec2){function Key(name,keyCode){Class.call(this),this.name=name,this.keyCode=keyCode,this.down=!1,this._first=!0,this._downFrame=-1,this._upFrame=-1,this.downTime=-1,this.endTime=-1}return Key.prototype=Object.create(Class.prototype),Key.prototype.constructor=Key,Key});if(typeof define!="function")var define=require("amdefine")(module);define("core/input/keyboard",["base/class","base/time","core/input/key"],function(Class,Time,Key){function Keyboard(){Class.call(this),this.keys={};for(var key in keyNames)this.keys[key]=new Key(key,keyNames[key])}Keyboard.prototype=Object.create(Class.prototype),Keyboard.prototype.constructor=Keyboard,Keyboard.prototype.handleEvents=function(e){e.preventDefault();switch(e.type){case"keydown":this.handle_keydown(e);break;case"keyup":this.handle_keyup(e)}},Keyboard.prototype.handle_keydown=function(e){var keys=this.keys,key,name;for(name in keys)key=keys[name],key.keyCode===e.keyCode&&(key.down=!0,key._first&&(key.downTime=Time.time,key._downFrame=Time.frame,key._first=!1),this.trigger("keyDown",key))},Keyboard.prototype.handle_keyup=function(e){var keys=this.keys,key,name;for(name in keys)key=keys[name],key.keyCode===e.keyCode&&(key.down=!1,key._first||(key.endTime=Time.time,key._upFrame=Time.frame,key._first=!0),this.trigger("keyUp",key))};var keyNames={win_key_ff_linux:0,mac_enter:3,backspace:8,tab:9,num_center:12,enter:13,shift:16,ctrl:17,alt:18,pause:19,caps_lock:20,esc:27,space:32,page_up:33,page_down:34,end:35,home:36,left:37,up:38,right:39,down:40,print_screen:44,insert:45,"delete":46,zero:48,one:49,two:50,three:51,four:52,five:53,six:54,seven:55,eight:56,nine:57,ff_semicolon:59,ff_equals:61,question_mark:63,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,meta:91,win_key_right:92,context_menu:93,num_zero:96,num_one:97,num_two:98,num_three:99,num_four:100,num_five:101,num_six:102,num_seven:103,num_eight:104,num_nine:105,num_mult:106,num_plus:107,num_minus:109,num_period:110,num_division:111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scroll_lock:145,first_media_key:166,last_media_key:183,semicolon:186,dash:189,equals:187,comma:188,period:190,slash:191,apostrophe:192,tilde:192,single_quote:222,open_square_bracket:219,backslash:220,close_square_bracket:221,win_key:224,mac_ff_meta:224,win_ime:229,phantom:255};return new Keyboard});if(typeof define!="function")var define=require("amdefine")(module);define("core/input/orientation",["base/class"],function(Class){function Orientation(max){Class.call(this),this.alpha=0,this.beta=0,this.gamma=0,this.mode="portrait_up"}return Orientation.prototype=Object.create(Class.prototype),Orientation.prototype.constructor=Orientation,Orientation.prototype.handleEvents=function(e){switch(e.type){case"deviceorientation":this.handle_deviceorientation(e);break;case"orientationchange":this.handle_orientationchange(e)}},Orientation.prototype.handle_deviceorientation=function(e){e.alpha!==undefined&&e.beta!==undefined&&e.gamma!==undefined&&(this.alpha=e.alpha,this.beta=e.beta,this.gamma=e.gamma,this.trigger("orientation",this))},Orientation.prototype.handle_orientationchange=function(e){orientation=window.orientation;switch(orientation){case 0:this.mode="portrait_up";break;case 90:this.mode="landscape_left";break;case-90:this.mode="landscape_right";break;case 180:case-180:this.mode="portrait_down"}this.trigger("orientationChange",this.mode,orientation)},new Orientation});if(typeof define!="function")var define=require("amdefine")(module);define("core/input/input",["base/class","base/utils","core/input/mouse","core/input/touches","core/input/keyboard","core/input/accelerometer","core/input/orientation"],function(Class,Utils,Mouse,Touches,Keyboard,Accelerometer,Orientation){var addEvent=Utils.addEvent;function Input(){Class.call(this),this.element=undefined}Input.prototype=Object.create(Class.prototype),Input.prototype.constructor=Input,Input.prototype.init=function(element){this.element=element,addEvent(element,"mousedown mousemove mouseup mouseout DOMMouseScroll mousewheel touchstart touchmove touchend touchcancel",this.handleEvents,this),addEvent(element,"mousedown mousemove mouseup mouseout DOMMouseScroll mousewheel",Mouse.handleEvents,Mouse),addEvent(element,"touchstart touchmove touchend touchcancel",Touches.handleEvents,Touches),addEvent(top,"keydown keyup",Keyboard.handleEvents,Keyboard),addEvent(window,"devicemotion",Accelerometer.handle_devicemotion,Accelerometer),addEvent(window,"deviceorientation orientationchange",Orientation.handleEvents,Orientation)},Input.prototype.update=function(){Mouse.update(),Touches.update()},Input.prototype.key=function(){var keys=Keyboard.keys,key,a=0,al=arguments.length;for(a;a<al;a++){key=keys[arguments[a]];if(!!key&&key.down)return!0}return!1},Input.prototype.keyDown=function(){var keys=Keyboard.keys,key,a=0,al=arguments.length;for(a;a<al;a++){key=keys[arguments[a]];if(!!key&&key.down&&key._downFrame===Time.frame-1)return!0}return!1},Input.prototype.keyUp=function(){var keys=Keyboard.keys,key,a=0,al=arguments.length;for(a;a<al;a++){key=keys[arguments[a]];if(!!key&&!key.down&&key._upFrame===Time.frame-1)return!0}return!1},Input.prototype.mouseButton=function(index){return Mouse.left&&index==0?!0:Mouse.middle&&index==1?!0:Mouse.right&&index==2?!0:!1},Input.prototype.mouseButtonDown=function(index){return this.mouseButton(index)&&Mouse._downFrame===Time.frame-1},Input.prototype.mouseButtonUp=function(index){return!this.mouseButton(index)&&Mouse._upFrame===Time.frame-1},Input.prototype.getTouch=function(index){var touch=Touches.array[index];return touch&&touch.identifier!==-1?touch:undefined};var gesture="",lastGesture="",lastGestureTime=0;Input.prototype.handleEvents=function(e){e.preventDefault();var timeStamp=(e.timeStamp-Time.startTime)/1e3,type=e.type;this._hold(type),this._tap(type,timeStamp),this._swipe(type),this._drag(type)};var holdTimer,holdTimeout=500,holdThreshold=1;Input.prototype._hold=function(type){var scope=this;if(type==="touchstart"||type==="mousedown"){var event=Touches.array[0].identifier!==-1?Touches.array[0]:Mouse;gesture="hold",holdTimer=setTimeout(function(){gesture==="hold"&&(lastGesture="hold",lastGestureTime=Time.time,scope.trigger("hold",event))},holdTimeout)}if(type==="touchmove"||type==="mousemove"){var delta=Touches.array[0].identifier!==-1?Touches.array[0].delta:Mouse.delta;delta.lenSq()>holdThreshold&&clearTimeout(holdTimer)}(type==="touchend"||type==="mouseup")&&clearTimeout(holdTimer)};var tapMaxTime=.25,tapMaxDist=100,doubleTapDistance=400,doubleTapInterval=.3;Input.prototype._tap=function(type,timeStamp){if(type==="touchend"||type==="mouseup"){var event=Touches.array[0].identifier!==-1?Touches.array[0]:Mouse;if(event.deltaTime>tapMaxTime||event.delta.lenSq()>tapMaxDist)return;lastGesture==="tap"&&timeStamp-lastGestureTime<doubleTapInterval&&event.delta.lenSq()<doubleTapDistance?(gesture="doubletap",lastGesture="doubletap",lastGestureTime=Time.time,this.trigger("doubleTap",event)):(gesture="tap",lastGesture="tap",lastGestureTime=Time.time,this.trigger("tap",event))}};var swipeVelocity=.25;Input.prototype._swipe=function(type){if(type==="touchend"||type==="mouseup"){var event=Touches.array[0].identifier!==-1?Touches.array[0]:Mouse,delta=event.delta;if(Math.abs(delta.x*Time.delta)>swipeVelocity||Math.abs(delta.y*Time.delta)>swipeVelocity)gesture="swipe",lastGesture="swipe",lastGestureTime=Time.time,this.trigger("swipe",event,Mathf.direction(delta.x,delta.y))}};var dragMinDistance=10,dragTriggered=!1;Input.prototype._drag=function(type){var event=Touches.array[0].identifier!==-1?Touches.array[0]:Mouse;if(gesture!=="drag"&&dragTriggered){this.trigger("dragEnd",event),dragTriggered=!1;return}if(type==="touchstart"||type==="mousedown")dragTriggered=!1;if(type==="touchmove"||type==="mousemove"&&(Mouse.left||Mouse.middle||Mouse.right)){if(event.delta.lenSq()<dragMinDistance&&gesture!=="drag")return;gesture="drag",dragTriggered||(this.trigger("dragStart",event),dragTriggered=!0),this.trigger("drag",event)}(type==="touchend"||type==="mouseup")&&dragTriggered&&(this.trigger("dragEnd",event),dragTriggered=!1)};var transformMinScale=10,transformMinRotation=1,transformTriggered=!1;return Input.prototype._transformStart=function(){var touches=Touches.getTouches(),touch1=touches[0],touch2=touches[1],scale,rotation,scaleThreshold,rotationThreshold;if(gesture!=="transform"&&transformTriggered){this.trigger("transformEnd"),transformTriggered=!1;return}if(touches.length<2)return;if(type==="touchstart"||type==="mousedown")transformTriggered=!1;if(type==="touchmove"||type==="mousemove"&&(Mouse.left||Mouse.middle||Mouse.right)){scale=Vec2.dist(touch1.position,touch2.position)/Vec2.dist(touch1.start,touch2.start),rotation=Math.atan2(touch2.position.y-touch1.position.y,touch2.position.x-touch1.position.x)-Math.atan2(touch2.start.y-touch1.start.y,touch2.start.x-touch1.start.x),scaleThreshold=Math.abs(1-scale),rotationThreshold=Math.abs(rotation);if(scaleThreshold<transformMinScale&&rotationThreshold<transformMinRotation)return;gesture="transform",transformTriggered||(this.trigger("transformStart",scale,rotation),transformTriggered=!0),this.trigger("transform",scale,rotation)}if(type==="touchend"||type==="mouseup")transformTriggered&&inst.trigger("onTransformEnd",scale,rotation),transformTriggered=!1},new Input});if(typeof define!="function")var define=require("amdefine")(module);define("core/objects/transform3d",["base/class","base/utils","math/vec3","math/quat","math/mat3","math/mat4"],function(Class,Utils,Vec3,Quat,Mat3,Mat4){function Transform3D(opts){opts||(opts={}),Class.call(this),this.parent=undefined,this.root=this,this.children=[],this.matrix=new Mat4,this.matrixWorld=new Mat4,this.matrixModelView=new Mat4,this.matrixNormal=new Mat3,this.position=opts.position instanceof Vec3?opts.position:new Vec3,this.rotation=opts.rotation instanceof Quat?opts.rotation:new Quat,this.scale=opts.scale instanceof Vec3?opts.scale:new Vec3(1,1,1),this.updateMatrices()}return Transform3D.prototype=Object.create(Class.prototype),Transform3D.prototype.constructor=Transform3D,Transform3D.prototype.clone=function(){var clone=new Transform3D;return clone.copy(this),clone},Transform3D.prototype.copy=function(other){var children=other.children,child,i,il;this.children.length=0;for(i=0,il=other.children.length;i<il;i++)child=children[i],child&&this.add(child.clone());return this.root=other.root,this.position.copy(other.position),this.scale.copy(other.scale),this.rotation.copy(other.rotation),this.updateMatrices(),this},Transform3D.prototype.add=function(){var children=this.children,child,index,root,i,il;for(i=0,il=arguments.length;i<il;i++){child=arguments[i],index=children.indexOf(child);if(index===-1&&child instanceof Transform3D){child.parent&&child.parent.remove(child),child.parent=this,children.push(child),root=this;while(!!root.parent)root=root.parent;child.root=root,child.trigger("add"),this.trigger("addChild",child)}}},Transform3D.prototype.remove=function(){var children=this.children,child,index,i,il;for(i=0,il=arguments.length;i<il;i++){child=arguments[i],index=children.indexOf(child);if(index!==-1){children.splice(index,1),child.parent&&child.parent.remove(child),child.parent=undefined,root=this;while(!!root.parent)root=root.parent;child.root=root,child.trigger("remove"),this.trigger("removeChild",child)}}},Transform3D.prototype.localToWorld=function(v){return v.applyMat4(this.matrixWorld)},Transform3D.prototype.worldToLocal=function(){var mat=new Mat4;return function(v){return v.applyMat4(mat.getInverse(this.matrixWorld))}}(),Transform3D.prototype.applyMat4=function(){var mat=new Mat4;return function(matrix){this.matrix.mmul(matrix,this.matrix),this.scale.getScaleMat4(this.matrix),mat.identity().extractRotation(this.matrix),this.rotation.getRotationMat4(mat),this.position.getPositionMat4(this.matrix)}}(),Transform3D.prototype.translate=function(){var vec=new Vec3,quat=new Quat;return function(translation,relativeTo){vec.copy(translation),relativeTo instanceof Transform3D?vec.applyQuat(relativeTo.rotation):relativeTo instanceof Quat&&vec.applyQuat(relativeTo),this.position.add(vec)}}(),Transform3D.prototype.rotate=function(){var vec=new Vec3,quat=new Quat;return function(rotation,relativeTo){vec.copy(rotation),relativeTo instanceof Transform3D?vec.applyQuat(relativeTo.rotation):relativeTo instanceof Quat&&vec.applyQuat(relativeTo),this.rotation.rotate(vec.x,vec.y,vec.z)}}(),Transform3D.prototype.rotateAround=function(){var point=new Vec3,quat=new Quat;return function(point,axis,angle){point.copy(point).sub(this.position),quat.axisAngle(axis,angle),this.translate(point),this.rotation.mul(quat),this.translate(point.inverse(),quat)}}(),Transform3D.prototype.lookAt=function(){var vec=new Vec3,mat=new Mat4,quat=new Quat;return function(target,up){up=up instanceof Vec3?up:undefined,target instanceof Transform3D?vec.copy(target.position):target instanceof Vec3&&vec.copy(target),mat.lookAt(this.position,vec,up),this.rotation.getRotationMat4(mat)}}(),Transform3D.prototype.follow=function(){var vec=new Vec3;return function(target,damping,relativeTo){damping=damping>0?damping:1,target instanceof Transform3D?vec.sub(target.position,this.position):target instanceof Vec3&&vec.sub(target,this.position),vec.lenSq()>.1&&this.translate(vec.smul(1/damping),relativeTo)}}(),Transform3D.prototype.updateMatrices=function(){var scale=this.scale,matrix=this.matrix,matrixWorld=this.matrixWorld;matrix.setRotationQuat(this.rotation),(scale.x!==1||scale.y!==1||scale.z!==1)&&matrix.scale(scale),matrix.setPositionVec3(this.position),this.root===this?matrixWorld.copy(matrix):matrixWorld.mmul(this.parent.matrixWorld,matrix)},Transform3D});if(typeof define!="function")var define=require("amdefine")(module);define("core/objects/gameobject",["core/objects/transform3d","core/components/camera","core/components/light","core/components/mesh"],function(Transform3D,Camera,Light,Mesh){function GameObject(opts){opts||(opts={}),Transform3D.call(this,opts),this.name=opts.name||this._class+"-"+this._id,this.tags=[],this.components={},this.scene=undefined,this.add.apply(this,opts.children),this.addTag.apply(this,opts.tags),this.addComponent.apply(this,opts.components)}return GameObject.prototype=Object.create(Transform3D.prototype),GameObject.prototype.constructor=GameObject,GameObject.prototype.clone=function(){var clone=new GameObject;return clone.copy(this),clone},GameObject.prototype.copy=function(other){var name,component,prop;Transform3D.call(this,other),this.name=this._class+this._id,this.tags.length=0,this.addTag.apply(this,other.tags);for(name in other.components)component=other.components[name],this.addComponent(component.clone());return other.scene&&other.scene.add(this),this},GameObject.prototype.init=function(){var components=this.components,type,component;for(type in components)component=components[type],component&&(component.init(),component.trigger("init"));this.trigger("init")},GameObject.prototype.addTag=function(){var tags=this.tags,tag,index,i,il;for(i=0,il=arguments.length;i<il;i++)tag=arguments[i],index=tags.indexOf(tag),index===-1&&tags.push(tag)},GameObject.prototype.removeTag=function(){var tags=this.tags,tag,index,i,il;for(i=0,il=arguments.length;i<il;i++)tag=arguments[a],index=tags.indexOf(tag),index!==-1&&tags.splice(index,1)},GameObject.prototype.hasTag=function(tag){return this.tags.indexOf(tag)!==-1},GameObject.prototype.addComponent=function(){var components=this.components,component,i,il;for(i=0,il=arguments.length;i<il;i++)component=arguments[i],components[component._class]?console.warn("GameObject.addComponent: GameObject already has a "+component+" Component"):component instanceof Component?(component.gameObject&&(component=component.clone()),components[component._class]=component,component.gameObject=this,this.trigger("addComponent",component),component.trigger("add",this)):console.warn("GameObject.addComponent: "+component._class+" is not an instance of Component")},GameObject.prototype.removeComponent=function(){var components=this.components,component,i,il;for(i=0,il=arguments.length;i<il;i++)component=arguments[i],components[component._class]?(component.gameObject=undefined,delete components[component._class],this.trigger("removeComponent",component),component.trigger("remove",this)):console.warn("GameObject.removeComponent: Component is not attached GameObject")},GameObject.prototype.hasComponent=function(type){return!!this.components[type]},GameObject.prototype.getComponent=function(type){return this.components[type]},GameObject.prototype.getComponents=function(results){results=results||[];var key;for(key in this.components)results.push(this.components[key]);return results},GameObject.prototype.forEachComponent=function(callback){var components=this.components,type,component;for(type in components)component=components[type],component&&callback(component)},GameObject.prototype.update=function(){var components=this.components,type,component;this.trigger("update");for(type in components)component=components[type],component&&component.update&&component.update();this.updateMatrices(),this.trigger("lateUpdate")},GameObject});if(typeof define!="function")var define=require("amdefine")(module);define("core/objects/transform2d",["base/class","base/utils","math/vec2","math/mat3"],function(Class,Utils,Vec2,Mat3){function Transform2D(opts){opts||(opts={}),Class.call(this),this.root=this,this.children=[],this.matrix=new Mat3,this.matrixWorld=new Mat3,this.matrixModelView=new Mat3,this.position=opts.position instanceof Vec2?opts.position:new Vec2,this.rotation=opts.rotation?opts.rotation:0,this.scale=opts.scale instanceof Vec2?opts.scale:new Vec2(1,1),this.updateMatrices()}return Transform2D.prototype=Object.create(Class.prototype),Transform2D.prototype.constructor=Transform2D,Transform2D.prototype.clone=function(){var clone=new Transform2D;return clone.copy(this),clone},Transform2D.prototype.copy=function(other){var children=other.children,child,c=0,cl=other.children.length;this.children.length=0;for(c;c<cl;c++)child=children[c],!child||this.add(child.clone());return this.root=other.root,this.position.copy(other.position),this.scale.copy(other.scale),this.rotation=other.rotation,this.updateMatrices(),this},Transform2D.prototype.add=function(){var children=this.children,child,index,root,i,il;for(i=0,il=arguments.length;i<il;i++){child=arguments[i],index=children.indexOf(child);if(index===-1&&child instanceof Transform2D){child.parent&&child.parent.remove(child),child.parent=this,children.push(child),root=this;while(!!root.parent)root=root.parent;child.root=root,child.trigger("add"),this.trigger("addChild",child)}}return this},Transform2D.prototype.remove=function(){var children=this.children,child,index,i,il;for(i=0,il=arguments.length;i<il;i++){child=arguments[i],index=children.indexOf(child);if(index!==-1){children.splice(index,1),child.parent=undefined,root=this;while(!!root.parent)root=root.parent;child.root=root,child.trigger("remove"),this.trigger("removeChild",child)}}return this},Transform2D.prototype.localToWorld=function(v){return v.applyMat3(this.matrixWorld)},Transform2D.prototype.worldToLocal=function(){var mat=new Mat3;return function(v){return v.applyMat3(mat.getInverse(this.matrixWorld))}}(),Transform2D.prototype.applyMat3=function(){var mat=new Mat3;return function(matrix){this.matrix.mmul(matrix,this.matrix),this.scale.getScaleMat3(this.matrix),mat.identity().extractRotation(this.matrix),this.local.rotation=mat.getRotation(),this.position.getPositionMat3(this.matrix)}}(),Transform2D.prototype.translate=function(){var vec=new Vec2,mat=new Mat3;return function(translation,relativeTo){vec.copy(translation),relativeTo instanceof Transform2D?mat.setRotationAngle(relativeTo.rotation):Utils.isNumber(relativeTo)&&mat.setRotationAngle(relativeTo),!relativeTo||vec.applyMat3(mat),this.position.add(vec)}}(),Transform2D.prototype.rotate=function(angle){this.rotation+=angle},Transform2D.prototype.scale=function(){var vec=new Vec2,mat=new Mat3;return function(scale,relativeTo){vec.copy(scale),relativeTo instanceof Transform2D?mat.setRotationAngle(relativeTo.rotation):Utils.isNumber(relativeTo)&&mat.setRotationAngle(relativeTo),!relativeTo||vec.applyMat3(mat),this.scale.add(vec)}}(),Transform2D.prototype.rotateAround=function(){var point=new Vec2;return function(point,angle){point.copy(point).sub(this.position),this.translate(point),this.rotate(angle),this.translate(point.inverse(),angle)}}(),Transform2D.prototype.lookAt=function(){var vec=new Vec2,mat=new Mat3;return function(target){target instanceof Transform2D?vec.copy(target.position):vec.copy(target),mat.lookAt(this.position,vec),this.rotation=mat.getRotation()}}(),Transform2D.prototype.follow=function(){var vec=new Vec2;return function(target,damping,relativeTo){damping=damping>0?damping:1,target instanceof Transform3D?vec.sub(target.position,this.position):target instanceof Vec2&&vec.sub(target,this.position),vec.lenSq()>.1&&this.translate(vec.smul(1/damping),relativeTo)}}(),Transform2D.prototype.updateMatrices=function(){var scale=this.scale,matrix=this.matrix,matrixWorld=this.matrixWorld;matrix.setRotationAngle(this.rotation),(scale.x!==1||scale.y!==1)&&matrix.scale(scale),matrix.setPositionVec2(this.position),this.root===this?matrixWorld.copy(matrix):matrixWorld.mmul(this.parent.matrixWorld,matrix)},Transform2D}),define("core/shader/fragmentshader",["require"],function(require){var fragmentTextureUniforms=function(opts){return[opts.diffuseMap?"uniform sampler2D uDiffuseMap;":"",opts.alphaMap?"uniform sampler2D uAlphaMap;":"",opts.shading&&opts.specularMap?"uniform sampler2D uSpecularMap;":"",opts.shading&&opts.emitMap?"uniform sampler2D uEmitMap;":"",opts.shading&&opts.normalMap?"uniform sampler2D uNormalMap;":""].join("\n")},fragmentShadingUniforms=function(opts){return["uniform mat4 uMatrixView;",opts.specularMap?"":"uniform vec3 uSpecular;","uniform vec3 uAmbient;","uniform float uHardness;","uniform float uEmissive;",opts.pointLights>0?"uniform vec3 uPointLight_position["+opts.pointLights+"];":"",opts.pointLights>0?"uniform vec3 uPointLight_color["+opts.pointLights+"];":"",opts.pointLights>0?"uniform vec3 uPointLight_attenuation["+opts.pointLights+"];":"",opts.dirLights>0?"uniform vec3 uDirLight_direction["+opts.dirLights+"];":"",opts.dirLights>0?"uniform vec3 uDirLight_color["+opts.dirLights+"];":"",opts.spotLights>0?"uniform vec3 uSpotLight_direction["+opts.spotLights+"];":"",opts.spotLights>0?"uniform vec3 uSpotLight_position["+opts.spotLights+"];":"",opts.spotLights>0?"uniform vec3 uSpotLight_color["+opts.spotLights+"];":"",opts.hemiLights>0?"uniform vec3 uHemiLight_direction["+opts.hemiLights+"];":"",opts.hemiLights>0?"uniform vec3 uHemiLight_color["+opts.hemiLights+"];":""].join("\n")},fragmentLighting=function(opts){return["vec3 lightPos, normal, distance, lightDir, eyeDir, reflectDir, difLight, specLight;","float d, att;",opts.normalMap?"normal = normalize( texture2D( uNormalMap, vVertexUv ).xyz * 2.0 - 1.0 );":"",opts.normalMap&&opts.tangents?"mat3 tsb = mat3( normalize( vVertexTangent ), normalize( vVertexBinormal ), normalize( vVertexNormal ) );":"",opts.normalMap&&opts.tangents?"normal = tsb * normal;":"",opts.normalMap?"":"normal = normalize( vVertexNormal );","eyeDir = normalize( -vVertexPosition );",opts.pointLights>0?fragmentPointLights(opts):"",opts.dirLights>0?fragmentDirLights(opts):"",opts.hemiLights>0?fragmentHemiLights(opts):"","finalLight += uAmbient + uEmissive;"].join("\n")},fragmentPointLights=function(opts){return["for( int i = 0; i < "+opts.pointLights+"; i++ ){","lightPos = vec3( uMatrixView * vec4( uPointLight_position[i], 1.0 ) );","distance = lightPos - vVertexPosition;","lightDir = normalize( distance );","d = length( distance );","att = 1.0 / ( uPointLight_attenuation[i].x + ( uPointLight_attenuation[i].y * d ) + ( uPointLight_attenuation[i].z * d * d ) );","reflectDir = reflect( -lightDir, normal );","diffuseLight += att * uPointLight_color[i] * max( dot( lightDir, normal ), 0.0 );","specularLight += att * uPointLight_color[i] * pow( max( dot( reflectDir, eyeDir ), 0.0 ), uHardness );","}"].join("\n")},fragmentDirLights=function(opts){return["for( int i = 0; i < "+opts.dirLights+"; i++ ){","lightDir = normalize( vec3( uMatrixView * vec4( uDirLight_direction[i], 0.0 ) ) );","reflectDir = reflect( -lightDir, normal );","diffuseLight += uDirLight_color[i] * max( dot( lightDir, normal ), 0.0 );","specularLight += uDirLight_color[i] * pow( max( dot( reflectDir, eyeDir ), 0.0 ), uHardness );","}"].join("\n")},fragmentHemiLights=function(opts){return["for( int i = 0; i < "+opts.hemiLights+"; i++ ){","lightDir = normalize( vec3( uMatrixView * vec4( uHemiLight_direction[i], 0.0 ) ) );","reflectDir = reflect( -lightDir, normal );","diffuseLight += uHemiLight_color[i] * max( 0.5 * dot( lightDir, normal ) + 0.5, 0.0 );","specularLight += uHemiLight_color[i] * pow( max( 0.5 * dot( reflectDir, eyeDir ) + 0.5, 0.0 ), uHardness );","}"].join("\n")},FragmentShader=function(opts){return[opts.standard_derivatives&&(opts.bumpMap||opts.normalMap)?"#extension GL_OES_standard_derivatives : enable":"","precision "+opts.precision+" float;",opts.shading?"varying vec3 vVertexPosition;":"",opts.textures?"varying vec2 vVertexUv;":"",!opts.textures&&opts.vertexColors?"varying vec3 vVertexColor;":"",opts.shading?"varying vec3 vVertexNormal;":"",opts.shading&&opts.tangents?"varying vec3 vVertexTangent;":"",opts.shading&&opts.tangents?"varying vec3 vVertexBinormal;":"","uniform float uAlpha;",!opts.vertexColors&&!opts.diffuseMap?"uniform vec3 uDiffuse;":"",!opts.vertexColors&&opts.textures?fragmentTextureUniforms(opts):"",opts.shading?fragmentShadingUniforms(opts):"","void main(){",!opts.vertexColors&&!opts.diffuseMap?"vec3 finalColor = uDiffuse;":"",opts.vertexColors&&!opts.diffuseMap?"vec3 finalColor = vVertexColor;":"",opts.diffuseMap?"vec3 finalColor = texture2D( uDiffuseMap, vVertexUv ).xyz;":"",opts.diffuseMapAlpha&&!opts.alphaMap?"float finalAlpha = texture2D( uDiffuseMap, vVertexUv ).w;":"",!opts.diffuseMapAlpha&&opts.alphaMap?"float finalAlpha = length( texture2D( uAlphaMap, vVertexUv ).xyz );":"",!opts.diffuseMapAlpha&&!opts.alphaMap?"float finalAlpha = uAlpha;":"",opts.shading?"vec3 finalLight, diffuseLight, specularLight;":"",opts.shading&&opts.specularMap?"vec3 specMap = texture2D( uSpecularMap, vVertexUv ).xyz;":"",opts.shading&&opts.emitMap?"vec3 emitMap = texture2D( uEmitMap, vVertexUv ).xyz;":"",opts.shading?fragmentLighting(opts):"",opts.shading&&opts.specularMap?"specularLight *= specMap;":"",opts.shading&&!opts.specularMap?"specularLight *= uSpecular;":"",opts.shading&&opts.emitMap?"diffuseLight += emitMap;":"",opts.shading?"finalLight += diffuseLight + specularLight;":"",opts.shading?"gl_FragColor = vec4( finalColor * finalLight, finalAlpha );":"gl_FragColor = vec4( finalColor, finalAlpha );","}"].join("\n")};return FragmentShader}),define("core/shader/vertexshader",["require"],function(require){var VertexShader=function(opts){return["precision "+opts.precision+" float;","uniform mat4 uMatrixProjection;",opts.shading?"":"uniform mat4 uMatrixModelView;",opts.shading?"uniform mat4 uMatrixView;":"",opts.shading?"uniform mat4 uMatrixModel;":"",opts.shading?"uniform mat3 uMatrixNormal;":"","attribute vec3 aVertexPosition;",opts.textures?"attribute vec2 aVertexUv;":"",opts.vertexColors?"attribute vec3 aVertexColor;":"",opts.shading?"attribute vec3 aVertexNormal;":"",opts.shading&&opts.tangents?"attribute vec4 aVertexTangent;":"",opts.shading?"varying vec3 vVertexPosition;":"",opts.textures?"varying vec2 vVertexUv;":"",!opts.textures&&opts.vertexColors?"varying vec3 vVertexColor;":"",opts.shading?"varying vec3 vVertexNormal;":"",opts.shading&&opts.tangents?"varying vec3 vVertexTangent;":"",opts.shading&&opts.tangents?"varying vec3 vVertexBinormal;":"","void main(){",opts.vertexColors?"vVertexColor = aVertexColor;":"",opts.shading?"vVertexNormal = uMatrixNormal * aVertexNormal;":"",opts.shading&&opts.tangents?"vVertexTangent = normalize( uMatrixNormal * aVertexTangent.xyz );":"",opts.shading&&opts.tangents?"vVertexBinormal = normalize( cross( vVertexNormal, vVertexTangent ) * aVertexTangent.w );":"",opts.textures?"vVertexUv = aVertexUv.st;":"",opts.shading?"vVertexPosition = vec3( uMatrixView * uMatrixModel * vec4( aVertexPosition, 1.0 ) );":"",opts.shading?"gl_Position = uMatrixProjection * vec4( vVertexPosition, 1.0 );":"",opts.shading?"":"gl_Position = uMatrixProjection * uMatrixModelView * vec4( aVertexPosition, 1.0 );","}"].join("\n")};return VertexShader});if(typeof define!="function")var define=require("amdefine")(module);define("core/assets",["base/class","base/utils","core/geometry/geometry"],function(Class,Utils,Geometry){var init=!1;function Assets(){Class.call(this),this.resources={},this.loaded=0,this.total=0}return Assets.prototype=Object.create(Class.prototype),Assets.prototype.constructor=Assets,Assets.prototype.loadAll=function(sources){var key,source,name;if(sources)if(Utils.isArray(sources))for(key in sources)source=sources[key],this.load(source);else for(key in sources)source=sources[key],this.load(source,key);else this.trigger("done");return this},Assets.prototype.get=function(name){return this.resources[name]},Assets.prototype.load=function(url,name,force){var file=url.toLowerCase().split("/").pop(),ext=file.split(".").pop();force=force?!0:!1,name=name||file.substr(0,file.lastIndexOf("."));if(!force&&this.resources[name])return console.warn("Assets.load: "+name+" is already used"),this;switch(ext){case"png":case"jpg":case"jpeg":this._loadImage(name,url);break;case"json":case"js":this._loadGeometry(name,url);break;default:console.warn("Assets.init: error loading asset "+name+": file type ."+ext+" is not supported")}return this},Assets.prototype._loadImage=function(name,url){var img=new Image,self=this;return this.total++,img.addEventListener("load",function(e){self.resources[name]=img,self.loaded++,self.trigger("imageLoad",url,name),self._checkProgress()},!1),img.addEventListener("error",function(){console.warn("Assets.load: image "+name+": 404 ( Not Found )"),self.loaded--,self.total--,self.trigger("imageLoadError",url,name),self._checkProgress()},!1),img.src=url,this},Assets.prototype._loadGeometry=function(name,url){var geometry=new Geometry,self=this,i,j,item,vertex;return this._loadJSON(url,function(data){if(data.vertices&&data.vertices.length)for(i=0;i<data.vertices.length;i+=3)item=data.vertices,geometry.vertices.push(new Vec3(item[i],item[i+1],item[i+2]));if(data.uv&&data.uv.length)for(i=0;i<data.uv.length;i+=2)item=data.uv,geometry.uv.push(new Vec2(item[i],item[i+1]));if(data.colors&&data.colors.length)for(i=0;i<data.colors.length;i+=3)item=data.colors,geometry.colors.push(new Vec3(item[i],item[i+1],item[i+2]));if(data.faces&&data.faces.length)for(i=0;i<data.faces.length;i+=3)item=data.faces,geometry.faces.push(new Face(item[i],item[i+1],item[i+2]));if(data.normals&&data.normals.length)for(i=0;i<data.normals.length;i+=3)item=data.normals,geometry.normals.push(new Vec3(item[i],item[i+1],item[i+2]));else geometry.calculateNormals();self.resources[name]=geometry,self._checkProgress()}),this},Assets.prototype._checkProgress=function(){return this.loaded>=this.total&&!init&&(this.trigger("done"),init=!0),this},Assets.prototype._loadJSON=function(url,callback){var request=new XMLHttpRequest;return request.onreadystatechange=function(){request.readyState===1&&request.send(),request.readyState===4&&(request.status===404?console.warn("file does not exist"):callback(JSON.parse(request.responseText)))},request.open("GET",url,!0),this},new Assets});if(typeof define!="function")var define=require("amdefine")(module);define("core/canvas",["base/class","base/utils","base/device"],function(Class,Utils,Device){var addMeta=Utils.addMeta,addEvent=Utils.addEvent;function Canvas(width,height){Class.call(this),this.viewportId="viewport"+this._id,addMeta(this.viewportId,"viewport","initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"),addMeta(this.viewportId+"-width","viewport","width=device-width"),addMeta(this.viewportId+"-height","viewport","height=device-height"),addMeta(undefined,"apple-mobile-web-app-status-bar-style","black"),addMeta(undefined,"apple-mobile-web-app-capable","yes");var element=document.createElement("canvas");this.element=element,!width&&!height?(this.fullScreen=!0,this.width=window.innerWidth,this.height=window.innerHeight):(this.width=width!==undefined?width:960,this.height=height!==undefined?height:640),element.style.position="absolute",element.style.left="50%",element.style.top="50%",element.style.padding="0px",element.style.margin="0px",element.marginLeft=-this.width*.5+"px",element.marginTop=-this.height*.5+"px",element.style.width=Math.floor(this.width)+"px",element.style.height=Math.floor(this.height)+"px",element.width=this.width,element.height=this.height,this.aspect=this.width/this.height,element.oncontextmenu=function(){return!1},document.body.appendChild(element),this.handleResize(),addEvent(window,"resize orientationchange",this.handleResize,this)}return Canvas.prototype=Object.create(Class.prototype),Canvas.prototype.constructor=Canvas,Canvas.prototype.set=function(width,height){if(!width||!height){console.warn("Canvas.set: no width and or height specified using default width and height");return}width=width,height=height,this.width=width,this.height=height,this.aspect=this.width/this.height,this.handleResize()},Canvas.prototype.handleResize=function(){var element=this.element,elementStyle=element.style,w=window.innerWidth,h=window.innerHeight,pixelRatio=Device.pixelRatio,aspect=w/h,width,height,id="#"+this.viewportId,viewportScale=document.querySelector(id).getAttribute("content");this.fullScreen?(width=w,height=h,this.width=element.width=width,this.height=element.height=height,this.aspect=width/height):aspect>=this.aspect?(width=h*this.aspect,height=h):(width=w,height=w/this.aspect),elementStyle.width=Math.floor(width)+"px",elementStyle.height=Math.floor(height)+"px",elementStyle.marginLeft=-width*.5+"px",elementStyle.marginTop=-height*.5+"px",document.querySelector(id).setAttribute("content",viewportScale.replace(/-scale\s*=\s*[.0-9]+/g,"-scale="+pixelRatio)),document.querySelector(id+"-width").setAttribute("content","width="+w),document.querySelector(id+"-height").setAttribute("content","height="+h),window.scrollTo(0,0),this.trigger("resize")},Canvas});if(typeof define!="function")var define=require("amdefine")(module);define("core/world",["base/class","base/utils","base/time","math/mathf","math/color","math/vec3"],function(Class,Utils,Time,Mathf,Color,Vec3){function World(opts){opts||(opts={}),Class.call(this),this.name=opts.name||this._class+"-"+this._id,this.background=opts.background instanceof Color?opts.background:new Color(.5,.5,.5,1),this.ambient=opts.ambient instanceof Color?opts.ambient:new Color(.1,.1,.1,1),this.steps=opts.steps!==undefined?opts.steps:10,this.allowSleep=opts.allowSleep!==undefined?opts.allowSleep:!0,this.gravity=opts.gravity instanceof Vec3?opts.gravity:new Vec3(0,0,-9.801)}return World.prototype=Object.create(Class.prototype),World.prototype.constructor=World,World.prototype.add=function(body){},World.prototype.remove=function(body){},World.prototype.update=function(){},World});if(typeof define!="function")var define=require("amdefine")(module);define("core/scene",["base/class","base/utils","core/world"],function(Class,Utils,World){function Scene(opts){opts||(opts={}),Class.call(this),this.name=opts.name||this._class+"-"+this._id,this.children=[],this._cameras=[],this._meshes=[],this._pointLights=[],this._directionalLights=[],this._spotLights=[],this._hemiLights=[],this.camera=undefined,this.world=opts.world instanceof World?opts.world:new World,this.add.apply(this,opts.children)}return Scene.prototype=Object.create(Class.prototype),Scene.prototype.constructor=Scene,Scene.prototype.setCamera=function(camera){var component,index;camera instanceof Camera?(index=this.children.indexOf(camera.gameObject),index===-1&&(console.warn("Scene.setCamera: camera not added to Scene, adding it..."),this.add(camera.gameObject)),component=camera):camera instanceof GameObject?(index=this.children.indexOf(camera),index===-1&&(console.warn("Scene.setCamera: camera's gameObject is not added to Scene, adding it..."),this.add(camera)),component=camera.getComponent("Camera")):Utils.isString(camera)&&(component=this.findByName(camera).getComponent("Camera")),component?this.camera=component:console.warn("Scene.setCamera: no camera found "+camera)},Scene.prototype.forEach=function(callback){var children=this.children,i,il;for(i=0,il=children.length;i<il;i++)callback(children[i])},Scene.prototype.add=function(){var children=this.children,child,index,i,il;for(i=0,il=arguments.length;i<il;i++)child=arguments[i],index=children.indexOf(child),index===-1?child instanceof GameObject?(child.scene=this,children.push(child),child.children.length>0&&this.add.apply(this,child.children),this._add(child),child.trigger("addToScene"),this.trigger("addGameObject",child),child.init()):console.warn("Scene.add: Object is not an instance of GameObject"):console.warn("Scene.add: "+child.name+" is already added to scene")},Scene.prototype.remove=function(){var children=this.children,child,index,i,il;for(i=0,il=arguments.length;i<il;i++)child=arguments[i],index=children.indexOf(child),index!==-1?(child.scene=undefined,children.splice(index,1),child.children.length>0&&this.remove.apply(this,child.children),this._remove(child),child.trigger("removeFromScene"),this.trigger("removeGameObject",child)):console.warn("Scene.remove: "+child+" is not within this scene")},Scene.prototype._add=function(gameObject){var mesh=gameObject.getComponent("Mesh"),light=gameObject.getComponent("Light"),camera=gameObject.getComponent("Camera"),index;mesh&&(this._meshes.push(mesh),this._meshes.sort(this.sortGeometries));if(light)switch(light.type){case Light.point:this._pointLights.push(light);break;case Light.directional:this._directionalLights.push(light);break;case Light.spot:this._spotLights.push(light);break;case Light.hemi:this._hemiLights.push(light)}camera&&(this.camera||this.setCamera(camera),this._cameras.push(camera))},Scene.prototype._remove=function(gameObject){var mesh=gameObject.getComponent("Mesh"),light=gameObject.getComponent("Light"),camera=gameObject.getComponent("Camera"),index,addedIndex;mesh&&(index=this._meshes.indexOf(mesh),this._meshes.splice(index,1),this._meshes.sort(this.sortGeometries));if(light)switch(light.type){case Light.point:index=this._pointLights.indexOf(light),this._pointLights.splice(index,1);break;case Light.directional:index=this._directionalLights.indexOf(light),this._directionalLights.splice(index,1);break;case Light.spot:index=this._spotLights.indexOf(light),this._spotLights.splice(index,1);break;case Light.hemi:index=this._hemiLights.indexOf(light),this._hemiLights.splice(index,1)}camera&&(index=this._cameras.indexOf(camera),this._cameras.splice(index,1))},Scene.prototype.sortGeometries=function(a,b){return a.geometry===b.geometry?1:-1},Scene.prototype.findByTag=function(tag,results){results=results||[];var children=this.children,child,i,il;for(i=0,il=children.length;i<il;i++)child=children[i],child.hasTag(tag)&&results.push(child);return results},Scene.prototype.findByName=function(name){var children=this.children,child,i,il;for(i=0,il=children.length;i<il;i++){child=children[i];if(child.name===name)return child}return undefined},Scene.prototype.update=function(){var children=this.children,i,il;this.trigger("update");for(i=0,il=children.length;i<il;i++)children[i].update();this.trigger("update")},Scene});if(typeof define!="function")var define=require("amdefine")(module);define("core/renderer",["base/class","base/utils","base/device","core/canvas","math/color","math/vec3","math/mat4","core/components/light","core/material/material","core/shader/fragmentshader","core/shader/vertexshader"],function(Class,Utils,Device,Canvas,Color,Vec3,Mat4,Light,Material,FragmentShader,VertexShader){function Renderer(opts){opts||(opts={}),Class.call(this),this.canvas=opts.canvas instanceof Canvas?opts.canvas:new Canvas(opts.width,opts.height),this.autoClear=opts.autoClear!==undefined?opts.autoClear:!0,this.context=Device.getWebGLContext(this.canvas.element,opts.attributes),this.stats={vertices:0,faces:0,calls:0},this.ext={texture_filter_anisotropic:undefined,texture_float:undefined,standard_derivatives:undefined,compressed_texture_s3tc:undefined},this.gpu={precision:"highp",maxAnisotropy:16,maxTextures:16,maxTextureSize:16384,maxCubeTextureSize:16384,maxRenderBufferSize:16384},this.getExtensions(),this.getGPUCapabilities(),this.setDefault()}return Renderer.prototype=Object.create(Class.prototype),Renderer.prototype.constructor=Renderer,Renderer.prototype.getExtensions=function(){var gl=this.context,ext=this.ext,texture_filter_anisotropic=gl.getExtension("EXT_texture_filter_anisotropic")||gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),compressed_texture_s3tc=gl.getExtension("WEBGL_compressed_texture_s3tc")||gl.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),standard_derivatives=gl.getExtension("OES_standard_derivatives"),texture_float=gl.getExtension("OES_texture_float");ext.texture_filter_anisotropic=texture_filter_anisotropic,ext.standard_derivatives=standard_derivatives,ext.texture_float=texture_float,ext.compressed_texture_s3tc=compressed_texture_s3tc},Renderer.prototype.getGPUCapabilities=function(){var gl=this.context,gpu=this.gpu,ext=this.ext,VERTEX_SHADER=gl.VERTEX_SHADER,FRAGMENT_SHADER=gl.FRAGMENT_SHADER,HIGH_FLOAT=gl.HIGH_FLOAT,MEDIUM_FLOAT=gl.MEDIUM_FLOAT,LOW_FLOAT=gl.LOW_FLOAT,maxAnisotropy=ext.texture_filter_anisotropic?gl.getParameter(ext.texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,maxTextures=gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS),maxTextureSize=gl.getParameter(gl.MAX_TEXTURE_SIZE),maxCubeTextureSize=gl.getParameter(gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderBufferSize=gl.getParameter(gl.MAX_RENDERBUFFER_SIZE),vsHighpFloat=gl.getShaderPrecisionFormat(VERTEX_SHADER,HIGH_FLOAT),vsMediumpFloat=gl.getShaderPrecisionFormat(VERTEX_SHADER,MEDIUM_FLOAT),vsLowpFloat=gl.getShaderPrecisionFormat(VERTEX_SHADER,LOW_FLOAT),fsHighpFloat=gl.getShaderPrecisionFormat(FRAGMENT_SHADER,HIGH_FLOAT),fsMediumpFloat=gl.getShaderPrecisionFormat(FRAGMENT_SHADER,MEDIUM_FLOAT),fsLowpFloat=gl.getShaderPrecisionFormat(FRAGMENT_SHADER,LOW_FLOAT),highpAvailable=vsHighpFloat.precision>0&&fsHighpFloat.precision>0,mediumpAvailable=vsMediumpFloat.precision>0&&fsMediumpFloat.precision>0,precision="highp";if(!highpAvailable||Device.isMobile)mediumpAvailable?precision="mediump":precision="lowp";gpu.precision=precision,gpu.maxAnisotropy=maxAnisotropy,gpu.maxTextures=maxTextures,gpu.maxTextureSize=maxTextureSize,gpu.maxCubeTextureSize=maxCubeTextureSize,gpu.maxRenderBufferSize=maxRenderBufferSize},Renderer.prototype.setDefault=function(){var gl=this.context;gl.clearColor(0,0,0,1),gl.clearDepth(1),gl.clearStencil(0),gl.enable(gl.DEPTH_TEST),gl.depthFunc(gl.LEQUAL),gl.frontFace(gl.CCW),gl.cullFace(gl.BACK),gl.enable(gl.CULL_FACE),gl.enable(gl.BLEND),gl.blendEquation(gl.FUNC_ADD),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)},Renderer.prototype.setClearColor=function(color){var gl=this.context;color?gl.clearColor(color.r,color.g,color.b,color.a):gl.clearColor(0,0,0,1)},Renderer.prototype.clear=function(){var gl=this.context;gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT|gl.STENCIL_BUFFER_BIT)},Renderer.prototype.setBlending=function(){var lastBlending,gl;return function(blending){gl=this.context;if(blending!==lastBlending){switch(blending){case Material.none:gl.disable(gl.BLEND);break;case Material.additive:gl.enable(gl.BLEND),gl.blendEquation(gl.FUNC_ADD),gl.blendFunc(gl.SRC_ALPHA,gl.ONE);break;case Material.subtractive:gl.enable(gl.BLEND),gl.blendEquation(gl.FUNC_ADD),gl.blendFunc(gl.ZERO,gl.ONE_MINUS_SRC_COLOR);break;case Material.multiply:gl.enable(gl.BLEND),gl.blendEquation(gl.FUNC_ADD),gl.blendFunc(gl.ZERO,gl.SRC_COLOR);break;default:gl.enable(gl.BLEND),gl.blendEquationSeparate(gl.FUNC_ADD,gl.FUNC_ADD),gl.blendFuncSeparate(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA,gl.ONE,gl.ONE_MINUS_SRC_ALPHA)}lastBlending=blending}}}(),Renderer.prototype.setDepthTest=function(){var lastDepthTest,gl;return function(depthTest){gl=this.context,depthTest!==lastDepthTest&&(depthTest?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST),lastDepthTest=depthTest)}}(),Renderer.prototype.setDepthWrite=function(){var lastDepthWrite,gl;return function(depthWrite){gl=this.context,depthWrite!==lastDepthWrite&&(gl.depthMask(depthWrite),lastDepthWrite=depthWrite)}}(),Renderer.prototype.setLineWidth=function(){var lastLineWidth,gl;return function(width){gl=this.context,width!==lastLineWidth&&(gl.lineWidth(width),lastLineWidth=width)}}(),Renderer.prototype.clearStats=function(){var stats=this.stats;stats.vertices=0,stats.faces=0,stats.calls=0},Renderer.prototype.render=function(){var lastScene,lastCamera;return function(scene){var gl=this.context,camera=scene.camera,stats=this.stats,meshes=scene._meshes,mesh,gameObject,i,il;this.clearStats(),lastScene!==scene&&(this.setClearColor(scene.world.background),lastScene=scene),lastCamera!==camera&&(camera.setSize(this.canvas.width,this.canvas.height),gl.viewport(0,0,this.canvas.width,this.canvas.height),this.canvas.fullScreen&&this.canvas.on("resize",function(){camera.setSize(this.width,this.height),gl.viewport(0,0,this.width,this.height)}),lastCamera=camera),this.autoClear&&this.clear();for(i=0,il=meshes.length;i<il;i++)mesh=meshes[i],mesh&&mesh.material.visible&&(gameObject=mesh.gameObject,this.setupMatrices(gameObject,camera),this.renderMesh(mesh,camera,scene))}}(),Renderer.prototype.renderMesh=function(){var lastMaterial,lastGeometry,lastProgram;return function(mesh,camera,scene){var gl=this.context,stats=this.stats,gameObject=mesh.gameObject,geometry=mesh.geometry,material=mesh.material,shader=material.shader,program=shader.program;geometry.initBuffers(gl),this.initMeshShader(mesh,scene),lastProgram!==program&&(gl.useProgram(program),lastProgram=program),lastGeometry!==geometry&&(this.bindGeometryBuffers(shader,geometry),lastGeometry=geometry),lastMaterial!==material&&(this.setupMeshMaterial(shader,material,scene.world),lastMaterial=material),this.setupMeshMatrices(shader,gameObject,camera),this.setupMeshLightUniforms(shader,scene),gl.drawElements(gl.TRIANGLES,geometry.faces.length*3,gl.UNSIGNED_SHORT,0),stats.vertices+=geometry.vertices.length,stats.faces+=geometry.faces.length,stats.calls++}}(),Renderer.prototype.setupMatrices=function(){var vec3=new Vec3;return function(gameObject,camera){gameObject.needsUpdate&&(vec3.getPositionMat4(gameObject.matrixWorld),vec3.applyProjection(camera.matrixProjectionScreen),gameObject.z=vec3.z,gameObject.matrixModelView.mmul(camera.matrixWorldInverse,gameObject.matrixWorld),gameObject.matrixNormal.getInverseMat4(gameObject.matrixModelView).transpose(),gameObject.needsUpdate=!1)}}(),Renderer.prototype.bindGeometryBuffers=function(shader,geometry){var gl=this.context,opts=shader.opts,attributes=shader.attributes,buffers=geometry.buffers,name,buffers,ARRAY_BUFFER=gl.ARRAY_BUFFER,ELEMENT_ARRAY_BUFFER=gl.ELEMENT_ARRAY_BUFFER,FLOAT=gl.FLOAT;gl.bindBuffer(ARRAY_BUFFER,buffers.vertices),gl.enableVertexAttribArray(attributes.aVertexPosition),gl.vertexAttribPointer(attributes.aVertexPosition,3,FLOAT,!1,0,0),opts.shading&&!!buffers.normals&&(gl.bindBuffer(ARRAY_BUFFER,buffers.normals),gl.enableVertexAttribArray(attributes.aVertexNormal),gl.vertexAttribPointer(attributes.aVertexNormal,3,FLOAT,!1,0,0)),opts.shading&&opts.normalMap&&opts.tangents&&!!buffers.tangents&&(gl.bindBuffer(ARRAY_BUFFER,buffers.tangents),gl.enableVertexAttribArray(attributes.aVertexTangent),gl.vertexAttribPointer(attributes.aVertexTangent,4,FLOAT,!1,0,0)),!opts.vertexMap&&opts.vertexColors&&!!buffers.colors&&(gl.bindBuffer(ARRAY_BUFFER,buffers.colors),gl.enableVertexAttribArray(attributes.aVertexColor),gl.vertexAttribPointer(attributes.aVertexColor,3,FLOAT,!1,0,0)),opts.textures&&!!buffers.uv&&(gl.bindBuffer(ARRAY_BUFFER,buffers.uv),gl.enableVertexAttribArray(attributes.aVertexUv),gl.vertexAttribPointer(attributes.aVertexUv,2,FLOAT,!1,0,0)),gl.bindBuffer(ELEMENT_ARRAY_BUFFER,buffers.indices)},Renderer.prototype.setupMeshMatrices=function(shader,gameObject,camera){var gl=this.context,opts=shader.opts,uniforms=shader.uniforms;gl.uniformMatrix4fv(uniforms.uMatrixProjection,!1,camera.matrixProjection.elements),opts.shading?(gl.uniformMatrix4fv(uniforms.uMatrixView,!1,camera.matrixWorldInverse.elements),gl.uniformMatrix4fv(uniforms.uMatrixModel,!1,gameObject.matrixWorld.elements),gl.uniformMatrix3fv(uniforms.uMatrixNormal,!1,gameObject.matrixNormal.elements)):gl.uniformMatrix4fv(uniforms.uMatrixModelView,!1,gameObject.matrixModelView.elements)},Renderer.prototype.setupMeshMaterial=function(){var difColor=new Color,specColor=new Color,ambientColor=new Color,gl;function bindTexture(renderer,texture,uniform,index){gl=renderer.context,renderer.initTexture(texture),gl.activeTexture(gl.TEXTURE0+index),gl.bindTexture(gl.TEXTURE_2D,texture.data),gl.uniform1i(uniform,index)}return function(shader,material,world){var gl=this.context,opts=shader.opts,uniforms=shader.uniforms,name,uniform,textureIndex=0;this.setBlending(material.blending),this.setDepthTest(material.depthTest),this.setDepthWrite(material.depthWrite);for(name in uniforms){uniform=uniforms[name];switch(name){case"uAlpha":gl.uniform1f(uniform,material.alpha);break;case"uDiffuse":difColor.copy(material.diffuse),gl.uniform3f(uniform,difColor.r,difColor.g,difColor.b);break;case"uAmbient":ambientColor.copy(world.ambient).smul(material.ambient),gl.uniform3f(uniform,ambientColor.r,ambientColor.g,ambientColor.b);break;case"uSpecular":specColor.copy(material.specular),gl.uniform3f(uniform,specColor.r,specColor.g,specColor.b);break;case"uEmissive":gl.uniform1f(uniform,material.emissive);break;case"uHardness":gl.uniform1f(uniform,material.hardness);break;case"uDiffuseMap":bindTexture(this,material.diffuseMap,uniform,textureIndex),textureIndex++;break;case"uAlphaMap":bindTexture(this,material.alphaMap,uniform,textureIndex),textureIndex++;break;case"uSpecularMap":bindTexture(this,material.specularMap,uniform,textureIndex),textureIndex++;break;case"uEmitMap":bindTexture(this,material.emitMap,uniform,textureIndex),textureIndex++;break;case"uNormalMap":bindTexture(this,material.normalMap,uniform,textureIndex),textureIndex++}}}}(),Renderer.prototype.setupMeshLightUniforms=function(){var matrix=new Mat4,lightPos=new Vec3,lightDir=new Vec3,lightCol=new Color;return function(shader){var gl=this.context,opts=shader.opts,uniforms=shader.uniforms,i,il,light;if(opts.shading){for(i=0,il=scene._pointLights.length;i<il;i++)light=scene._pointLights[i],!light||(lightPos.getPositionMat4(light.gameObject.matrixWorld),lightCol.copy(light.color).smul(light.energy),gl.uniform3f(uniforms.uPointLight_position[i],lightPos.x,lightPos.y,lightPos.z),gl.uniform3f(uniforms.uPointLight_attenuation[i],light.constant,light.linear,light.quadratic),gl.uniform3f(uniforms.uPointLight_color[i],lightCol.r,lightCol.g,lightCol.b));for(i=0,il=scene._directionalLights.length;i<il;i++)light=scene._directionalLights[i],!light||(lightDir.set(0,0,1),lightDir.applyMat4(matrix.extractRotation(light.gameObject.matrixWorld)),lightCol.copy(light.color).smul(light.energy),gl.uniform3f(uniforms.uDirLight_direction[i],lightDir.x,lightDir.y,lightDir.z),gl.uniform3f(uniforms.uDirLight_color[i],lightCol.r,lightCol.g,lightCol.b));for(i=0,il=scene._hemiLights.length;i<il;i++)light=scene._hemiLights[i],!light||(lightDir.set(0,0,1),lightDir.applyMat4(matrix.extractRotation(light.gameObject.matrixWorld)),lightCol.copy(light.color).smul(light.energy),gl.uniform3f(uniforms.uHemiLight_direction[i],lightDir.x,lightDir.y,lightDir.z),gl.uniform3f(uniforms.uHemiLight_color[i],lightCol.r,lightCol.g,lightCol.b))}}}(),Renderer.prototype.initEnvironment=function(texture){if(texture.needsUpdate)var gl=this.context},Renderer.prototype.initTexture=function(texture){if(texture.needsUpdate){var gl=this.context,ext=this.ext,gpu=this.gpu,wrap,format,magFilter=gl.LINEAR,minFilter=texture.mipMap?gl.LINEAR_MIPMAP_NEAREST:gl.LINEAR,anisotropy=Math.min(gpu.maxAnisotropy,texture.anisotropy);switch(texture.wrap){case Texture.repeat:wrap=gl.REPEAT;case Texture.clamp:wrap=gl.CLAMP_TO_EDGE}switch(texture.format){case Texture.rgb:format=gl.RGB;case Texture.rgba:format=gl.RGBA}texture.data=texture.data||gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,texture.data),texture.flipY&&gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),gl.texImage2D(gl.TEXTURE_2D,0,format,format,gl.UNSIGNED_BYTE,texture.image),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,magFilter),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,minFilter),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,wrap),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,wrap),!ext.texture_filter_anisotropic||gl.texParameterf(gl.TEXTURE_2D,ext.texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,anisotropy),texture.mipMap&&gl.generateMipmap(gl.TEXTURE_2D),gl.bindTexture(gl.TEXTURE_2D,null),texture.needsUpdate=!1}},Renderer.prototype.initMeshShader=function(){var shaders=[];return function(mesh,scene){var material=mesh.material;if(material.needsUpdate){var gl=this.context,geometry=mesh.geometry,shader=material.shader,opts=shader.opts,used=!1,other,i,il;this.getShaderOpts(material,geometry,scene),shader.vertex=VertexShader(opts),shader.fragment=FragmentShader(opts),shader.src=shader.vertex+"\n"+shader.fragment;for(i=0,il=shaders.length;i<il;i++)other=shaders[i],shader.src===other.src?(other.used++,shader.program=other.program,used=!0):used=!1;used||(shader.program=Device.createProgram(gl,shader.vertex,shader.fragment),shader.used++,shaders.push(shader)),this.parseUniformsAttributes(shader),material.needsUpdate=!1}}}(),Renderer.prototype.parseUniformsAttributes=function(){var rAttribute=/attribute\s+([a-z]+\s+)?([A-Za-z0-9]+)\s+([a-zA-Z_0-9]+)\s*(\[\s*(.+)\s*\])?/,rUniform=/uniform\s+([a-z]+\s+)?([A-Za-z0-9]+)\s+([a-zA-Z_0-9]+)\s*(\[\s*(.+)\s*\])?/;return function(shader){var gl=this.context,src=shader.src,lines=src.split("\n"),line,i,il,j,jl,matchAttributes,matchUniforms,name,length;for(i=0,il=lines.length;i<il;i++){line=lines[i],matchAttributes=line.match(rAttribute),matchUniforms=line.match(rUniform),!matchAttributes||(name=matchAttributes[3],shader.attributes[name]=gl.getAttribLocation(shader.program,name));if(!!matchUniforms){name=matchUniforms[3],length=parseInt(matchUniforms[5]);if(!length)shader.uniforms[name]=gl.getUniformLocation(shader.program,name);else{shader.uniforms[name]=[];for(j=0,jl=length;j<jl;j++)shader.uniforms[name][j]=gl.getUniformLocation(shader.program,name+"["+j+"]")}}}}}(),Renderer.prototype.getShaderOpts=function(material,geometry,scene){var gl=this.context,opts=material.shader.opts;opts.precision=this.gpu.precision,opts.standard_derivatives=!!this.ext.standard_derivatives,opts.vertexColors=material.vertexColors,opts.textures=!!material.diffuseMap||!!material.alphaMap||!!material.specularMap||!!material.emitMap||!!material.environment,opts.diffuseMap=!!material.diffuseMap,opts.diffuseMapAlpha=material.useDiffuseMapAlpha,opts.alphaMap=!!material.alphaMap,opts.specularMap=!!material.specularMap,opts.emitMap=!!material.emitMap,opts.normalMap=!!material.normalMap&&!Device.isMobile,opts.environmentMap=!!material.environment,opts.pointLights=scene._pointLights.length,opts.dirLights=scene._directionalLights.length,opts.spotLights=scene._spotLights.length,opts.hemiLights=scene._hemiLights.length,opts.shading=material.shading&&!Device.isMobile,opts.tangents=!!geometry.tangents.length&&!Device.isMobile,opts.vertexColor=!!geometry.colors.length&&material.vertexColors},Renderer});if(typeof define!="function")var define=require("amdefine")(module);define("core/game",["base/class","base/time","base/utils","core/input/input","core/assets","core/scene","core/renderer"],function(Class,Time,Utils,Input,Assets,Scene,Renderer){var addEvent=Utils.addEvent,floor=Math.floor;function Game(opts){opts||(opts={}),Class.call(this),this.name=opts.name||this._class+"-"+this._id,this.scenes=[],this.scene=undefined,this.renderer=new Renderer(opts),Input.init(this.renderer.canvas.element),this.listenTo(Assets,"done",this.init,this),Assets.loadAll(opts.sources),this.addScene.apply(this,opts.scenes),this.pause=!1,addEvent(window,"focus",this.handleFocus,this),addEvent(window,"blur",this.handleBlur,this)}return Game.prototype=Object.create(Class.prototype),Game.prototype.constructor=Game,Game.prototype.init=function(){this.trigger("init"),this.animate()},Game.prototype.setScene=function(scene){var index,newScene;scene instanceof Scene?(index=this.scenes.indexOf(scene),index===-1&&(console.warn("Game.setScene: scene not added to Game, adding it..."),this.addScene(scene)),newScene=scene):Utils.isString(scene)&&(newScene=this.getScene(scene)),newScene?this.scene=newScene:console.warn("Game.setScene: could not find scene in game "+scene)},Game.prototype.getScene=function(name){var scenes=this.scenes,scene,i,il;for(i=0,il=scenes.length;i<il;i++){scene=scenes[i];if(scene.name===name)return scene}return undefined},Game.prototype.addScene=function(){var scenes=this.scenes,scene,index,i,il;for(i=0,il=arguments.length;i<il;i++)scene=arguments[i],index=scenes.indexOf(scene),index===-1&&scene instanceof Scene&&(scenes.push(scene),scene.game=this,scene.trigger("addToGame"),this.trigger("addScene",scene),this.scene||this.setScene(scene))},Game.prototype.removeScene=function(){var scenes=this.scenes,scene,index,i,il;for(i=0,il=arguments.length;i<il;i++)scene=arguments[i],index=scenes.indexOf(scene),index!==-1&&(scenes.splice(index,1),scene.game=undefined,scene.trigger("removeFromGame"),this.trigger("removeScene",scene),this.scene===scene&&(this.scene=undefined))},Game.prototype.update=function(){var scene=this.scene;Input.update(),this.pause||(Time.start(),this.trigger("update"),scene&&scene.update(),this.trigger("lateUpdate"),Time.end())},Game.prototype.render=function(){var scene=this.scene;scene&&scene.camera&&this.renderer.render(scene)},Game.prototype.animate=function(){var fpsDisplay=document.createElement("p"),fpsSpan=document.createElement("span");return fpsDisplay.style.cssText=["z-index: 1000;","position: absolute;","margin: 0px;","padding: 0px;","color: #ddd;","text-shadow: 1px 1px #333"].join("\n"),fpsDisplay.innerHTML="FPS: ",fpsDisplay.appendChild(fpsSpan),document.body.appendChild(fpsDisplay),function(){fpsSpan.innerHTML=floor(Time.fps),this.update(),this.render(),Device.requestAnimFrame(this.animate.bind(this)),Time.sinceStart=Utils.now()*.001}}(),Game.prototype.handleFocus=function(e){this.trigger("focus",e)},Game.prototype.handleBlur=function(e){this.trigger("blur",e)},Game});if(typeof define!="function")var define=require("amdefine")(module);define("ares",["require","math/bound2","math/bound3","math/color","math/mat3","math/mat4","math/mathf","math/quat","math/vec2","math/vec3","math/vec4","base/class","base/device","base/time","base/utils","core/components/camera","core/components/component","core/components/light","core/components/mesh","core/geometry/geometry","core/geometry/face","core/geometry/primitives/cube","core/geometry/primitives/sphere","core/input/accelerometer","core/input/input","core/input/key","core/input/keyboard","core/input/mouse","core/input/orientation","core/input/touch","core/input/touches","core/material/material","core/material/texture","core/objects/gameobject","core/objects/transform2d","core/objects/transform3d","core/shader/fragmentshader","core/shader/vertexshader","core/assets","core/canvas","core/game","core/renderer","core/scene","core/world"],function(require){var Ares={};return Ares.globalize=function(){for(var key in this)window[key]=this[key];window.Ares=this},Ares.test=function(){var now=Date.now,start,i;return function(name,times,fn){start=now();for(i=0;i<times;i++)fn();console.log(name+": "+(now()-start)+"ms")}}(),Ares.Bound2=require("math/bound2"),Ares.Bound3=require("math/bound3"),Ares.Color=require("math/color"),Ares.Mat3=require("math/mat3"),Ares.Mat4=require("math/mat4"),Ares.Mathf=require("math/mathf"),Ares.Quat=require("math/quat"),Ares.Vec2=require("math/vec2"),Ares.Vec3=require("math/vec3"),Ares.Vec4=require("math/vec4"),Ares.Class=require("base/class"),Ares.Device=require("base/device"),Ares.Time=require("base/time"),Ares.Utils=require("base/utils"),Ares.Camera=require("core/components/camera"),Ares.Component=require("core/components/component"),Ares.Light=require("core/components/light"),Ares.Mesh=require("core/components/mesh"),Ares.Geometry=require("core/geometry/geometry"),Ares.Face=require("core/geometry/face"),Ares.Geometry.Cube=require("core/geometry/primitives/cube"),Ares.Geometry.Sphere=require("core/geometry/primitives/sphere"),Ares.Accelerometer=require("core/input/accelerometer"),Ares.Input=require("core/input/input"),Ares.Key=require("core/input/key"),Ares.Keyboard=require("core/input/keyboard"),Ares.Mouse=require("core/input/mouse"),Ares.Orientation=require("core/input/orientation"),Ares.Touch=require("core/input/touch"),Ares.Touches=require("core/input/touches"),Ares.Material=require("core/material/material"),Ares.Texture=require("core/material/texture"),Ares.GameObject=require("core/objects/gameobject"),Ares.Transform2D=require("core/objects/transform2d"),Ares.Transform3D=require("core/objects/transform3d"),Ares.FragmentShader=require("core/shader/fragmentshader"),Ares.VertexShader=require("core/shader/vertexshader"),Ares.Assets=require("core/assets"),Ares.Canvas=require("core/canvas"),Ares.Game=require("core/game"),Ares.Renderer=require("core/renderer"),Ares.Scene=require("core/scene"),Ares.World=require("core/world"),Ares});