if(typeof define!="function")var define=require("amdefine")(module);define("math/mathf",[],function(){var random=Math.random,floor=Math.floor,abs=Math.abs;function Mathf(){this.PI=3.141592653589793,this.TWO_PI=this.PI*2,this.HALF_PI=this.PI/2,this.EPSILON=1e-6,this.TO_RADS=this.PI/180,this.TO_DEGS=180/this.PI}return Mathf.prototype.acos=Math.acos,Mathf.prototype.asin=Math.asin,Mathf.prototype.atan=Math.atan,Mathf.prototype.atan2=Math.atan2,Mathf.prototype.cos=Math.cos,Mathf.prototype.sin=Math.sin,Mathf.prototype.tan=Math.tan,Mathf.prototype.abs=Math.abs,Mathf.prototype.ceil=Math.ceil,Mathf.prototype.exp=Math.exp,Mathf.prototype.floor=Math.floor,Mathf.prototype.log=Math.log,Mathf.prototype.max=Math.max,Mathf.prototype.min=Math.min,Mathf.prototype.pow=Math.pow,Mathf.prototype.random=Math.random,Mathf.prototype.round=Math.round,Mathf.prototype.sqrt=Math.sqrt,Mathf.prototype.equals=function(a,b){return abs(a-b)<=this.EPSILON},Mathf.prototype.modulo=function(a,b){var r=a%b;return r*b<0?r+b:r},Mathf.prototype.standardRadian=function(t){return this.modulo(t,this.TWO_PI)},Mathf.prototype.standardAngle=function(t){return this.modulo(t,360)},Mathf.prototype.sign=function(t){return t<0?-1:1},Mathf.prototype.clamp=function(t,min,max){return t<min?min:t>max?max:t},Mathf.prototype.clamp01=function(t){return t<0?0:t>1?1:t},Mathf.prototype.lerp=function(a,b,t){return a+(b-a)*this.clamp01(t)},Mathf.prototype.lerpAngle=function(a,b,t){return this.standardRadian(a+(b-a)*this.clamp01(t))},Mathf.prototype.smoothStep=function(t,min,max){return t=(this.clamp01(t)-min)/(max-min),t*t*(3-2*t)},Mathf.prototype.smootherStep=function(t,min,max){return t=(this.clamp01(t)-min)/(max-min),t*t*t*(t*(t*6-15)+10)},Mathf.prototype.pingPong=function(t,length){return length||(length=1),length-abs(t%(2*length)-length)},Mathf.prototype.toRadians=function(x){return this.standardRadian(x*this.TO_RADS)},Mathf.prototype.toDegrees=function(x){return this.standardAngle(x*this.TO_DEGS)},Mathf.prototype.randomRange=function(min,max){return min+random()*(max-min)},Mathf.prototype.randomChoice=function(array){return array[floor(random()*array.length)]},Mathf.prototype.isPowerOfTwo=function(x){return(x&-x)===x},Mathf.prototype.nextPowerOfTwo=function(x){var i=2;while(i<x)i*=2;return i},new Mathf});if(typeof define!="function")var define=require("amdefine")(module);define("math/vec2",["math/mathf"],function(Mathf){var abs=Math.abs,sqrt=Math.sqrt,acos=Math.acos,sin=Math.sin,cos=Math.cos,lerp=Mathf.lerp,clamp=Mathf.clamp,equals=Mathf.equals;function Vec2(x,y){this.x=x||0,this.y=y||0}return Vec2.prototype.clone=function(){return new Vec2(this.x,this.y)},Vec2.prototype.copy=function(other){return this.x=other.x,this.y=other.y,this},Vec2.prototype.set=function(x,y){return this.x=x,this.y=y,this},Vec2.prototype.vadd=function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this},Vec2.prototype.add=function(other){return this.vadd(this,other)},Vec2.prototype.sadd=function(s){return this.x+=s,this.y+=s,this},Vec2.prototype.vsub=function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this},Vec2.prototype.sub=function(other){return this.vsub(this,other)},Vec2.prototype.ssub=function(s){return this.x-=s,this.y-=s,this},Vec2.prototype.vmul=function(a,b){return this.x=a.x*b.x,this.y=a.y*b.y,this},Vec2.prototype.mul=function(other){return this.vmul(this,other)},Vec2.prototype.smul=function(s){return this.x*=s,this.y*=s,this},Vec2.prototype.vdiv=function(a,b){var x=b.x,y=b.y;return x!==0&&y!==0?(this.x=a.x/x,this.y=a.y/y):(this.x=0,this.y=0),this},Vec2.prototype.div=function(other){return this.vdiv(this,other)},Vec2.prototype.sdiv=function(s){return s!==0?(s=1/s,this.x*=s,this.y*=s):(this.x=0,this.y=0),this},Vec2.vdot=Vec2.prototype.vdot=function(a,b){return a.x*b.x+a.y*b.y},Vec2.prototype.dot=function(other){return this.vdot(this,other)},Vec2.prototype.vlerp=function(a,b,t){return this.x=lerp(a.x,b.x,t),this.y=lerp(a.y,b.y,t),this},Vec2.prototype.lerp=function(other,t){return this.vlerp(this,other,t)},Vec2.prototype.vslerp=function(){var start=new Vec2,end=new Vec2,vec=new Vec2,relative=new Vec2;return function(a,b,t){var dot=clamp(Vec3.vdot(a,b),-1,1),theta=acos(dot)*t;return start.copy(a),end.copy(b),vec.copy(start),relative.vsub(end,vec.smul(dot)),relative.norm(),this.vadd(start.smul(cos(theta)),relative.smul(sin(theta)))}}(),Vec2.prototype.slerp=function(other,t){return this.vslerp(this,other,t)},Vec2.prototype.applyMat3=function(m){var x=this.x,y=this.y,me=m.elements;return this.x=me[0]*x+me[3]*y+me[6],this.y=me[1]*x+me[4]*y+me[7],this},Vec2.prototype.applyMat4=function(m){var x=this.x,y=this.y,me=m.elements;return this.x=me[0]*x+me[4]*y+me[8]+me[12],this.y=me[1]*x+me[5]*y+me[9]+me[13],this},Vec2.prototype.applyQuat=function(q){var x=this.x,y=this.y,qx=q.x,qy=q.y,qz=q.z,qw=q.w,ix=qw*x+qy-qz*y,iy=qw*y+qz*x-qx,iz=qw+qx*y-qy*x,iw=-qx*x-qy*y-qz;return this.x=ix*qw+iw*-qx+iy*-qz-iz*-qy,this.y=iy*qw+iw*-qy+iz*-qx-ix*-qz,this},Vec2.prototype.applyProjection=function(m){var x=this.x,y=this.y,me=m.elements,d=1/(me[3]*x+me[7]*y+me[11]+me[15]);return this.x=(me[0]*x+me[4]*y+me[8]+me[12])*d,this.y=(me[1]*x+me[5]*y+me[9]+me[13])*d,this},Vec2.prototype.getPositionMat3=function(m){var me=m.elements;return this.x=me[6],this.y=me[7],this},Vec2.prototype.getPositionMat4=function(m){var me=m.elements;return this.x=me[12],this.y=me[13],this},Vec2.prototype.getScaleMat3=function(m){var me=m.elements,sx=this.set(me[0],me[1]).len(),sy=this.set(me[3],me[4]).len();return this.x=sx,this.y=sy,this},Vec2.prototype.getScaleMat4=function(m){var me=m.elements,sx=this.set(me[0],me[1],me[2]).len(),sy=this.set(me[4],me[5],me[6]).len();return this.x=sx,this.y=sy,this},Vec2.prototype.lenSq=function(){return this.dot(this)},Vec2.prototype.len=function(){return sqrt(this.lenSq())},Vec2.prototype.norm=function(){return this.sdiv(this.len())},Vec2.prototype.setLen=function(len){return this.norm().smul(len)},Vec2.prototype.inverse=function(){return this.smul(-1)},Vec2.prototype.abs=function(){return this.x=abs(this.x),this.y=abs(this.y),this},Vec2.prototype.min=function(other){var x=other.x,y=other.y;return this.x=x<this.x?x:this.x,this.y=y<this.y?y:this.y,this},Vec2.prototype.max=function(other){var x=other.x,y=other.y;return this.x=x>this.x?x:this.x,this.y=y>this.y?y:this.y,this},Vec2.prototype.clamp=function(min,max){return this.x=clamp(this.x,min.x,max.x),this.y=clamp(this.y,min.y,max.y),this},Vec2.distSq=Vec2.prototype.distSq=function(){var dist=new Vec2;return function(a,b){return dist.vsub(a,b).lenSq()}}(),Vec2.dist=Vec2.prototype.dist=function(a,b){return sqrt(Vec2.distSq(a,b))},Vec2.prototype.toString=function(){return"Vec2( "+this.x+", "+this.y+" )"},Vec2.prototype.equals=function(other){return Vec2.equals(this,other)},Vec2.equals=function(a,b){return equals(a.x,b.x)&&equals(a.y,b.y)},Vec2});if(typeof define!="function")var define=require("amdefine")(module);define("math/bound2",["math/vec2"],function(Vec2){var vec2Equals=Vec2.equals;function Bound2(center,size){this.center=center instanceof Vec2?center:new Vec2,this.size=size instanceof Vec2?size:new Vec2,this.extents=(new Vec2).copy(this.size).smul(.5),this.min=(new Vec2).vsub(this.center,this.extents),this.max=(new Vec2).vadd(this.center,this.extents)}return Bound2.prototype.clone=function(){var clone=new Bound2;return clone.copy(this),clone},Bound2.prototype.copy=function(other){return this.center.copy(other.center),this.size.copy(other.size),this.extents.copy(other.extents),this.min.copy(other.min),this.max.copy(other.max),this},Bound2.prototype.set=function(center,size){return this.center.copy(center instanceof Vec2?center:this.center),this.size.copy(size instanceof Vec2?size:this.size),this.extents.copy(this.size).smul(.5),this.min.vsub(this.center,this.extents),this.max.vadd(this.center,this.extents),this},Bound2.prototype.setMinMax=function(min,max){return this.min.copy(min instanceof Vec2?min:this.min),this.max.copy(max instanceof Vec2?max:this.max),this.center.vadd(this.max,this.min).smul(.5),this.size.vsub(this.max,this.min),this.extents.copy(this.size).smul(.5),this},Bound2.prototype.setFromPoints=function(points){var point,i=1,il=points.length;if(il>0){point=points[0],this.min.copy(point),this.max.copy(point);for(i;i<il;i++)point=points[i],point.x<this.min.x?this.min.x=point.x:point.x>this.max.x&&(this.max.x=point.x),point.y<this.min.y?this.min.y=point.y:point.y>this.max.y&&(this.max.y=point.y);this.setMinMax(this.min,this.max)}else this.clear();return this},Bound2.prototype.clear=function(){return this.center.set(0,0,0),this.size.set(0,0,0),this.extents.set(0,0,0),this.min.set(0,0,0),this.max.set(0,0,0),this},Bound2.prototype.expand=function(v){return this.min.sub(v),this.max.add(v),this.setMinMax(this.min,this.max),this},Bound2.prototype.contains=function(point){return point.x<this.min.x||point.x>this.max.x||point.y<this.min.y||point.y>this.max.y?!1:!0},Bound2.prototype.equals=function(other){return Bound2.equals(this,other)},Bound2.equals=function(a,b){return vec2Equals(a.min,b.min)&&vec2Equals(a.max,b.max)},Bound2});if(typeof define!="function")var define=require("amdefine")(module);define("math/vec3",["math/mathf"],function(Mathf){var abs=Math.abs,sqrt=Math.sqrt,lerp=Mathf.lerp,acos=Math.acos,sin=Math.sin,cos=Math.cos,clamp=Mathf.clamp,equals=Mathf.equals;function Vec3(x,y,z){this.x=x||0,this.y=y||0,this.z=z||0}return Vec3.prototype.clone=function(){return new Vec3(this.x,this.y,this.z)},Vec3.prototype.copy=function(other){return this.x=other.x,this.y=other.y,this.z=other.z,this},Vec3.prototype.set=function(x,y,z){return this.x=x,this.y=y,this.z=z,this},Vec3.prototype.vadd=function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this},Vec3.prototype.add=function(other){return this.vadd(this,other)},Vec3.prototype.sadd=function(s){return this.x+=s,this.y+=s,this.z+=s,this},Vec3.prototype.vsub=function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this},Vec3.prototype.sub=function(other){return this.vsub(this,other)},Vec3.prototype.ssub=function(s){return this.x-=s,this.y-=s,this.z-=s,this},Vec3.prototype.vmul=function(a,b){return this.x=a.x*b.x,this.y=a.y*b.y,this.z=a.z*b.z,this},Vec3.prototype.mul=function(other){return this.vmul(this,other)},Vec3.prototype.smul=function(s){return this.x*=s,this.y*=s,this.z*=s,this},Vec3.prototype.vdiv=function(a,b){var x=b.x,y=b.y,z=b.z;return x!==0&&y!==0?(this.x=a.x/x,this.y=a.y/y,this.z=a.z/z):(this.x=0,this.y=0,this.z=0),this},Vec3.prototype.div=function(other){return this.vdiv(this,other)},Vec3.prototype.sdiv=function(s){return s!==0?(s=1/s,this.x*=s,this.y*=s,this.z*=s):(this.x=0,this.y=0,this.z=0),this},Vec3.vdot=Vec3.prototype.vdot=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z},Vec3.prototype.dot=function(other){return this.vdot(this,other)},Vec3.prototype.vlerp=function(a,b,t){return this.x=lerp(a.x,b.x,t),this.y=lerp(a.y,b.y,t),this.z=lerp(a.z,b.z,t),this},Vec3.prototype.lerp=function(other,t){return this.vlerp(this,other,t)},Vec3.prototype.vslerp=function(){var start=new Vec3,end=new Vec3,vec=new Vec3,relative=new Vec3;return function(a,b,t){var dot=clamp(Vec3.vdot(a,b),-1,1),theta=acos(dot)*t;return start.copy(a),end.copy(b),vec.copy(start),relative.vsub(end,vec.smul(dot)),relative.norm(),this.vadd(start.smul(cos(theta)),relative.smul(sin(theta)))}}(),Vec3.prototype.slerp=function(other,t){return this.vslerp(this,other,t)},Vec3.prototype.applyMat3=function(m){var x=this.x,y=this.y,z=this.z,me=m.elements;return this.x=me[0]*x+me[3]*y+me[6]+z,this.y=me[1]*x+me[4]*y+me[7]+z,this.z=me[2]*x+me[5]*y+me[8]+z,this},Vec3.prototype.applyMat4=function(m){var x=this.x,y=this.y,z=this.z,me=m.elements;return this.x=me[0]*x+me[4]*y+me[8]+z*me[12],this.y=me[1]*x+me[5]*y+me[9]+z*me[13],this.z=me[2]*x+me[6]*y+me[10]+z*me[14],this},Vec3.prototype.applyQuat=function(q){var x=this.x,y=this.y,z=this.z,qx=q.x,qy=q.y,qz=q.z,qw=q.w,ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;return this.x=ix*qw+iw*-qx+iy*-qz-iz*-qy,this.y=iy*qw+iw*-qy+iz*-qx-ix*-qz,this.z=iz*qw+iw*-qz+ix*-qy-iy*-qx,this},Vec3.prototype.applyProjection=function(m){var x=this.x,y=this.y,z=this.z,me=m.elements,d=1/(me[3]*x+me[7]*y+me[11]*z+me[15]);return this.x=(me[0]*x+me[4]*y+me[8]*z+me[12])*d,this.y=(me[1]*x+me[5]*y+me[9]*z+me[13])*d,this.z=(me[2]*x+me[6]*y+me[10]*z+me[14])*d,this},Vec3.prototype.getPositionMat3=function(m){var me=m.elements;return this.x=me[6],this.y=me[7],this},Vec3.prototype.getPositionMat4=function(m){var me=m.elements;return this.x=me[12],this.y=me[13],this.z=me[14],this},Vec3.prototype.getScaleMat3=function(m){var me=m.elements,sx=this.set(me[0],me[1]).len(),sy=this.set(me[3],me[4]).len();return this.x=sx,this.y=sy,this.z=1,this},Vec3.prototype.getScaleMat4=function(m){var me=m.elements,sx=this.set(me[0],me[1],me[2]).len(),sy=this.set(me[4],me[5],me[6]).len(),sz=this.set(me[8],me[9],me[10]).len();return this.x=sx,this.y=sy,this.z=sz,this},Vec3.prototype.lenSq=function(){return this.dot(this)},Vec3.prototype.len=function(){return sqrt(this.lenSq())},Vec3.prototype.norm=function(){return this.sdiv(this.len())},Vec3.prototype.setLen=function(len){return this.norm().smul(len)},Vec3.prototype.inverse=function(){return this.smul(-1)},Vec3.prototype.abs=function(){return this.x=abs(this.x),this.y=abs(this.y),this.z=abs(this.z),this},Vec3.prototype.min=function(other){var x=other.x,y=other.y,z=other.z;return this.x=x<this.x?x:this.x,this.y=y<this.y?y:this.y,this.z=z<this.z?z:this.z,this},Vec3.prototype.max=function(other){var x=other.x,y=other.y,z=other.z;return this.x=x>this.x?x:this.x,this.y=y>this.y?y:this.y,this.z=z>this.z?z:this.z,this},Vec3.prototype.clamp=function(min,max){return this.x=clamp(this.x,min.x,max.x),this.y=clamp(this.y,min.y,max.y),this.z=clamp(this.z,min.z,max.z),this},Vec3.distSq=Vec3.prototype.distSq=function(){var dist=new Vec3;return function(a,b){return dist.vsub(a,b).lenSq()}}(),Vec3.dist=Vec3.prototype.dist=function(a,b){return sqrt(Vec3.distSq(a,b))},Vec3.prototype.toString=function(){return"Vec3( "+this.x+", "+this.y+", "+this.z+")"},Vec3.prototype.equals=function(other){return Vec3.equals(this,other)},Vec3.equals=function(a,b){return equals(a.x,b.x)&&equals(a.y,b.y)&&equals(a.z,b.z)},Vec3});if(typeof define!="function")var define=require("amdefine")(module);define("math/bound3",["math/vec3"],function(Vec3){var vec3Equals=Vec3.equals;function Bound3(center,size){this.center=center instanceof Vec3?center:new Vec3,this.size=size instanceof Vec3?size:new Vec3,this.extents=(new Vec3).copy(this.size).smul(.5),this.min=(new Vec3).vsub(this.center,this.extents),this.max=(new Vec3).vadd(this.center,this.extents)}return Bound3.prototype.clone=function(){var clone=new Bound3;return clone.copy(this),clone},Bound3.prototype.copy=function(other){return this.center.copy(other.center),this.size.copy(other.size),this.extents.copy(other.extents),this.min.copy(other.min),this.max.copy(other.max),this},Bound3.prototype.set=function(center,size){return this.center.copy(center instanceof Vec3?center:this.center),this.size.copy(size instanceof Vec3?size:this.size),this.extents.copy(this.size).smul(.5),this.min.vsub(this.center,this.extents),this.max.vadd(this.center,this.extents),this},Bound3.prototype.setMinMax=function(min,max){return this.min.copy(min instanceof Vec3?min:this.min),this.max.copy(max instanceof Vec3?max:this.max),this.center.vadd(this.max,this.min).smul(.5),this.size.vsub(this.max,this.min),this.extents.copy(this.size).smul(.5),this},Bound3.prototype.setFromPoints=function(points){var point,i=1,il=points.length;if(il>0){point=points[0],this.min.copy(point),this.max.copy(point);for(i;i<il;i++)point=points[i],point.x<this.min.x?this.min.x=point.x:point.x>this.max.x&&(this.max.x=point.x),point.y<this.min.y?this.min.y=point.y:point.y>this.max.y&&(this.max.y=point.y),point.z<this.min.z?this.min.z=point.z:point.z>this.max.z&&(this.max.z=point.z);this.setMinMax(this.min,this.max)}else this.clear();return this},Bound3.prototype.clear=function(){return this.center.set(0,0,0),this.size.set(0,0,0),this.extents.set(0,0,0),this.min.set(0,0,0),this.max.set(0,0,0),this},Bound3.prototype.expand=function(v){return this.min.sub(v),this.max.add(v),this.setMinMax(this.min,this.max),this},Bound3.prototype.contains=function(point){return point.x<this.min.x||point.x>this.max.x||point.y<this.min.y||point.y>this.max.y||point.z<this.min.z||point.z>this.max.z?!1:!0},Bound3.prototype.equals=function(other){return Bound3.equals(this,other)},Bound3.equals=function(a,b){return vec3Equals(a.min,b.min)&&vec3Equals(a.max,b.max)},Bound3});if(typeof define!="function")var define=require("amdefine")(module);define("math/vec4",["math/mathf"],function(Mathf){var abs=Math.abs,sqrt=Math.sqrt,acos=Math.acos,sin=Math.sin,cos=Math.cos,lerp=Mathf.lerp,clamp=Mathf.clamp,equals=Mathf.equals;function Vec4(x,y,z,w){this.x=x||0,this.y=y||0,this.z=z||0,this.w=w!==undefined?w:1}return Vec4.prototype.clone=function(){return new Vec4(this.x,this.y,this.z,this.w)},Vec4.prototype.copy=function(other){return this.x=other.x,this.y=other.y,this.z=other.z,this.w=other.w,this},Vec4.prototype.set=function(x,y,z,w){return this.x=x,this.y=y,this.z=z,this.w=w,this},Vec4.prototype.vadd=function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this.w=a.w+b.w,this},Vec4.prototype.add=function(other){return this.vadd(this,other)},Vec4.prototype.sadd=function(s){return this.x+=s,this.y+=s,this.z+=s,this.w+=s,this},Vec4.prototype.vsub=function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this.w=a.w-b.w,this},Vec4.prototype.sub=function(other){return this.vsub(this,other)},Vec4.prototype.ssub=function(s){return this.x-=s,this.y-=s,this.z-=s,this.w-=s,this},Vec4.prototype.vmul=function(a,b){return this.x=a.x*b.x,this.y=a.y*b.y,this.z=a.z*b.z,this.w=a.w*b.w,this},Vec4.prototype.mul=function(other){return this.vmul(this,other)},Vec4.prototype.smul=function(s){return this.x*=s,this.y*=s,this.z*=s,this.w*=s,this},Vec4.prototype.vdiv=function(a,b){var x=b.x,y=b.y,z=b.z;return x!==0&&y!==0?(this.x=a.x/x,this.y=a.y/y,this.z=a.z/z,this.w=a.w/w):(this.x=0,this.y=0,this.z=0,this.w=0),this},Vec4.prototype.div=function(other){return this.vdiv(this,other)},Vec4.prototype.sdiv=function(s){return s!==0?(s=1/s,this.x*=s,this.y*=s,this.z*=s,this.w*=s):(this.x=0,this.y=0,this.z=0,this.w=0),this},Vec4.vdot=Vec4.prototype.vdot=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z+a.w*b.w},Vec4.prototype.dot=function(other){return this.vdot(this,other)},Vec4.prototype.vlerp=function(a,b,t){return this.x=lerp(a.x,b.x,t),this.y=lerp(a.y,b.y,t),this.z=lerp(a.z,b.z,t),this.w=lerp(a.w,b.w,t),this},Vec4.prototype.lerp=function(other,t){return this.vlerp(this,other,t)},Vec4.prototype.vslerp=function(){var start=new Vec4,end=new Vec4,vec=new Vec4,relative=new Vec4;return function(a,b,t){var dot=clamp(Vec4.vdot(a,b),-1,1),theta=acos(dot)*t;return start.copy(a),end.copy(b),vec.copy(start),relative.vsub(end,vec.smul(dot)),relative.norm(),this.vadd(start.smul(cos(theta)),relative.smul(sin(theta)))}}(),Vec4.prototype.slerp=function(other,t){return this.vslerp(this,other,t)},Vec4.prototype.applyMat4=function(m){var x=this.x,y=this.y,z=this.z,me=m.elements;return this.x=me[0]*x+me[4]*y+me[8]*z+me[12]*w,this.y=me[1]*x+me[5]*y+me[9]*z+me[13]*w,this.z=me[2]*x+me[6]*y+me[10]*z+me[14]*w,this.w=me[3]*x+me[7]*y+me[11]*z+me[15]*w,this},Vec4.prototype.applyProjection=function(m){var x=this.x,y=this.y,z=this.z,me=m.elements,d=1/(me[3]*x+me[7]*y+me[11]*z+me[15]);return this.x=(me[0]*x+me[4]*y+me[8]*z+me[12]*w)*d,this.y=(me[1]*x+me[5]*y+me[9]*z+me[13]*w)*d,this.z=(me[2]*x+me[6]*y+me[10]*z+me[14]*w)*d,this.w=(me[3]*x+me[7]*y+me[11]*z+me[15]*w)*d,this},Vec4.prototype.lenSq=function(){return this.dot(this)},Vec4.prototype.len=function(){return sqrt(this.lenSq())},Vec4.prototype.norm=function(){return this.sdiv(this.len())},Vec4.prototype.setLen=function(len){return this.norm().smul(len)},Vec4.prototype.inverse=function(){return this.smul(-1)},Vec4.prototype.abs=function(){return this.x=abs(this.x),this.y=abs(this.y),this.z=abs(this.z),this.w=abs(this.w),this},Vec4.prototype.min=function(other){var x=other.x,y=other.y,z=other.z,w=other.w;return this.x=x<this.x?x:this.x,this.y=y<this.y?y:this.y,this.z=z<this.z?z:this.z,this.w=w<this.w?w:this.w,this},Vec4.prototype.max=function(other){var x=other.x,y=other.y,z=other.z,w=other.w;return this.x=x>this.x?x:this.x,this.y=y>this.y?y:this.y,this.z=z>this.z?z:this.z,this.w=w>this.w?w:this.w,this},Vec4.prototype.clamp=function(min,max){return this.x=clamp(this.x,min.x,max.x),this.y=clamp(this.y,min.y,max.y),this.z=clamp(this.z,min.y,max.z),this.w=clamp(this.w,min.w,max.w),this},Vec4.distSq=Vec4.prototype.distSq=function(){var dist=new Vec4;return function(a,b){return dist.vsub(a,b).lenSq()}}(),Vec4.dist=Vec4.prototype.dist=function(a,b){return sqrt(Vec4.distSq(a,b))},Vec4.prototype.toString=function(){return"Vec4( "+this.x+", "+this.y+", "+this.z+", "+this.w+" )"},Vec4.prototype.equals=function(other){return Vec4.equals(this,other)},Vec4.equals=function(a,b){return equals(a.x,b.x)&&equals(a.y,b.y)&&equals(a.z,b.z)&&equals(a.w,b.w)},Vec4});if(typeof define!="function")var define=require("amdefine")(module);define("math/color",["math/mathf","math/vec3","math/vec4"],function(Mathf,Vec3,Vec4){var abs=Math.abs,floor=Math.floor,sqrt=Math.sqrt,lerp=Mathf.lerp,equals=Mathf.equals;function Color(r,g,b,a){this.r=0,this.g=0,this.b=0,this.a=1,this._cache={rgb:"rgb( 0, 0, 0 )",rgba:"rgba( 0, 0, 0, 1 )",hex:"#000000"},this.set(r||0,g||0,b||0,a!==undefined?a:1)}Color.prototype.clone=function(){return new Color(this.r,this.g,this.b,this.a)},Color.prototype.copy=function(other){if(other instanceof Vec3)this.r=other.x,this.g=other.y,this.b=other.z,this._updateCache();else if(other instanceof Vec4)this.r=other.x,this.g=other.y,this.b=other.z,this.a=other.w,this._updateCache();else{var cacheA=this._cache,cacheB=other._cache;this.r=other.r,this.g=other.g,this.b=other.b,this.a=other.a,cacheA.hex=cacheB.hex,cacheA.rgb=cacheB.rgb,cacheA.rgba=cacheB.rgba}return this},Color.prototype.set=function(r,g,b,a){return typeof r=="number"?this.setArgs(r,g,b,a):typeof r=="string"?this.setString(r):(this.set(0,0,0,1),console.warn("Color.set: Invalid input")),this},Color.prototype.setString=function(){var reg1=/^rgb(a)?\(\s*(-?[\d]+)(%)?\s*,\s*(-?[\d]+)(%)?\s*,\s*(-?[\d]+)(%)?\s*,?\s*(-?[\d\.]+)?\s*\)$/,reg2=/#(.)(.)(.)/,str="#$1$1$2$2$3$3",hexName;function isValidRgb(rgb){return rgb.match(reg1)}function isValidHex(hex){return reg2.test(hex)}return function(str){return hexName=colorNames[str.toLowerCase()],isValidHex(str)?this.setHex(str):isValidRgb(str)?this.setRgb(str):hexName?this.setHex(hexName):(this.set(0,0,0,1),console.warn("Color.setString: Invalid String")),this}}(),Color.prototype.setArgs=function(r,g,b,a){return this.r=r,this.g=g,this.b=b,this.a=a,this._updateCache(),this},Color.prototype.setRgb=function(){var reg=/^rgb(a)?\(\s*(-?[\d]+)(%)?\s*,\s*(-?[\d]+)(%)?\s*,\s*(-?[\d]+)(%)?\s*,?\s*(-?[\d\.]+)?\s*\)$/;function isValid(rgb){return rgb.match(reg)}return function(rgb){return rgb=isValid(rgb),rgb?(this.r=Number(rgb[2])/255,this.g=Number(rgb[4])/255,this.b=Number(rgb[6])/255,this.a=Number(rgb[8])||1):(this.set(0,0,0,1),console.warn("Color.setRgb: Invalid rgb")),this._updateCache(),this}}(),Color.prototype.setHex=function(){var reg1=/#(.)(.)(.)/,reg2=/^#(?:[0-9a-f]{3}){1,2}$/i,str="#$1$1$2$2$3$3";function normalizeHex(hex){return hex.length===4&&(hex=hex.replace(reg1,str)),hex.toLowerCase(),hex}function isValid(hex){return reg2.test(hex)}return function(hex){return isValid(hex)?(normalizeHex(hex),this.r=parseInt(hex.substr(1,2),16)/255,this.g=parseInt(hex.substr(3,2),16)/255,this.b=parseInt(hex.substr(5,2),16)/255,this.a=1):(this.set(0,0,0,1),console.warn("Color.setHex: Invalid hex")),this._updateCache(),this}}(),Color.prototype._updateCache=function(){var cache,num,n;function singleToHex(value){return num=floor(value*255),n=parseInt(num).toString(16),num===0?n="00":num>0&&num<15&&(n="0"+n),n}return function(){cache=this._cache;var hexR=singleToHex(this.r),hexG=singleToHex(this.g),hexB=singleToHex(this.b),rgbR=floor(this.r*256),rgbG=floor(this.g*256),rgbB=floor(this.b*256),rgbA=floor(this.a);return cache.rgb="rgb( "+rgbR+", "+rgbG+", "+rgbB+" )",cache.rgba="rgba( "+rgbR+", "+rgbG+", "+rgbB+", "+rgbA+" )",cache.hex="#"+hexR+hexG+hexB,this}}(),Color.prototype.hex=function(){return this._cache.hex},Color.prototype.rgb=function(){return this._cache.rgb},Color.prototype.rgba=function(){return this._cache.rgba},Color.prototype.cadd=function(a,b){return this.r=a.r+b.r,this.g=a.g+b.g,this.b=a.b+b.b,this.a=a.a+b.a,this},Color.prototype.add=function(other){return this.cadd(this,other)},Color.prototype.sadd=function(s){return this.r+=s,this.g+=s,this.b+=s,this.a+=s,this},Color.prototype.csub=function(a,b){return this.r=a.r-b.r,this.g=a.g-b.g,this.b=a.b-b.b,this.a=a.a-b.a,this},Color.prototype.sub=function(other){return this.csub(this,other)},Color.prototype.ssub=function(s){return this.r-=s,this.g-=s,this.b-=s,this.a-=s,this},Color.prototype.cmul=function(a,b){return this.r=a.r*b.r,this.g=a.g*b.g,this.b=a.b*b.b,this.a=a.a*b.a,this},Color.prototype.mul=function(other){return this.cmul(this,other)},Color.prototype.smul=function(s){return this.r*=s,this.g*=s,this.b*=s,this.a*=s,this},Color.prototype.cdiv=function(a,b){var x=b.r,y=b.g,z=b.b;return x!==0&&y!==0?(this.r=a.r/x,this.g=a.g/y,this.b=a.b/z,this.a=a.a/w):(this.r=0,this.g=0,this.b=0,this.a=0),this},Color.prototype.div=function(other){return this.cdiv(this,other)},Color.prototype.sdiv=function(s){return s!==0?(s=1/s,this.r*=s,this.g*=s,this.b*=s,this.a*=s):(this.r=0,this.g=0,this.b=0,this.a=0),this},Color.cdot=Color.prototype.cdot=function(a,b){return a.r*b.r+a.g*b.g+a.b*b.b+a.a*b.a},Color.prototype.dot=function(other){return this.cdot(this,other)},Color.prototype.clerp=function(a,b,t){return this.r=lerp(a.r,b.r,t),this.g=lerp(a.g,b.g,t),this.b=lerp(a.b,b.b,t),this.a=lerp(a.a,b.a,t),this},Color.prototype.lerp=function(other,t){return this.clerp(this,other,t)},Color.prototype.lenSq=function(){return this.dot(this)},Color.prototype.len=function(){return sqrt(this.lenSq())},Color.prototype.norm=function(){return this.sdiv(this.len())},Color.prototype.abs=function(){return this.r=abs(this.r),this.g=abs(this.g),this.b=abs(this.b),this.a=abs(this.a),this},Color.prototype.min=function(other){var r=other.r,g=other.g,b=other.b,a=other.a;return this.r=r<this.r?r:this.r,this.g=g<this.g?g:this.g,this.b=b<this.b?b:this.b,this.a=a<this.a?a:this.a,this},Color.prototype.max=function(other){var r=other.r,g=other.g,b=other.b,a=other.a;return this.r=r>this.r?r:this.r,this.g=g>this.g?g:this.g,this.b=b>this.b?b:this.b,this.a=a>this.a?a:this.a,this},Color.prototype.clamp=function(min,max){return this.r=clamp(this.r,min.r,max.r),this.g=clamp(this.g,min.g,max.g),this.b=clamp(this.b,min.g,max.b),this.a=clamp(this.a,min.a,max.a),this},Color.prototype.toString=function(){return"Color( "+this.r+", "+this.g+", "+this.b+", "+this.a+" )"},Color.prototype.equals=function(other){return Color.equals(this,other)},Color.equals=function(a,b){return equals(a.r,b.r)&&equals(a.g,b.g)&&equals(a.b,b.b)&&equals(a.a,b.a)};var colorNames={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};return Color});if(typeof define!="function")var define=require("amdefine")(module);define("math/mat3",["math/mathf","math/vec2"],function(Mathf,Vec2){var cos=Math.cos,sin=Math.sin,atan2=Math.atan2,equals=Mathf.equals;function Mat3(m11,m12,m13,m21,m22,m23,m31,m32,m33){this.elements=new Float32Array(9),this.set(m11!==undefined?m11:1,m12||0,m13||0,m21||0,m22!==undefined?m22:1,m23||0,m31||0,m32||0,m33!==undefined?m33:1)}return Mat3.prototype.clone=function(){var te=this.elements;return new Mat3(te[0],te[3],te[6],te[1],te[4],te[7],te[2],te[5],te[8])},Mat3.prototype.copy=function(m){var me=m.elements;return this.set(me[0],me[3],me[6],me[1],me[4],me[7],me[2],me[5],me[8])},Mat3.prototype.set=function(m11,m12,m13,m21,m22,m23,m31,m32,m33){var te=this.elements;return te[0]=m11,te[3]=m12,te[6]=m13,te[1]=m21,te[4]=m22,te[7]=m23,te[2]=m31,te[5]=m32,te[8]=m33,this},Mat3.prototype.identity=function(){return this.set(1,0,0,0,1,0,0,0,1),this},Mat3.prototype.determinant=function(){var te=this.elements,a=te[0],b=te[1],c=te[2],d=te[3],e=te[4],f=te[5],g=te[6],h=te[7],i=te[8];return a*e*i-a*f*h-b*d*i+b*f*g+c*d*h-c*e*g},Mat3.prototype.transpose=function(){var te=this.elements,tmp;return tmp=te[1],te[1]=te[3],te[3]=tmp,tmp=te[2],te[2]=te[6],te[6]=tmp,tmp=te[5],te[5]=te[7],te[7]=tmp,this},Mat3.prototype.getInverse=function(m){var te=this.elements,me=m.elements,det,m11=me[0],m12=me[3],m13=me[6],m21=me[1],m22=me[4],m23=me[7],m31=me[2],m32=me[5],m33=me[8];return te[0]=m22*m33-m23*m32,te[1]=m23*m31-m21*m33,te[2]=m21*m32-m22*m31,te[3]=m13*m32-m12*m33,te[4]=m11*m33-m13*m31,te[5]=m12*m31-m11*m32,te[6]=m12*m23-m13*m22,te[7]=m13*m21-m11*m23,te[8]=m11*m22-m12*m21,det=m11*te[0]+m21*te[3]+m31*te[6],det===0?this.identity():this.smul(1/det),this},Mat3.prototype.getInverseMat4=function(m){var te=this.elements,me=m.elements,det,m11=me[0],m12=me[4],m13=me[8],m14=me[12],m21=me[1],m22=me[5],m23=me[9],m24=me[13],m31=me[2],m32=me[6],m33=me[10],m34=me[14],m41=me[3],m42=me[7],m43=me[11],m44=me[15];return te[0]=m33*m22-m32*m23,te[1]=-m33*m21+m31*m23,te[2]=m32*m21-m31*m22,te[3]=-m33*m12+m32*m13,te[4]=m33*m11-m31*m13,te[5]=-m32*m11+m31*m12,te[6]=m23*m12-m22*m13,te[7]=-m23*m11+m21*m13,te[8]=m22*m11-m21*m12,det=m11*te[0]+m21*te[3]+m31*te[6],det===0?this.identity():this.smul(1/det),this},Mat3.prototype.inverse=function(){return this.getInverse(this)},Mat3.prototype.mmul=function(a,b){var te=this.elements,ae=a.elements,be=b.elements,a11=ae[0],a12=ae[3],a13=ae[6],a21=ae[1],a22=ae[4],a23=ae[7],a31=ae[2],a32=ae[5],a33=ae[8],b11=be[0],b12=be[3],b13=be[6],b21=be[1],b22=be[4],b23=be[7],b31=be[2],b32=be[5],b33=be[8];return te[0]=a11*b11+a12*b21+a13*b31,te[3]=a11*b12+a12*b22+a13*b32,te[6]=a11*b13+a12*b23+a13*b33,te[1]=a21*b11+a22*b21+a23*b31,te[4]=a21*b12+a22*b22+a23*b32,te[7]=a21*b13+a22*b23+a23*b33,te[2]=a31*b11+a32*b21+a33*b31,te[5]=a31*b12+a32*b22+a33*b32,te[8]=a31*b13+a32*b23+a33*b33,this},Mat3.prototype.mul=function(m){return this.mmul(this,m)},Mat3.prototype.smul=function(s){var te=this.elements;return te[0]*=s,te[1]*=s,te[2]*=s,te[3]*=s,te[4]*=s,te[5]*=s,te[6]*=s,te[7]*=s,te[8]*=s,this},Mat3.prototype.setRotationAngle=function(angle){var te=this.elements,c=cos(angle),s=sin(angle);return te[0]=c,te[1]=-s,te[3]=s,te[4]=c,this},Mat3.prototype.setPositionVec2=Mat3.prototype.setPositionVec3=function(v){var te=this.elements;return te[6]=v.x,te[7]=v.y,this},Mat3.prototype.getRotation=function(){var te=this.elements;return atan2(te[1],te[0])},Mat3.prototype.lookAt=function(){var vec=new Vec2,scale=new Vec2;return function(eye,target){vec.vsub(target,eye),scale.getScaleMat3(this);var te=this.elements,angle=atan2(vec.y,vec.x),c=cos(angle),s=sin(angle);return te[0]=c*scale.x,te[1]=-s*scale.x,te[3]=s*scale.y,te[4]=c*scale.y,this}}(),Mat3.prototype.extractPosition=function(m){var te=this.elements,me=m.elements;return te[6]=me[6],te[7]=me[7],this},Mat3.prototype.extractRotation=function(){var vec=new Vec2;return function(m){var te=this.elements,me=m.elements,scaleX=1/vec.set(me[0],me[1]).len(),scaleY=1/vec.set(me[3],me[4]).len();return te[0]=me[0]*scaleX,te[1]=me[1]*scaleX,te[3]=me[3]*scaleY,te[4]=me[4]*scaleY,this}}(),Mat3.prototype.translate=function(v){var te=this.elements,x=v.x,y=v.y;return te[6]=te[0]*x+te[3]*y+te[6],te[7]=te[1]*x+te[4]*y+te[7],te[8]=te[2]*x+te[5]*y+te[8],this},Mat3.prototype.rotate=function(angle){var te=this.elements,m11=te[0],m12=te[3],m13=te[6],m21=te[1],m22=te[4],m23=te[7],c=cos(angle),s=sin(angle);return te[0]=m11*c-m21*s,te[3]=m12*c-m22*s,te[6]=m13*c-m23*s,te[1]=m11*s+m21*c,te[4]=m12*s+m22*c,te[7]=m13*s+m23*c,this},Mat3.prototype.scale=function(v){var te=this.elements,x=v.x,y=v.x;return te[0]*=x,te[3]*=y,te[1]*=x,te[4]*=y,te[2]*=x,te[5]*=y,this},Mat3.prototype.makeTranslation=function(x,y){return this.set(1,0,x,0,1,y,0,0,1),this},Mat3.prototype.makeRotation=function(angle){var c=cos(angle),s=sin(angle);return this.set(c,s,0,-s,c,0,0,0,1),this},Mat3.prototype.makeScale=function(x,y){return this.set(x,0,0,0,y,0,0,0,1),this},Mat3.prototype.makeOrthographic=function(left,right,top,bottom){var w=1/(right-left),h=1/(top-bottom),x=(right+left)*w,y=(top+bottom)*h;return this.set(2*w,0,-x,0,2*h,-y,0,0,1),this},Mat3.prototype.toString=function(){var te=this.elements;return"Mat3["+te[0]+", "+te[3]+", "+te[6]+"]\n"+"     ["+te[1]+", "+te[4]+", "+te[7]+"]\n"+"     ["+te[2]+", "+te[5]+", "+te[8]+"]"},Mat3.prototype.equals=function(other){return Mat3.equals(this,other)},Mat3.equals=function(a,b){var ae=a.elements,be=b.elements;return equals(ae[0],be[0])&&equals(ae[1],be[1])&&equals(ae[2],be[2])&&equals(ae[3],be[3])&&equals(ae[4],be[4])&&equals(ae[5],be[5])&&equals(ae[6],be[6])&&equals(ae[7],be[7])&&equals(ae[8],be[8])},Mat3});if(typeof define!="function")var define=require("amdefine")(module);define("math/quat",["math/mathf","math/vec3"],function(Mathf,Vec3){var abs=Math.abs,sqrt=Math.sqrt,acos=Math.acos,cos=Math.cos,sin=Math.sin,lerp=Mathf.lerp,clamp=Mathf.clamp,equals=Mathf.equals;function Quat(x,y,z,w){this.x=x||0,this.y=y||0,this.z=z||0,this.w=w!==undefined?w:1}return Quat.prototype.clone=function(){return new Quat(this.x,this.y,this.z,this.w)},Quat.prototype.copy=function(other){return this.x=other.x,this.y=other.y,this.z=other.z,this.w=other.w,this},Quat.prototype.set=function(x,y,z,w){return this.x=x,this.y=y,this.z=z,this.w=w,this},Quat.prototype.qadd=function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this.w=a.w+b.w,this},Quat.prototype.add=function(other){return this.qadd(this,other)},Quat.prototype.sadd=function(s){return this.x+=s,this.y+=s,this.z+=s,this.w+=s,this},Quat.prototype.qsub=function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this.w=a.w-b.w,this},Quat.prototype.sub=function(other){return this.qsub(this,other)},Quat.prototype.ssub=function(s){return this.x-=s,this.y-=s,this.z-=s,this.w-=s,this},Quat.prototype.qmul=function(a,b){var ax=a.x,ay=a.y,az=a.z,aw=a.w,bx=b.x,by=b.y,bz=b.z,bw=b.w;return this.x=ax*bw+aw*bx+ay*bz-az*by,this.y=ay*bw+aw*by+az*bx-ax*bz,this.z=az*bw+aw*bz+ax*by-ay*bx,this.w=aw*bw-ax*bx-ay*by-az*bz,this},Quat.prototype.mul=function(other){return this.qmul(this,other)},Quat.prototype.smul=function(s){return this.x*=s,this.y*=s,this.z*=s,this.w*=s,this},Quat.prototype.sdiv=function(s){return s!==0?(s=1/s,this.x*=s,this.y*=s,this.z*=s,this.w*=s):(this.x=0,this.y=0,this.z=0,this.w=0),this},Quat.qdot=Quat.prototype.qdot=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z+a.w*b.w},Quat.prototype.dot=function(other){return this.qdot(this,other)},Quat.prototype.qlerp=function(a,b,t){return this.x=lerp(a.x,b.x,t),this.y=lerp(a.y,b.y,t),this.z=lerp(a.z,b.z,t),this.w=lerp(a.w,b.w,t),this},Quat.prototype.lerp=function(other,t){return this.qlerp(this,other,t)},Quat.prototype.qslerp=function(){var start=new Quat,end=new Quat,quat=new Quat,relative=new Quat;return function(a,b,t){var dot=clamp(Quat.qdot(a,b),-1,1),theta=acos(dot)*t;return start.copy(a),end.copy(b),quat.copy(start),relative.qsub(end,quat.smul(dot)),relative.norm(),this.qadd(start.smul(cos(theta)),relative.smul(sin(theta)))}}(),Quat.prototype.slerp=function(other,t){return this.qslerp(this,other,t)},Quat.prototype.lenSq=function(){return this.dot(this)},Quat.prototype.len=function(){return sqrt(this.lenSq())},Quat.prototype.norm=function(){return this.sdiv(this.len())},Quat.prototype.inverse=function(q){return this.inverse().norm()},Quat.prototype.calculateW=function(){var x=this.x,y=this.y,z=this.z;return this.w=-sqrt(abs(1-x*x-y*y-z*z)),this},Quat.prototype.axisAngle=function(axis,angle){var halfAngle=angle*.5,s=sin(halfAngle);return this.x=axis.x*s,this.y=axis.y*s,this.z=axis.z*s,this.w=cos(halfAngle),this},Quat.prototype.getRotationMat4=function(m){var te=m.elements,m11=te[0],m12=te[4],m13=te[8],m21=te[1],m22=te[5],m23=te[9],m31=te[2],m32=te[6],m33=te[10],trace=m11+m22+m33,s;return trace>0?(s=.5/sqrt(trace+1),this.w=.25/s,this.x=(m32-m23)*s,this.y=(m13-m31)*s,this.z=(m21-m12)*s):m11>m22&&m11>m33?(s=2*sqrt(1+m11-m22-m33),this.w=(m32-m23)/s,this.x=.25*s,this.y=(m12+m21)/s,this.z=(m13+m31)/s):m22>m33?(s=2*sqrt(1+m22-m11-m33),this.w=(m13-m31)/s,this.x=(m12+m21)/s,this.y=.25*s,this.z=(m23+m32)/s):(s=2*sqrt(1+m33-m11-m22),this.w=(m21-m12)/s,this.x=(m13+m31)/s,this.y=(m23+m32)/s,this.z=.25*s),this},Quat.prototype.rotateX=function(angle){angle/=2;var x=this.x,y=this.y,z=this.z,w=this.w,s=sin(angle),c=cos(angle);return this.x=x*c+w*s,this.y=y*c+z*s,this.z=z*c-y*s,this.w=w*c-x*s,this},Quat.prototype.rotateY=function(angle){angle/=2;var x=this.x,y=this.y,z=this.z,w=this.w,s=sin(angle),c=cos(angle);return this.x=x*c-z*s,this.y=y*c+w*s,this.z=z*c+x*s,this.w=w*c-y*s,this},Quat.prototype.rotateZ=function(angle){angle/=2;var x=this.x,y=this.y,z=this.z,w=this.w,s=sin(angle),c=cos(angle);return this.x=x*c+y*s,this.y=y*c-x*s,this.z=z*c+w*s,this.w=w*c-z*s,this},Quat.prototype.rotate=function(x,y,z){return this.rotateZ(z),this.rotateX(x),this.rotateY(y),this},Quat.distSq=Quat.prototype.distSq=function(){var dist=new Quat;return function(a,b){return dist.qsub(a,b).lenSq()}}(),Quat.dist=Quat.prototype.dist=function(a,b){return sqrt(this.distSq(a,b))},Quat.prototype.toString=function(){return"Quat( "+this.x+", "+this.y+", "+this.z+", "+this.w+" )"},Quat.prototype.equals=function(other){return Quat.equals(this,other)},Quat.equals=function(a,b){return equals(a.x,b.x)&&equals(a.y,b.y)&&equals(a.z,b.z)&&equals(a.w,b.w)},Quat});if(typeof define!="function")var define=require("amdefine")(module);define("math/mat4",["math/mathf","math/vec3","math/quat"],function(Mathf,Vec3,Quat){var cos=Math.cos,sin=Math.sin,tan=Math.tan,equals=Mathf.equals;function Mat4(m11,m12,m13,m14,m21,m22,m23,m24,m31,m32,m33,m34,m41,m42,m43,m44){this.elements=new Float32Array(16),this.set(m11!==undefined?m11:1,m12||0,m13||0,m14||0,m21||0,m22!==undefined?m22:1,m23||0,m34||0,m31||0,m32||0,m33!==undefined?m33:1,m34||0,m41||0,m42||0,m43||0,m44!==undefined?m44:1)}return Mat4.prototype.clone=function(){var te=this.elements;return new Mat3(te[0],te[4],te[8],te[12],te[1],te[5],te[9],te[13],te[2],te[6],te[10],te[14],te[3],te[7],te[11],te[15])},Mat4.prototype.copy=function(m){var me=m.elements;return this.set(me[0],me[4],me[8],me[12],me[1],me[5],me[9],me[13],me[2],me[6],me[10],me[14],me[3],me[7],me[11],me[15])},Mat4.prototype.set=function(m11,m12,m13,m14,m21,m22,m23,m24,m31,m32,m33,m34,m41,m42,m43,m44){var te=this.elements;return te[0]=m11,te[4]=m12,te[8]=m13,te[12]=m14,te[1]=m21,te[5]=m22,te[9]=m23,te[13]=m24,te[2]=m31,te[6]=m32,te[10]=m33,te[14]=m34,te[3]=m41,te[7]=m42,te[11]=m43,te[15]=m44,this},Mat4.prototype.identity=function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},Mat4.prototype.determinant=function(){var te=this.elements,m11=te[0],m12=te[4],m13=te[8],m14=te[12],m21=te[1],m22=te[5],m23=te[9],m24=te[13],m31=te[2],m32=te[6],m33=te[10],m34=te[14],m41=te[3],m42=te[7],m43=te[11],m44=te[15];return m41*(+m14*m23*m32-m13*m24*m32-m14*m22*m33+m12*m24*m33+m13*m22*m34-m12*m23*m34)+m42*(+m11*m23*m34-m11*m24*m33+m14*m21*m33-m13*m21*m34+m13*m24*m31-m14*m23*m31)+m43*(+m11*m24*m32-m11*m22*m34-m14*m21*m32+m12*m21*m34+m14*m22*m31-m12*m24*m31)+m44*(-m13*m22*m31-m11*m23*m32+m11*m22*m33+m13*m21*m32-m12*m21*m33+m12*m23*m31)},Mat4.prototype.transpose=function(){var te=this.elements,tmp;return tmp=te[1],te[1]=te[4],te[4]=tmp,tmp=te[2],te[2]=te[8],te[8]=tmp,tmp=te[6],te[6]=te[9],te[9]=tmp,tmp=te[3],te[3]=te[12],te[12]=tmp,tmp=te[7],te[7]=te[13],te[13]=tmp,tmp=te[11],te[11]=te[14],te[14]=tmp,this},Mat4.prototype.getInverse=function(m){var te=this.elements,me=m.elements,det,m11=me[0],m12=me[4],m13=me[8],m14=me[12],m21=me[1],m22=me[5],m23=me[9],m24=me[13],m31=me[2],m32=me[6],m33=me[10],m34=me[14],m41=me[3],m42=me[7],m43=me[11],m44=me[15];return te[0]=m23*m34*m42-m24*m33*m42+m24*m32*m43-m22*m34*m43-m23*m32*m44+m22*m33*m44,te[1]=m24*m33*m41-m23*m34*m41-m24*m31*m43+m21*m34*m43+m23*m31*m44-m21*m33*m44,te[2]=m22*m34*m41-m24*m32*m41+m24*m31*m42-m21*m34*m42-m22*m31*m44+m21*m32*m44,te[3]=m23*m32*m41-m22*m33*m41-m23*m31*m42+m21*m33*m42+m22*m31*m43-m21*m32*m43,te[4]=m14*m33*m42-m13*m34*m42-m14*m32*m43+m12*m34*m43+m13*m32*m44-m12*m33*m44,te[5]=m13*m34*m41-m14*m33*m41+m14*m31*m43-m11*m34*m43-m13*m31*m44+m11*m33*m44,te[6]=m14*m32*m41-m12*m34*m41-m14*m31*m42+m11*m34*m42+m12*m31*m44-m11*m32*m44,te[7]=m12*m33*m41-m13*m32*m41+m13*m31*m42-m11*m33*m42-m12*m31*m43+m11*m32*m43,te[8]=m13*m24*m42-m14*m23*m42+m14*m22*m43-m12*m24*m43-m13*m22*m44+m12*m23*m44,te[9]=m14*m23*m41-m13*m24*m41-m14*m21*m43+m11*m24*m43+m13*m21*m44-m11*m23*m44,te[10]=m12*m24*m41-m14*m22*m41+m14*m21*m42-m11*m24*m42-m12*m21*m44+m11*m22*m44,te[11]=m13*m22*m41-m12*m23*m41-m13*m21*m42+m11*m23*m42+m12*m21*m43-m11*m22*m43,te[12]=m14*m23*m32-m13*m24*m32-m14*m22*m33+m12*m24*m33+m13*m22*m34-m12*m23*m34,te[13]=m13*m24*m31-m14*m23*m31+m14*m21*m33-m11*m24*m33-m13*m21*m34+m11*m23*m34,te[14]=m14*m22*m31-m12*m24*m31-m14*m21*m32+m11*m24*m32+m12*m21*m34-m11*m22*m34,te[15]=m12*m23*m31-m13*m22*m31+m13*m21*m32-m11*m23*m32-m12*m21*m33+m11*m22*m33,det=m11*te[0]+m21*te[4]+m31*te[8]+m41*te[12],det==0?this.identity():this.smul(1/det),this},Mat4.prototype.inverse=function(){return this.getInverse(this)},Mat4.prototype.mmul=function(a,b){var te=this.elements,ae=a.elements,be=b.elements,a11=ae[0],a12=ae[4],a13=ae[8],a14=ae[12],a21=ae[1],a22=ae[5],a23=ae[9],a24=ae[13],a31=ae[2],a32=ae[6],a33=ae[10],a34=ae[14],a41=ae[3],a42=ae[7],a43=ae[11],a44=ae[15],b11=be[0],b12=be[4],b13=be[8],b14=be[12],b21=be[1],b22=be[5],b23=be[9],b24=be[13],b31=be[2],b32=be[6],b33=be[10],b34=be[14],b41=be[3],b42=be[7],b43=be[11],b44=be[15];return te[0]=a11*b11+a12*b21+a13*b31+a14*b41,te[1]=a21*b11+a22*b21+a23*b31+a24*b41,te[2]=a31*b11+a32*b21+a33*b31+a34*b41,te[3]=a41*b11+a42*b21+a43*b31+a44*b41,te[4]=a11*b12+a12*b22+a13*b32+a14*b42,te[5]=a21*b12+a22*b22+a23*b32+a24*b42,te[6]=a31*b12+a32*b22+a33*b32+a34*b42,te[7]=a41*b12+a42*b22+a43*b32+a44*b42,te[8]=a11*b13+a12*b23+a13*b33+a14*b43,te[9]=a21*b13+a22*b23+a23*b33+a24*b43,te[10]=a31*b13+a32*b23+a33*b33+a34*b43,te[11]=a41*b13+a42*b23+a43*b33+a44*b43,te[12]=a11*b14+a12*b24+a13*b34+a14*b44,te[13]=a21*b14+a22*b24+a23*b34+a24*b44,te[14]=a31*b14+a32*b24+a33*b34+a34*b44,te[15]=a41*b14+a42*b24+a43*b34+a44*b44,this},Mat4.prototype.mul=function(m){return this.mmul(this,m)},Mat4.prototype.smul=function(s){var te=this.elements;return te[0]*=s,te[1]*=s,te[2]*=s,te[3]*=s,te[4]*=s,te[5]*=s,te[6]*=s,te[7]*=s,te[8]*=s,te[9]*=s,te[10]*=s,te[11]*=s,te[12]*=s,te[13]*=s,te[14]*=s,te[15]*=s,this},Mat4.prototype.setRotationQuat=function(q){var te=this.elements,x=q.x,y=q.y,z=q.z,w=q.w,x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;return te[0]=1-(yy+zz),te[4]=xy-wz,te[8]=xz+wy,te[1]=xy+wz,te[5]=1-(xx+zz),te[9]=yz-wx,te[2]=xz-wy,te[6]=yz+wx,te[10]=1-(xx+yy),this},Mat4.prototype.setPositionVec2=function(v){var te=this.elements;return te[12]=v.x,te[13]=v.y,this},Mat4.prototype.setPositionVec3=function(v){var te=this.elements;return te[12]=v.x,te[13]=v.y,te[14]=v.z,this},Mat4.prototype.lookAt=function(){var defaultUp=new Vec3(0,0,1),x=new Vec3,y=new Vec3,z=new Vec3;return function(eye,target,up){up=up instanceof Vec3?up:defaultUp;var te=this.elements;return z.vsub(eye,target).norm(),z.len()===0&&(z.z=1),x.vcross(up,z).norm(),x.len()===0&&(z.x+=1e-4,x.vcross(up,z).norm()),y.vcross(z,x),te[0]=x.x,te[4]=y.x,te[8]=z.x,te[1]=x.y,te[5]=y.y,te[9]=z.y,te[2]=x.z,te[6]=y.z,te[10]=z.z,this}}(),Mat4.prototype.extractPosition=function(m){var te=this.elements,me=m.elements;return te[12]=me[12],te[13]=me[13],te[14]=me[14],this},Mat4.prototype.extractRotation=function(){var vec=new Vec3;return function(m){var te=this.elements,me=m.elements,scaleX=1/vec.set(me[0],me[1],me[2]).len(),scaleY=1/vec.set(me[4],me[5],me[6]).len(),scaleZ=1/vec.set(me[8],me[9],me[10]).len();return te[0]=me[0]*scaleX,te[1]=me[1]*scaleX,te[2]=me[2]*scaleX,te[4]=me[4]*scaleY,te[5]=me[5]*scaleY,te[6]=me[6]*scaleY,te[8]=me[8]*scaleZ,te[9]=me[9]*scaleZ,te[10]=me[10]*scaleZ,this}}(),Mat4.prototype.translate=function(v){var te=this.elements,x=v.x,y=v.y,z=v.z;return te[12]=te[0]*x+te[4]*y+te[8]*z+te[12],te[13]=te[1]*x+te[5]*y+te[9]*z+te[13],te[14]=te[2]*x+te[6]*y+te[10]*z+te[14],te[15]=te[3]*x+te[7]*y+te[11]*z+te[15],this},Mat4.prototype.rotateAxis=function(v){var te=this.elements,vx=v.x,vy=v.y,vz=v.z;return v.x=vx*te[0]+vy*te[4]+vz*te[8],v.y=vx*te[1]+vy*te[5]+vz*te[9],v.z=vx*te[2]+vy*te[6]+vz*te[10],v.norm(),v},Mat4.prototype.rotateX=function(angle){var te=this.elements,m12=te[4],m22=te[5],m32=te[6],m42=te[7],m13=te[8],m23=te[9],m33=te[10],m43=te[11],c=cos(angle),s=sin(angle);return te[4]=c*m12+s*m13,te[5]=c*m22+s*m23,te[6]=c*m32+s*m33,te[7]=c*m42+s*m43,te[8]=c*m13-s*m12,te[9]=c*m23-s*m22,te[10]=c*m33-s*m32,te[11]=c*m43-s*m42,this},Mat4.prototype.rotateY=function(angle){var te=this.elements,m11=te[0],m21=te[1],m31=te[2],m41=te[3],m13=te[8],m23=te[9],m33=te[10],m43=te[11],c=cos(angle),s=sin(angle);return te[0]=c*m11-s*m13,te[1]=c*m21-s*m23,te[2]=c*m31-s*m33,te[3]=c*m41-s*m43,te[8]=c*m13+s*m11,te[9]=c*m23+s*m21,te[10]=c*m33+s*m31,te[11]=c*m43+s*m41,this},Mat4.prototype.rotateZ=function(angle){var te=this.elements,m11=te[0],m21=te[1],m31=te[2],m41=te[3],m12=te[4],m22=te[5],m32=te[6],m42=te[7],c=cos(angle),s=sin(angle);return te[0]=c*m11+s*m12,te[1]=c*m21+s*m22,te[2]=c*m31+s*m32,te[3]=c*m41+s*m42,te[4]=c*m12-s*m11,te[5]=c*m22-s*m21,te[6]=c*m32-s*m31,te[7]=c*m42-s*m41,this},Mat4.prototype.scale=function(v){var te=this.elements,x=v.x,y=v.y,z=v.z;return te[0]*=x,te[4]*=y,te[8]*=z,te[1]*=x,te[5]*=y,te[9]*=z,te[2]*=x,te[6]*=y,te[10]*=z,te[3]*=x,te[7]*=y,te[11]*=z,this},Mat4.prototype.makeTranslation=function(x,y,z){return this.set(1,0,0,x,0,1,0,y,0,0,1,z,0,0,0,1),this},Mat4.prototype.makeRotationX=function(angle){var c=cos(angle),s=sin(angle);return this.set(1,0,0,0,0,c,-s,0,0,s,c,0,0,0,0,1),this},Mat4.prototype.makeRotationY=function(angle){var c=cos(angle),s=sin(angle);return this.set(c,0,s,0,0,1,0,0,-s,0,c,0,0,0,0,1),this},Mat4.prototype.makeRotationZ=function(angle){var c=cos(angle),s=sin(angle);return this.set(c,-s,0,0,s,c,0,0,0,0,1,0,0,0,0,1),this},Mat4.prototype.makeRotationAxis=function(axis,angle){var c=cos(angle),s=sin(angle),t=1-c,x=axis.x,y=axis.y,z=axis.z,tx=t*x,ty=t*y;return this.set(tx*x+c,tx*y-s*z,tx*z+s*y,0,tx*y+s*z,ty*y+c,ty*z-s*x,0,tx*z-s*y,ty*z+s*x,t*z*z+c,0,0,0,0,1),this},Mat4.prototype.makeScale=function(x,y,z){return this.set(x,0,0,0,0,y,0,0,0,0,z,0,0,0,0,1),this},Mat4.prototype.makeFrustum=function(left,right,bottom,top,near,far){var te=this.elements,x=2*near/(right-left),y=2*near/(top-bottom),a=(right+left)/(right-left),b=(top+bottom)/(top-bottom),c=-(far+near)/(far-near),d=-2*far*near/(far-near);return this.set(x,0,a,0,0,y,b,0,0,0,c,d,0,0,-1,0),this},Mat4.prototype.makePerspective=function(fov,aspect,near,far){var ymax=near*tan(fov*.008726646259971648),ymin=-ymax,xmin=ymin*aspect,xmax=ymax*aspect;return this.makeFrustum(xmin,xmax,ymin,ymax,near,far)},Mat4.prototype.makeOrthographic=function(left,right,top,bottom,near,far){var te=this.elements,w=1/(right-left),h=1/(top-bottom),p=1/(far-near),x=(right+left)*w,y=(top+bottom)*h,z=(far+near)*p;return this.set(2*w,0,0,-x,0,2*h,0,-y,0,0,-2*p,-z,0,0,0,1),this},Mat4.prototype.toString=function(){var te=this.elements;return"Mat4["+te[0]+", "+te[4]+", "+te[8]+", "+te[12]+"]\n"+"     ["+te[1]+", "+te[5]+", "+te[9]+", "+te[13]+"]\n"+"     ["+te[2]+", "+te[6]+", "+te[10]+", "+te[14]+"]\n"+"     ["+te[3]+", "+te[7]+", "+te[11]+", "+te[15]+"]"},Mat4.prototype.equals=function(other){return Mat3.equals(this,other)},Mat4.equals=function(a,b){var ae=a.elements,be=b.elements;return equals(ae[0],be[0])&&equals(ae[1],be[1])&&equals(ae[2],be[2])&&equals(ae[3],be[3])&&equals(ae[4],be[4])&&equals(ae[5],be[5])&&equals(ae[6],be[6])&&equals(ae[7],be[7])&&equals(ae[8],be[8])&&equals(ae[9],be[9])&&equals(ae[10],be[10])&&equals(ae[11],be[11])&&equals(ae[12],be[12])&&equals(ae[13],be[13])&&equals(ae[14],be[14])&&equals(ae[15],be[15])},Mat4});if(typeof define!="function")var define=require("amdefine")(module);define("base/utils",[],function(){var objProto=Object.prototype,toString=objProto.toString,hasOwnProperty=objProto.hasOwnProperty,splitter=/\s*[\s,]\s*/;function Utils(){}return Utils.prototype.has=function(obj,key){return hasOwnProperty.call(obj,key)},Utils.prototype.isFunction=function(obj){return typeof obj=="function"},Utils.prototype.isFinite=function(obj){return this.isFinite(obj)&&!this.isNaN(parseFloat(obj))},Utils.prototype.isNaN=function(obj){return this.isNumber(obj)&&obj!==+obj},Utils.prototype.isBoolean=function(obj){return obj===!0||obj===!1||toString.call(obj)==="[object Boolean]"},Utils.prototype.isNull=function(obj){return obj===void 0},Utils.prototype.isUndefined=function(obj){return obj===null},Utils.prototype.isArray=function(obj){return toString.call(obj)==="[object Array]"},Utils.prototype.isObject=function(obj){return obj===Object(obj)},Utils.prototype.isString=function(obj){return typeof obj=="string"},Utils.prototype.isNumber=function(obj){return toString.call(obj)==="[object Number]"},Utils.prototype.isArguments=function(obj){return toString.call(obj)==="[object Arguments]"},Utils.prototype.isDate=function(obj){return toString.call(obj)==="[object Date]"},Utils.prototype.isRegExp=function(obj){return toString.call(obj)==="[object RegExp]"},Utils.prototype.isRegExp=function(obj){return toString.call(obj)==="[object RegExp]"},Utils.prototype.now=function(){var startTime=Date.now();return function(){return Date.now()-startTime}}(),Utils.prototype.addEvent=function(context,name,callback,ctx){var names=name.split(splitter),i,il,afn=function(e){e=e||window.event,callback&&callback.call(ctx||context,e)};for(i=0,il=names.length;i<il;i++)name=names[i],context.attachEvent?context.attachEvent("on"+name,afn):context.addEventListener(name,afn,!1)},Utils.prototype.removeEvent=function(context,name,callback,ctx){var names=name.split(splitter),i,il,afn=function(e){e=e||window.event,callback&&callback.call(ctx||context,e)};for(i=0,il=names.length;i<il;i++)name=names[i],context.detachEvent?context.detachEvent("on"+name,afn):context.removeEventListener(name,afn,!1)},Utils.prototype.addMeta=function(id,name,content){var meta=document.createElement("meta"),head=document.getElementsByTagName("head")[0];id&&(meta.id=id),name&&(meta.name=name),content&&(meta.content=content),head.insertBefore(meta,head.firstChild)},new Utils});if(typeof define!="function")var define=require("amdefine")(module);define("base/class",["base/utils"],function(Utils){var id=0,splitter=/\s*[\s,]\s*/,slice=Array.prototype.slice;function Class(){this._id=id++,this._class=this.constructor.name,this._events={}}return Class.prototype.on=function(name,callback,context){var names=name.split(splitter),i,il,events;for(i=0,il=names.length;i<il;i++)name=names[i],events=this._events[name]||(this._events[name]=[]),events.push({callback:callback,context:context,ctx:context||this});return this},Class.prototype.off=function(name){var names=name.split(splitter),i,il;for(i=0,il=names.length;i<il;i++)name=names[i],this._events[name].length=0;return this},Class.prototype.trigger=function(name){var names,events,event,i,il,j,jl,args;splitter.test(name)&&(names=name.split(splitter));if(names)for(i=0,il=names.length;i<il;i++){name=names[i],events=this._events[name];if(!events||!events.length)continue;args=slice.call(arguments,1);for(j=0,jl=events.length;j<jl;j++)(event=events[i]).callback.apply(event.ctx,args)}else{events=this._events[name];if(!events||!events.length)return this;args=slice.call(arguments,1);for(j=0,jl=events.length;j<jl;j++)(event=events[i]).callback.apply(event.ctx,args)}return this},Class.prototype.toString=function(){return this._class},Class.prototype.getId=function(){return this._id},Class});if(typeof define!="function")var define=require("amdefine")(module);define("base/device",[],function(){function Device(){var userAgent=navigator.userAgent.toLowerCase(),audio=new Audio,video=document.createElement("video");this.userAgent=userAgent,this.pixelRatio=1/(window.devicePixelRatio||1),this.browser=userAgent.indexOf("iphone")!==-1?"iphone":userAgent.indexOf("ipad")!==-1?"ipad":userAgent.indexOf("android")!==-1?"android":userAgent.indexOf("blackberry")!==-1?"blackberry":userAgent.indexOf("msie")!==-1?"ie":userAgent.indexOf("firefox")!==-1?"firefox":userAgent.indexOf("chrome")!==-1?"chrome":userAgent.indexOf("safari")!==-1?"safari":userAgent.indexOf("opera")!==-1?"opera":"unknown",this.touch="ontouchstart"in window,this.webgl="WebGLRenderingContext"in window,this.audioMpeg=!!audio.canPlayType("audio/mpeg"),this.audioOgg=!!audio.canPlayType("audio/ogg"),this.audioMp4=!!audio.canPlayType("audio/mp4"),this.videoWebm=!!video.canPlayType("video/webm"),this.videoOgg=!!video.canPlayType("video/ogg"),this.videoMp4=!!video.canPlayType("video/mp4")}return Device.prototype.audioContext=function(){return window.audioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext||undefined}(),Device.prototype.requestAnimFrame=function(){var step=50/3;return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,step)}}(),Device.prototype.cancelAnimFrame=function(id){window.clearTimeout(id)},new Device});if(typeof define!="function")var define=require("amdefine")(module);define("base/time",["base/utils"],function(Utils){function Time(){this.sinceStartup=0,this.time=0,this.delta=1/60,this.scale=1,this.fps=60,this.frame=0}var s,sLast,ms=0,msLast=-16,last=-1e3,dt=1/60,frames=60;return Time.prototype.start=function(){ms=Utils.now(),frames++,last+1e3<ms&&(this.fps=frames*1e3/(ms-last),last=ms,frames=0),s=ms/1e3,sLast=msLast/1e3,dt=s-sLast,this.time=s*this.scale,this.delta=dt*this.scale,this.frame++},Time.prototype.end=function(){msLast=ms},new Time});if(typeof define!="function")var define=require("amdefine")(module);define("core/components/component",["base/class"],function(Class){function Component(){Class.call(this),this.gameObject=undefined}return Component.prototype=Object.create(Class.prototype),Component.prototype.constructor=Component,Component.prototype.init=function(){},Component.prototype.update=function(){},Component});if(typeof define!="function")var define=require("amdefine")(module);define("core/objects/transform2d",["base/class","base/utils","math/vec2","math/mat3"],function(Class,Utils,Vec2,Mat3){function Transform2D(opts){opts||(opts={}),Class.call(this),this.root=this,this.children=[],this.matrix=new Mat3,this.matrixWorld=new Mat3,this.matrixModelView=new Mat3,this.position=opts.position instanceof Vec2?opts.position:new Vec2,this.rotation=opts.rotation?opts.rotation:0,this.scale=opts.scale instanceof Vec2?opts.scale:new Vec2(1,1),this.world={position:new Vec2,rotation:0,scale:new Vec2},this.needsUpdate=!0,this.updateMatrices()}return Transform2D.prototype=Object.create(Class.prototype),Transform2D.prototype.constructor=Transform2D,Transform2D.prototype.clone=function(){var clone=new Transform2D;return clone.copy(this),clone},Transform2D.prototype.copy=function(other){var children=other.children,child,c=0,cl=other.children.length;this.children.length=0;for(c;c<cl;c++)child=children[c],!child||this.add(child.clone());return this.root=other.root,this.position.copy(other.position),this.scale.copy(other.scale),this.rotation=other.rotation,this.updateMatrices(),this},Transform2D.prototype.add=function(){var children=this.children,child,index,root,a=0,al=arguments.length;for(a;a<al;a++){child=arguments[a],index=children.indexOf(child);if(index===-1&&child instanceof Transform2D){child.parent&&child.parent.remove(child),child.parent=this,children.push(child),root=this;while(!!root.parent)root=root.parent;child.root=root,child.event("Add"),this.event("onAddChild",child)}}return this},Transform2D.prototype.remove=function(){var children=this.children,child,index,a=0,al=arguments.length;for(a;a<al;a++){child=arguments[a],index=children.indexOf(child);if(index!==-1){children.splice(index,1),child.parent=undefined,root=this;while(!!root.parent)root=root.parent;child.root=root,child.event("Remove"),this.event("onRemoveChild",child)}}return this},Transform2D.prototype.applyMat3=function(){var mat=new Mat3;return function(matrix){this.matrix.mmul(matrix,this.matrix),this.scale.getScaleMat3(this.matrix),mat.identity().extractRotation(this.matrix),this.local.rotation=mat.getRotation(),this.position.getPositionMat3(this.matrix)}}(),Transform2D.prototype.translate=function(){var vec=new Vec2,mat=new Mat3;return function(translation,relativeTo){vec.copy(translation),relativeTo instanceof Transform2D?mat.setRotationAngle(relativeTo.rotation):Utils.isNumber(relativeTo)&&mat.setRotationAngle(relativeTo),!relativeTo||vec.applyMat3(mat),this.position.add(vec)}}(),Transform2D.prototype.rotate=function(angle){this.rotation+=angle},Transform2D.prototype.scale=function(){var vec=new Vec2,mat=new Mat3;return function(scale,relativeTo){vec.copy(scale),relativeTo instanceof Transform2D?mat.setRotationAngle(relativeTo.rotation):Utils.isNumber(relativeTo)&&mat.setRotationAngle(relativeTo),!relativeTo||vec.applyMat3(mat),this.scale.add(vec)}}(),Transform2D.prototype.rotateAround=function(){var point=new Vec2;return function(point,angle){point.copy(point).sub(this.position),this.translate(point),this.rotate(angle),this.translate(point.inverse(),angle)}}(),Transform2D.prototype.lookAt=function(){var vec=new Vec2,mat=new Mat3;return function(target){target instanceof Transform2D?vec.copy(target.position):vec.copy(target),mat.lookAt(this.position,vec),this.rotation=mat.getRotation()}}(),Transform2D.prototype.follow=function(){var vec=new Vec2;return function(target,damping,relativeTo){damping=damping>0?damping:1,target instanceof Transform3D?vec.sub(target.position,this.position):target instanceof Vec2&&vec.sub(target,this.position),vec.lenSq()>.1&&this.translate(vec.smul(1/damping),relativeTo)}}(),Transform2D.prototype.updateMatrices=function(){var scale=this.scale,world=this.world,matrix=this.matrix,matrixWorld=this.matrixWorld;matrix.setRotationAngle(this.rotation),(scale.x!==1||scale.y!==1)&&matrix.scale(scale),matrix.setPositionVec2(this.position),this.root===this?matrixWorld.copy(matrix):matrixWorld.mmul(this.parent.matrixWorld,matrix),world.position.getPositionMat3(matrixWorld),world.rotation=matrixWorld.getRotation(),world.scale.getScaleMat3(matrixWorld),this.needsUpdate=!0},Transform2D});if(typeof define!="function")var define=require("amdefine")(module);define("core/objects/transform3d",["base/class","base/utils","math/vec3","math/quat","math/mat3","math/mat4"],function(Class,Utils,Vec3,Quat,Mat3,Mat4){function Transform3D(opts){opts||(opts={}),Class.call(this),this.parent=undefined,this.root=this,this.children=[],this.matrix=new Mat4,this.matrixWorld=new Mat4,this.matrixModelView=new Mat4,this.matrixNormal=new Mat3,this.position=opts.position instanceof Vec3?opts.position:new Vec3,this.rotation=opts.rotation instanceof Quat?opts.rotation:new Quat,this.scale=opts.scale instanceof Vec3?opts.scale:new Vec3(1,1,1),this.world={position:new Vec3,rotation:new Quat,scale:new Vec3},this.needsUpdate=!0,this.updateMatrices()}return Transform3D.prototype=Object.create(Class.prototype),Transform3D.prototype.constructor=Transform3D,Transform3D.prototype.clone=function(){var clone=new Transform3D;return clone.copy(this),clone},Transform3D.prototype.copy=function(other){var children=other.children,child,i,il;this.children.length=0;for(i=0,il=other.children.length;i<il;i++)child=children[i],!child||this.add(child.clone());return this.root=other.root,this.position.copy(other.position),this.scale.copy(other.scale),this.rotation.copy(other.rotation),this.updateMatrices(),this},Transform3D.prototype.add=function(){var children=this.children,child,index,root,i,il;for(i=0,il=arguments.length;i<il;i++){child=arguments[i],index=children.indexOf(child);if(index===-1&&child instanceof Transform3D){child.parent&&child.parent.remove(child),child.parent=this,children.push(child),root=this;while(!!root.parent)root=root.parent;child.root=root,child.trigger("add"),this.trigger("addChild",child)}}},Transform3D.prototype.remove=function(){var children=this.children,child,index,i,il;for(i=0,il=arguments.length;i<il;i++){child=arguments[i],index=children.indexOf(child);if(index!==-1){children.splice(index,1),child.parent&&child.parent.remove(child),child.parent=undefined,root=this;while(!!root.parent)root=root.parent;child.root=root,child.trigger("remove"),this.trigger("removeChild",child)}}},Transform3D.prototype.localToWorld=function(v){return v.applyMat4(this.matrixWorld)},Transform3D.prototype.worldToLocal=function(){var mat=new Mat4;return function(v){return v.applyMat4(mat.getInverse(this.matrixWorld))}}(),Transform3D.prototype.applyMat4=function(){var mat=new Mat4;return function(matrix){this.matrix.mmul(matrix,this.matrix),this.scale.getScaleMat4(this.matrix),mat.identity().extractRotation(this.matrix),this.rotation.getRotationMat4(mat),this.position.getPositionMat4(this.matrix)}}(),Transform3D.prototype.translate=function(){var vec=new Vec3,quat=new Quat;return function(translation,relativeTo){vec.copy(translation),relativeTo instanceof Transform3D?vec.applyQuat(relativeTo.rotation):relativeTo instanceof Quat&&vec.applyQuat(relativeTo),this.position.add(vec)}}(),Transform3D.prototype.rotate=function(){var vec=new Vec3,quat=new Quat;return function(rotation,relativeTo){vec.copy(rotation),relativeTo instanceof Transform3D?vec.applyQuat(relativeTo.rotation):relativeTo instanceof Quat&&vec.applyQuat(relativeTo),this.rotation.rotate(vec.x,vec.y,vec.z)}}(),Transform3D.prototype.rotateAround=function(){var point=new Vec3,quat=new Quat;return function(point,axis,angle){point.copy(point).sub(this.position),quat.axisAngle(axis,angle),this.translate(point),this.rotation.mul(quat),this.translate(point.inverse(),quat)}}(),Transform3D.prototype.lookAt=function(){var vec=new Vec3,mat=new Mat4,quat=new Quat;return function(target,up){up=up instanceof Vec3?up:undefined,target instanceof Transform3D?vec.copy(target.position):target instanceof Vec3&&vec.copy(target),mat.lookAt(this.position,vec,up),this.rotation.getRotationMat4(mat)}}(),Transform3D.prototype.follow=function(){var vec=new Vec3;return function(target,damping,relativeTo){damping=damping>0?damping:1,target instanceof Transform3D?vec.sub(target.position,this.position):target instanceof Vec3&&vec.sub(target,this.position),vec.lenSq()>.1&&this.translate(vec.smul(1/damping),relativeTo)}}(),Transform3D.prototype.updateMatrices=function(){var scale=this.scale,world=this.world,matrix=this.matrix,matrixWorld=this.matrixWorld;matrix.setRotationQuat(this.rotation),(scale.x!==1||scale.y!==1||scale.z!==1)&&matrix.scale(scale),matrix.setPositionVec3(this.position),this.root===this?matrixWorld.copy(matrix):matrixWorld.mmul(this.parent.matrixWorld,matrix),world.position.getPositionMat4(matrixWorld),world.rotation.getRotationMat4(matrixWorld),world.scale.getScaleMat4(matrixWorld),this.needsUpdate=!0},Transform3D}),define("core/canvas",["base/class","base/utils","base/device"],function(Class,Utils,Device){var addMeta=Utils.addMeta,addEvent=Utils.addEvent;function Canvas(width,height){Class.call(this),this.viewportId="viewport"+this._id,addMeta(this.viewportId,"viewport","initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"),addMeta(this.viewportId+"-width","viewport","width=device-width"),addMeta(this.viewportId+"-height","viewport","height=device-height"),addMeta(undefined,"apple-mobile-web-app-status-bar-style","black"),addMeta(undefined,"apple-mobile-web-app-capable","yes");var element=document.createElement("canvas");this.element=element,!width&&!height?(this.fullScreen=!0,this.width=window.innerWidth,this.height=window.innerHeight):(this.width=width!==undefined?width:960,this.height=height!==undefined?height:640),element.style.position="absolute",element.style.left="50%",element.style.top="50%",element.style.padding="0px",element.style.margin="0px",element.marginLeft=-this.width*.5+"px",element.marginTop=-this.height*.5+"px",element.style.width=Math.floor(this.width)+"px",element.style.height=Math.floor(this.height)+"px",element.width=this.width,element.height=this.height,this.aspect=this.width/this.height,element.oncontextmenu=function(){return!1},document.body.appendChild(element),this.handleResize(),addEvent(window,"resize orientationchange",this.handleResize,this)}return Canvas.prototype=Object.create(Class.prototype),Canvas.prototype.constructor=Canvas,Canvas.prototype.set=function(width,height){if(!width||!height){console.warn("Canvas.set: no width and or height specified using default width and height");return}width=width,height=height,this.width=width,this.height=height,this.aspect=this.width/this.height,this.handleResize()},Canvas.prototype.handleResize=function(){var element=this.element,elementStyle=element.style,w=window.innerWidth,h=window.innerHeight,pixelRatio=Device.pixelRatio,aspect=w/h,width,height,id="#"+this.viewportId,viewportScale=document.querySelector(id).getAttribute("content");this.fullScreen?(width=w,height=h,this.width=element.width=width,this.height=element.height=height,this.aspect=width/height):aspect>=this.aspect?(width=h*this.aspect,height=h):(width=w,height=w/this.aspect),elementStyle.width=Math.floor(width)+"px",elementStyle.height=Math.floor(height)+"px",elementStyle.marginLeft=-width*.5+"px",elementStyle.marginTop=-height*.5+"px",document.querySelector(id).setAttribute("content",viewportScale.replace(/-scale\s*=\s*[.0-9]+/g,"-scale="+pixelRatio)),document.querySelector(id+"-width").setAttribute("content","width="+w),document.querySelector(id+"-height").setAttribute("content","height="+h),window.scrollTo(0,0),this.trigger("resize")},Canvas});if(typeof define!="function")var define=require("amdefine")(module);define("core/gameobject",["core/objects/transform3d"],function(Transform3D){function GameObject(opts){opts||(opts={}),Transform3D.call(this,opts),this.name=opts.name||this._class+"-"+this._id,this.z=0,this.tags=[],this.components={},this.scene=undefined,this.add.apply(this,opts.children),this.addTag.apply(this,opts.tags),this.addComponent.apply(this,opts.components)}return GameObject.prototype=Object.create(Transform3D.prototype),GameObject.prototype.constructor=GameObject,GameObject.prototype.clone=function(){var clone=new GameObject;return clone.copy(this),clone},GameObject.prototype.copy=function(other){var name,component,prop;Transform3D.call(this,other),this.name=this._class+this._id,this.tags.length=0,this.addTag.apply(this,other.tags);for(name in other.components)component=other.components[name],this.addComponent(component.clone());for(name in other.props)prop=other.props[name],this.props[name]=prop;return other.scene&&other.scene.add(this),this},GameObject.prototype.init=function(){var components=this.components,type,component;for(type in components)component=components[type],component&&(component.init(),component.trigger("init"));this.trigger("init")},GameObject.prototype.addTag=function(){var tags=this.tags,tag,index,i,il;for(i=0,il=arguments.length;i<il;i++)tag=arguments[i],index=tags.indexOf(tag),index===-1&&tags.push(tag)},GameObject.prototype.removeTag=function(){var tags=this.tags,tag,index,i,il;for(i=0,il=arguments.length;i<il;i++)tag=arguments[a],index=tags.indexOf(tag),index!==-1&&tags.splice(index,1)},GameObject.prototype.hasTag=function(tag){return this.tags.indexOf(tag)!==-1},GameObject.prototype.addComponent=function(){var components=this.components,component,i,il;for(i=0,il=arguments.length;i<il;i++)component=arguments[i],components[component._class]?console.warn("GameObject.addComponent: GameObject already has a "+component+" Component"):component instanceof Component?(component.gameObject&&(component=component.clone()),components[component._class]=component,component.gameObject=this,this.trigger("addComponent",component),component.trigger("add",this)):console.warn("GameObject.addComponent: "+component._class+" is not an instance of Component")},GameObject.prototype.removeComponent=function(){var components=this.components,component,i,il;for(i=0,il=arguments.length;i<il;i++)component=arguments[i],components[component._class]?(component.gameObject=undefined,delete components[component._class],this.trigger("removeComponent",component),component.trigger("remove",this)):console.warn("GameObject.removeComponent: Component is not attached GameObject")},GameObject.prototype.hasComponent=function(type){return!!this.components[type]},GameObject.prototype.getComponent=function(type){return this.components[type]},GameObject.prototype.getComponents=function(results){results=results||[];var key;for(key in this.components)results.push(this.components[key]);return results},GameObject.prototype.forEachComponent=function(callback){var components=this.components,type,component;for(type in components)component=components[type],component&&callback(component)},GameObject.prototype.update=function(){var components=this.components,type,component;this.trigger("update");for(type in components)component=components[type],component&&component.update&&component.update();this.updateMatrices(),this.trigger("lateUpdate")},GameObject});if(typeof define!="function")var define=require("amdefine")(module);define("core/scene",["base/class","base/utils"],function(Class,Utils){function Scene(opts){opts||(opts={}),Class.call(this),this.children=[],this.add.apply(this,opts.children)}return Scene.prototype=Object.create(Class.prototype),Scene.prototype.constructor=Scene,Scene.prototype.forEach=function(callback){var children=this.children,i,il;for(i=0,il=children.length;i<il;i++)callback(children[i])},Scene.prototype.add=function(){var children=this.children,child,index,i,il;for(i=0,il=arguments.length;i<il;i++)child=arguments[i],index=children.indexOf(child),index===-1?child instanceof GameObject?(child.scene=this,children.push(child),child.children.length>0&&this.add.apply(this,child.children),child.trigger("addToScene"),this.trigger("addGameObject",child),child.init()):console.warn("Scene.add: Object is not an instance of GameObject"):console.warn("Scene.add: "+child.name+" is already added to scene")},Scene.prototype.remove=function(){var children=this.children,child,index,i,il;for(i=0,il=arguments.length;i<il;i++)child=arguments[i],index=children.indexOf(child),index!==-1?(child.scene=undefined,children.splice(index,1),child.children.length>0&&this.remove.apply(this,child.children),child.trigger("removeFromScene"),this.trigger("removeGameObject",child)):console.warn("Scene.remove: "+child+" is not within this scene")},Scene.prototype.findByTag=function(tag,results){results=results||[];var children=this.children,child,i,il;for(i=0,il=children.length;i<il;i++)child=children[i],child.hasTag(tag)&&results.push(child);return results},Scene.prototype.findByName=function(name){var children=this.children,child,i,il;for(i=0,il=children.length;i<il;i++){child=children[i];if(child.name===name)return child}return undefined},Scene.prototype.update=function(){var children=this.children,i,il;this.trigger("update");for(i=0,il=children.length;i<il;i++)children[i].update();this.trigger("update")},Scene});if(typeof define!="function")var define=require("amdefine")(module);define("ares",["require","math/bound2","math/bound3","math/color","math/mat3","math/mat4","math/mathf","math/quat","math/vec2","math/vec3","math/vec4","base/class","base/device","base/time","base/utils","core/components/component","core/objects/transform2d","core/objects/transform3d","core/canvas","core/gameobject","core/scene"],function(require){var Ares={};return Ares.globalize=function(){for(var key in this)window[key]=this[key];window.Ares=this},Ares.speedTest=function(){var now=Date.now,start,i;return function(name,times,fn){start=now();for(i=0;i<times;i++)fn();console.log(name+": "+(now()-start)+"ms")}}(),Ares.Bound2=require("math/bound2"),Ares.Bound3=require("math/bound3"),Ares.Color=require("math/color"),Ares.Mat3=require("math/mat3"),Ares.Mat4=require("math/mat4"),Ares.Mathf=require("math/mathf"),Ares.Quat=require("math/quat"),Ares.Vec2=require("math/vec2"),Ares.Vec3=require("math/vec3"),Ares.Vec4=require("math/vec4"),Ares.Class=require("base/class"),Ares.Device=require("base/device"),Ares.Time=require("base/time"),Ares.Utils=require("base/utils"),Ares.Component=require("core/components/component"),Ares.Transform2D=require("core/objects/transform2d"),Ares.Transform3D=require("core/objects/transform3d"),Ares.Canvas=require("core/canvas"),Ares.GameObject=require("core/gameobject"),Ares.Scene=require("core/scene"),Ares});